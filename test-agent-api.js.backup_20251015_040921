/**
 * Agentå·¥ä½œæµAPIæµ‹è¯•è„šæœ¬
 * æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµåˆ›å»ºã€æ‰§è¡Œæµç¨‹
 */

const axios = require('axios');

const BASE_URL = 'http://localhost:4000/api';
let authToken = '';
let workflowId = null;

// æµ‹è¯•ç”¨çš„å·¥ä½œæµå®šä¹‰
const testWorkflow = {
  name: 'æµ‹è¯•å·¥ä½œæµ - AIå¯¹è¯',
  description: 'ä¸€ä¸ªç®€å•çš„AIå¯¹è¯å·¥ä½œæµï¼Œç”¨äºæµ‹è¯•æ‰§è¡Œå¼•æ“',
  flow_data: {
    nodes: [
      {
        id: 'start-1',
        type: 'start',
        position: { x: 100, y: 100 },
        data: {}
      },
      {
        id: 'llm-1',
        type: 'llm',
        position: { x: 300, y: 100 },
        data: {
          model_id: 1, // å‡è®¾å­˜åœ¨IDä¸º1çš„æ¨¡å‹
          system_prompt: 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹',
          user_prompt: 'è¯·ç”¨ä¸€å¥è¯ä»‹ç»ä½ è‡ªå·±',
          temperature: 0.7,
          max_tokens: 100
        }
      },
      {
        id: 'end-1',
        type: 'end',
        position: { x: 500, y: 100 },
        data: {
          output_format: 'text'
        }
      }
    ],
    edges: [
      { id: 'e1', source: 'start-1', target: 'llm-1' },
      { id: 'e2', source: 'llm-1', target: 'end-1' }
    ]
  },
  is_published: true
};

// è¾…åŠ©å‡½æ•°ï¼šå»¶è¿Ÿ
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// è¾…åŠ©å‡½æ•°ï¼šæ‰“å°åˆ†éš”çº¿
const printSeparator = (title) => {
  console.log('\n' + '='.repeat(60));
  console.log(`  ${title}`);
  console.log('='.repeat(60));
};

// 1. ç™»å½•è·å–Token
async function login() {
  printSeparator('æ­¥éª¤1: ç”¨æˆ·ç™»å½•');
  
  try {
    const response = await axios.post(`${BASE_URL}/auth/login`, {
      username: 'admin',
      password: '123456'
    });

    if (response.data.success) {
      authToken = response.data.data.access_token;
      console.log('âœ… ç™»å½•æˆåŠŸ');
      console.log(`Token: ${authToken.substring(0, 20)}...`);
      return true;
    }
  } catch (error) {
    console.error('âŒ ç™»å½•å¤±è´¥:', error.response?.data || error.message);
    return false;
  }
}

// 2. è·å–èŠ‚ç‚¹ç±»å‹åˆ—è¡¨
async function getNodeTypes() {
  printSeparator('æ­¥éª¤2: è·å–èŠ‚ç‚¹ç±»å‹');
  
  try {
    const response = await axios.get(`${BASE_URL}/agent/node-types`, {
      headers: { Authorization: `Bearer ${authToken}` }
    });

    if (response.data.success) {
      console.log('âœ… è·å–èŠ‚ç‚¹ç±»å‹æˆåŠŸ');
      console.log(`å¯ç”¨èŠ‚ç‚¹æ•°: ${response.data.data.length}`);
      response.data.data.forEach(node => {
        console.log(`  - ${node.name} (${node.type_key}) - ${node.credits_per_execution}ç§¯åˆ†/æ¬¡`);
      });
      return true;
    }
  } catch (error) {
    console.error('âŒ è·å–èŠ‚ç‚¹ç±»å‹å¤±è´¥:', error.response?.data || error.message);
    return false;
  }
}

// 3. æ£€æŸ¥AIæ¨¡å‹
async function checkModels() {
  printSeparator('æ­¥éª¤3: æ£€æŸ¥AIæ¨¡å‹');
  
  try {
    const response = await axios.get(`${BASE_URL}/chat/models`, {
      headers: { Authorization: `Bearer ${authToken}` }
    });

    if (response.data.success && response.data.data.length > 0) {
      const firstModel = response.data.data[0];
      console.log('âœ… æ‰¾åˆ°å¯ç”¨çš„AIæ¨¡å‹');
      console.log(`ç¬¬ä¸€ä¸ªæ¨¡å‹: ${firstModel.display_name} (ID: ${firstModel.id})`);
      
      // æ›´æ–°å·¥ä½œæµä¸­çš„model_id
      testWorkflow.flow_data.nodes[1].data.model_id = firstModel.id;
      return true;
    } else {
      console.log('âš ï¸  æ²¡æœ‰å¯ç”¨çš„AIæ¨¡å‹ï¼Œè¯·å…ˆåœ¨ç®¡ç†åå°æ·»åŠ ');
      return false;
    }
  } catch (error) {
    console.error('âŒ æ£€æŸ¥æ¨¡å‹å¤±è´¥:', error.response?.data || error.message);
    return false;
  }
}

// 4. åˆ›å»ºå·¥ä½œæµ
async function createWorkflow() {
  printSeparator('æ­¥éª¤4: åˆ›å»ºå·¥ä½œæµ');
  
  try {
    const response = await axios.post(
      `${BASE_URL}/agent/workflows`,
      testWorkflow,
      { headers: { Authorization: `Bearer ${authToken}` } }
    );

    if (response.data.success) {
      workflowId = response.data.data.id;
      console.log('âœ… å·¥ä½œæµåˆ›å»ºæˆåŠŸ');
      console.log(`å·¥ä½œæµID: ${workflowId}`);
      console.log(`åç§°: ${testWorkflow.name}`);
      console.log(`èŠ‚ç‚¹æ•°: ${testWorkflow.flow_data.nodes.length}`);
      console.log(`å·²å‘å¸ƒ: ${testWorkflow.is_published}`);
      return true;
    }
  } catch (error) {
    console.error('âŒ åˆ›å»ºå·¥ä½œæµå¤±è´¥:', error.response?.data || error.message);
    return false;
  }
}

// 5. è·å–å·¥ä½œæµè¯¦æƒ…
async function getWorkflowDetail() {
  printSeparator('æ­¥éª¤5: è·å–å·¥ä½œæµè¯¦æƒ…');
  
  try {
    const response = await axios.get(
      `${BASE_URL}/agent/workflows/${workflowId}`,
      { headers: { Authorization: `Bearer ${authToken}` } }
    );

    if (response.data.success) {
      console.log('âœ… è·å–å·¥ä½œæµè¯¦æƒ…æˆåŠŸ');
      const workflow = response.data.data;
      console.log(`ID: ${workflow.id}`);
      console.log(`åç§°: ${workflow.name}`);
      console.log(`ç‰ˆæœ¬: ${workflow.version}`);
      console.log(`çŠ¶æ€: ${workflow.is_published ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}`);
      return true;
    }
  } catch (error) {
    console.error('âŒ è·å–è¯¦æƒ…å¤±è´¥:', error.response?.data || error.message);
    return false;
  }
}

// 6. æ‰§è¡Œå·¥ä½œæµ
async function executeWorkflow() {
  printSeparator('æ­¥éª¤6: æ‰§è¡Œå·¥ä½œæµ');
  
  try {
    console.log('ğŸ“¤ å‘é€æ‰§è¡Œè¯·æ±‚...');
    
    const response = await axios.post(
      `${BASE_URL}/agent/workflows/${workflowId}/execute`,
      { input_data: { message: 'ä½ å¥½' } },
      { 
        headers: { Authorization: `Bearer ${authToken}` },
        timeout: 120000 // 2åˆ†é’Ÿè¶…æ—¶
      }
    );

    if (response.data.success) {
      console.log('âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼');
      const result = response.data.data;
      
      console.log('\nğŸ“Š æ‰§è¡Œç»“æœï¼š');
      console.log(`æ‰§è¡ŒID: ${result.executionId}`);
      console.log(`æ‰§è¡Œæ—¶é•¿: ${result.duration}ms`);
      
      console.log('\nğŸ’° ç§¯åˆ†æ¶ˆè€—ï¼š');
      console.log(`é¢„ä¼°: ${result.credits.estimated}`);
      console.log(`å®é™…ä½¿ç”¨: ${result.credits.used}`);
      console.log(`é€€æ¬¾: ${result.credits.refunded}`);
      
      console.log('\nğŸ“„ è¾“å‡ºå†…å®¹ï¼š');
      console.log(JSON.stringify(result.output, null, 2));
      
      return result.executionId;
    }
  } catch (error) {
    console.error('âŒ æ‰§è¡Œå¤±è´¥:', error.response?.data || error.message);
    if (error.response?.status === 402) {
      console.log('ğŸ’¡ æç¤º: ç§¯åˆ†ä¸è¶³ï¼Œè¯·å…ˆå……å€¼');
    }
    return null;
  }
}

// 7. è·å–æ‰§è¡Œå†å²
async function getExecutionHistory() {
  printSeparator('æ­¥éª¤7: è·å–æ‰§è¡Œå†å²');
  
  try {
    const response = await axios.get(
      `${BASE_URL}/agent/executions`,
      { headers: { Authorization: `Bearer ${authToken}` } }
    );

    if (response.data.success) {
      console.log('âœ… è·å–æ‰§è¡Œå†å²æˆåŠŸ');
      const executions = response.data.data.executions;
      console.log(`æ€»æ‰§è¡Œæ¬¡æ•°: ${response.data.data.pagination.total}`);
      
      if (executions.length > 0) {
        console.log('\næœ€è¿‘çš„æ‰§è¡Œè®°å½•:');
        executions.slice(0, 3).forEach((exec, index) => {
          console.log(`\n${index + 1}. æ‰§è¡ŒID: ${exec.id}`);
          console.log(`   å·¥ä½œæµ: ${exec.workflow_name}`);
          console.log(`   çŠ¶æ€: ${exec.status}`);
          console.log(`   ç§¯åˆ†: ${exec.total_credits_used}`);
          console.log(`   æ—¶é—´: ${exec.created_at}`);
        });
      }
      return true;
    }
  } catch (error) {
    console.error('âŒ è·å–å†å²å¤±è´¥:', error.response?.data || error.message);
    return false;
  }
}

// 8. è·å–ç»Ÿè®¡ä¿¡æ¯
async function getStats() {
  printSeparator('æ­¥éª¤8: è·å–ç»Ÿè®¡ä¿¡æ¯');
  
  try {
    const response = await axios.get(
      `${BASE_URL}/agent/stats`,
      { headers: { Authorization: `Bearer ${authToken}` } }
    );

    if (response.data.success) {
      console.log('âœ… è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ');
      const stats = response.data.data;
      
      console.log('\nğŸ“ˆ å·¥ä½œæµç»Ÿè®¡:');
      console.log(`  æ€»æ•°: ${stats.workflows.total}`);
      console.log(`  å·²å‘å¸ƒ: ${stats.workflows.published}`);
      console.log(`  è‰ç¨¿: ${stats.workflows.draft}`);
      
      console.log('\nâš¡ æ‰§è¡Œç»Ÿè®¡:');
      console.log(`  æ€»æ‰§è¡Œæ¬¡æ•°: ${stats.executions.total}`);
      console.log(`  æˆåŠŸ: ${stats.executions.completed}`);
      console.log(`  å¤±è´¥: ${stats.executions.failed}`);
      console.log(`  è¿è¡Œä¸­: ${stats.executions.running}`);
      console.log(`  æ€»ç§¯åˆ†æ¶ˆè€—: ${stats.executions.total_credits_used}`);
      
      return true;
    }
  } catch (error) {
    console.error('âŒ è·å–ç»Ÿè®¡å¤±è´¥:', error.response?.data || error.message);
    return false;
  }
}

// ä¸»æµ‹è¯•æµç¨‹
async function runTests() {
  console.log('\nğŸš€ å¼€å§‹æµ‹è¯• Agent å·¥ä½œæµ API');
  console.log(`æµ‹è¯•åœ°å€: ${BASE_URL}`);
  console.log(`æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}`);
  
  try {
    // 1. ç™»å½•
    if (!await login()) {
      console.log('\nâŒ æµ‹è¯•ç»ˆæ­¢ï¼šç™»å½•å¤±è´¥');
      return;
    }
    
    await sleep(500);
    
    // 2. è·å–èŠ‚ç‚¹ç±»å‹
    if (!await getNodeTypes()) {
      console.log('\nâš ï¸  è­¦å‘Šï¼šèŠ‚ç‚¹ç±»å‹è·å–å¤±è´¥ï¼Œä½†ç»§ç»­æµ‹è¯•');
    }
    
    await sleep(500);
    
    // 3. æ£€æŸ¥æ¨¡å‹
    if (!await checkModels()) {
      console.log('\nâš ï¸  è­¦å‘Šï¼šæ²¡æœ‰å¯ç”¨æ¨¡å‹ï¼Œè·³è¿‡æ‰§è¡Œæµ‹è¯•');
      return;
    }
    
    await sleep(500);
    
    // 4. åˆ›å»ºå·¥ä½œæµ
    if (!await createWorkflow()) {
      console.log('\nâŒ æµ‹è¯•ç»ˆæ­¢ï¼šå·¥ä½œæµåˆ›å»ºå¤±è´¥');
      return;
    }
    
    await sleep(500);
    
    // 5. è·å–è¯¦æƒ…
    await getWorkflowDetail();
    
    await sleep(500);
    
    // 6. æ‰§è¡Œå·¥ä½œæµï¼ˆå¯èƒ½å¤±è´¥ï¼Œå› ä¸ºéœ€è¦ç§¯åˆ†å’ŒAPIé…ç½®ï¼‰
    console.log('\nâš ï¸  å³å°†æ‰§è¡Œå·¥ä½œæµï¼Œè¿™å°†æ¶ˆè€—ç§¯åˆ†...');
    await sleep(1000);
    await executeWorkflow();
    
    await sleep(1000);
    
    // 7. è·å–æ‰§è¡Œå†å²
    await getExecutionHistory();
    
    await sleep(500);
    
    // 8. è·å–ç»Ÿè®¡
    await getStats();
    
    // æµ‹è¯•æ€»ç»“
    printSeparator('æµ‹è¯•å®Œæˆ');
    console.log('âœ… Agentå·¥ä½œæµç³»ç»Ÿæµ‹è¯•å®Œæˆï¼');
    console.log('\nğŸ“Œ åç»­æ­¥éª¤:');
    console.log('1. ç¡®ä¿AIæ¨¡å‹é…ç½®æ­£ç¡®ï¼ˆAPI Keyæœ‰æ•ˆï¼‰');
    console.log('2. ç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿç§¯åˆ†');
    console.log('3. å¼€å§‹å‰ç«¯ç•Œé¢å¼€å‘');
    console.log(`4. è®¿é—®å·¥ä½œæµç¼–è¾‘é¡µé¢æµ‹è¯•å®Œæ•´æµç¨‹\n`);
    
  } catch (error) {
    console.error('\nâŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™:', error.message);
  }
}

// è¿è¡Œæµ‹è¯•
runTests().catch(console.error);
