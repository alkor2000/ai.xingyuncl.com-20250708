/**
 * çŸ¥è¯†æ¨¡å—æ¨¡å‹
 * ä¿®å¤ï¼šç»Ÿä¸€group_idsçš„æ•°æ®ç±»å‹å¤„ç†ï¼Œç¡®ä¿ç±»å‹å®‰å…¨çš„æƒé™æ£€æŸ¥
 */

const dbConnection = require('../database/connection');
const { DatabaseError, ValidationError } = require('../utils/errors');
const logger = require('../utils/logger');
const { calculateTokens } = require('../utils/tokenCalculator');

class KnowledgeModule {
  constructor(data = {}) {
    this.id = data.id || null;
    this.name = data.name || '';
    this.description = data.description || '';
    this.content = data.content || '';
    this.token_count = data.token_count || 0;
    this.prompt_type = data.prompt_type || 'normal';
    this.module_scope = data.module_scope || 'personal';
    this.content_visible = data.content_visible !== undefined ? data.content_visible : true;
    this.creator_id = data.creator_id || null;
    this.group_id = data.group_id || null;
    this.group_ids = data.group_ids || null;
    this.category = data.category || null;
    this.tags = data.tags || null;
    this.sort_order = data.sort_order || 0;
    this.is_active = data.is_active !== undefined ? data.is_active : true;
    this.usage_count = data.usage_count || 0;
    this.created_at = data.created_at || null;
    this.updated_at = data.updated_at || null;
    // æ–°å¢ï¼šå…è®¸è®¿é—®çš„æ ‡ç­¾IDåˆ—è¡¨
    this.allowed_tag_ids = data.allowed_tag_ids || [];
  }

  /**
   * ğŸ”§ è¾…åŠ©æ–¹æ³•ï¼šç»Ÿä¸€group_idsä¸ºæ•´æ•°æ•°ç»„
   * ç¡®ä¿æ‰€æœ‰IDéƒ½æ˜¯æ•°å­—ç±»å‹ï¼Œé¿å…ç±»å‹åŒ¹é…é—®é¢˜
   */
  static normalizeGroupIds(groupIds) {
    if (!groupIds) return null;
    
    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
    if (typeof groupIds === 'string') {
      try {
        groupIds = JSON.parse(groupIds);
      } catch (e) {
        logger.warn('è§£ægroup_idså¤±è´¥', { groupIds });
        return null;
      }
    }
    
    // å¦‚æœæ˜¯æ•°ç»„ï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°
    if (Array.isArray(groupIds)) {
      const normalized = groupIds
        .map(id => parseInt(id, 10))
        .filter(id => !isNaN(id) && id > 0);
      
      return normalized.length > 0 ? normalized : null;
    }
    
    return null;
  }

  /**
   * è·å–ç”¨æˆ·å¯ç”¨çš„çŸ¥è¯†æ¨¡å—åˆ—è¡¨ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
   * ä¿®å¤ï¼šæ­£ç¡®å¤„ç†ç³»ç»Ÿçº§æ¨¡å—çš„æƒé™å’Œå¯è§æ€§
   * ä¼˜åŒ–ï¼šå‡å°‘N+1æŸ¥è¯¢é—®é¢˜
   */
  static async getUserAvailableModules(userId, groupId, includeInactive = false, userRole = null) {
    try {
      // å¦‚æœæ²¡æœ‰ä¼ å…¥ç”¨æˆ·è§’è‰²ï¼ŒæŸ¥è¯¢ç”¨æˆ·è§’è‰²
      if (!userRole) {
        const userResult = await dbConnection.query('SELECT role FROM users WHERE id = ?', [userId]);
        userRole = userResult.rows[0]?.role;
      }
      
      // è¶…çº§ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ¨¡å—
      if (userRole === 'super_admin') {
        let sql = `
          SELECT km.*, u.username as creator_name, ug.name as group_name,
                 GROUP_CONCAT(DISTINCT kmtp.tag_id) as allowed_tag_ids_str
          FROM knowledge_modules km
          LEFT JOIN users u ON km.creator_id = u.id
          LEFT JOIN user_groups ug ON km.group_id = ug.id
          LEFT JOIN knowledge_module_tag_permissions kmtp ON km.id = kmtp.module_id
        `;
        
        if (!includeInactive) {
          sql += ' WHERE km.is_active = 1';
        }
        
        sql += ' GROUP BY km.id ORDER BY km.module_scope DESC, km.sort_order ASC, km.created_at DESC';
        
        const { rows } = await dbConnection.query(sql);
        
        const modules = rows.map(row => {
          const module = new KnowledgeModule(row);
          module.creator_name = row.creator_name;
          module.group_name = row.group_name;
          
          // è§£ægroup_ids - ä½¿ç”¨ç»Ÿä¸€çš„è§„èŒƒåŒ–æ–¹æ³•
          module.group_ids = KnowledgeModule.normalizeGroupIds(row.group_ids);
          
          // è§£æallowed_tag_ids
          if (row.allowed_tag_ids_str) {
            module.allowed_tag_ids = row.allowed_tag_ids_str.split(',').map(id => parseInt(id));
          } else {
            module.allowed_tag_ids = [];
          }
          
          return module;
        });
        
        logger.debug('è¶…çº§ç®¡ç†å‘˜è·å–æ‰€æœ‰æ¨¡å—', {
          userId,
          moduleCount: modules.length,
          includeInactive
        });
        
        return modules;
      }
      
      // æ™®é€šç”¨æˆ·å’Œç»„ç®¡ç†å‘˜çš„æƒé™æ£€æŸ¥
      // è·å–ç”¨æˆ·çš„æ ‡ç­¾IDåˆ—è¡¨
      const userTagsSql = `
        SELECT tag_id FROM user_tag_relations WHERE user_id = ?
      `;
      const { rows: userTagRows } = await dbConnection.query(userTagsSql, [userId]);
      const userTagIds = userTagRows.map(row => row.tag_id);
      
      // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿groupIdæ˜¯æ•´æ•°
      const normalizedGroupId = parseInt(groupId, 10);
      
      // ä¼˜åŒ–æŸ¥è¯¢ï¼šä½¿ç”¨LEFT JOINä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®
      let sql = `
        SELECT DISTINCT km.*, u.username as creator_name, ug.name as group_name,
               GROUP_CONCAT(DISTINCT kmtp.tag_id) as allowed_tag_ids_str
        FROM knowledge_modules km
        LEFT JOIN users u ON km.creator_id = u.id
        LEFT JOIN user_groups ug ON km.group_id = ug.id
        LEFT JOIN knowledge_module_tag_permissions kmtp ON km.id = kmtp.module_id
        WHERE (
          -- ä¸ªäººæ¨¡å—ï¼šåªèƒ½çœ‹åˆ°è‡ªå·±çš„
          (km.module_scope = 'personal' AND km.creator_id = ?)
          -- å›¢é˜Ÿæ¨¡å—ï¼šåŒç»„å¯è§ï¼Œéœ€è¦æ£€æŸ¥æ ‡ç­¾æƒé™
          OR (km.module_scope = 'team' AND km.group_id = ? AND (
            -- åˆ›å»ºè€…å§‹ç»ˆå¯è§
            km.creator_id = ?
            -- æ²¡æœ‰æ ‡ç­¾é™åˆ¶çš„æ¨¡å—å¯¹æ‰€æœ‰ç»„å†…ç”¨æˆ·å¯è§
            OR NOT EXISTS (
              SELECT 1 FROM knowledge_module_tag_permissions 
              WHERE module_id = km.id
            )
            ${userTagIds.length > 0 ? `
            -- æœ‰æ ‡ç­¾é™åˆ¶çš„æ¨¡å—ï¼Œç”¨æˆ·å¿…é¡»æ‹¥æœ‰è‡³å°‘ä¸€ä¸ªå…è®¸çš„æ ‡ç­¾
            OR EXISTS (
              SELECT 1 FROM knowledge_module_tag_permissions kmtp2
              WHERE kmtp2.module_id = km.id 
              AND kmtp2.tag_id IN (${userTagIds.map(() => '?').join(',')})
            )` : ''}
          ))
          -- ğŸ”§ ä¿®å¤ï¼šå…¨å±€æ¨¡å—çš„æƒé™æ£€æŸ¥ï¼Œä½¿ç”¨JSON_SEARCHç¡®ä¿ç±»å‹å®‰å…¨
          OR (km.module_scope = 'system' AND (
            km.group_ids IS NULL  -- NULLè¡¨ç¤ºæ‰€æœ‰ç»„å¯è§
            OR JSON_LENGTH(km.group_ids) = 0  -- ç©ºæ•°ç»„ä¹Ÿè¡¨ç¤ºæ‰€æœ‰ç»„å¯è§
            OR JSON_SEARCH(km.group_ids, 'one', ?, NULL, '$[*]') IS NOT NULL  -- æ£€æŸ¥ç”¨æˆ·ç»„IDæ˜¯å¦åœ¨æ•°ç»„ä¸­
          ))
        )
      `;
      
      const params = [userId, normalizedGroupId, userId];
      if (userTagIds.length > 0) {
        params.push(...userTagIds);
      }
      params.push(normalizedGroupId.toString()); // JSON_SEARCHéœ€è¦å­—ç¬¦ä¸²æ¯”è¾ƒ
      
      if (!includeInactive) {
        sql += ' AND km.is_active = 1';
      }
      
      sql += ' GROUP BY km.id ORDER BY km.module_scope DESC, km.sort_order ASC, km.created_at DESC';
      
      const { rows } = await dbConnection.query(sql, params);
      
      const modules = rows.map(row => {
        const module = new KnowledgeModule(row);
        module.creator_name = row.creator_name;
        module.group_name = row.group_name;
        
        // è§£ægroup_ids - ä½¿ç”¨ç»Ÿä¸€çš„è§„èŒƒåŒ–æ–¹æ³•
        module.group_ids = KnowledgeModule.normalizeGroupIds(row.group_ids);
        
        // è§£æallowed_tag_ids
        if (row.allowed_tag_ids_str) {
          module.allowed_tag_ids = row.allowed_tag_ids_str.split(',').map(id => parseInt(id));
        } else {
          module.allowed_tag_ids = [];
        }
        
        // å¤„ç†å†…å®¹å¯è§æ€§
        if (module.module_scope === 'system') {
          if (!module.content_visible) {
            module.content = null;
            module.content_hidden = true;
          }
        } else if (module.module_scope === 'team') {
          if (module.creator_id !== userId && !module.content_visible) {
            module.content = null;
            module.content_hidden = true;
          }
        }
        
        return module;
      });
      
      logger.debug('è·å–ç”¨æˆ·å¯ç”¨æ¨¡å—', {
        userId,
        userGroupId: normalizedGroupId,
        userRole,
        moduleCount: modules.length
      });
      
      return modules;
    } catch (error) {
      logger.error('è·å–ç”¨æˆ·å¯ç”¨çŸ¥è¯†æ¨¡å—å¤±è´¥:', error);
      throw new DatabaseError('è·å–çŸ¥è¯†æ¨¡å—åˆ—è¡¨å¤±è´¥', error);
    }
  }

  /**
   * è·å–æ¨¡å—çš„æ ‡ç­¾æƒé™åˆ—è¡¨
   */
  static async getModuleTagPermissions(moduleId) {
    try {
      const sql = 'SELECT tag_id FROM knowledge_module_tag_permissions WHERE module_id = ?';
      const { rows } = await dbConnection.query(sql, [moduleId]);
      return rows.map(row => row.tag_id);
    } catch (error) {
      logger.error('è·å–æ¨¡å—æ ‡ç­¾æƒé™å¤±è´¥:', error);
      return [];
    }
  }

  /**
   * è®¾ç½®æ¨¡å—çš„æ ‡ç­¾æƒé™
   */
  static async setModuleTagPermissions(moduleId, tagIds, operatorId) {
    const transaction = await dbConnection.beginTransaction();
    try {
      // åˆ é™¤æ—§çš„æƒé™
      await transaction.query('DELETE FROM knowledge_module_tag_permissions WHERE module_id = ?', [moduleId]);
      
      // æ·»åŠ æ–°çš„æƒé™
      if (tagIds && tagIds.length > 0) {
        for (const tagId of tagIds) {
          await transaction.query(
            'INSERT INTO knowledge_module_tag_permissions (module_id, tag_id, created_by) VALUES (?, ?, ?)',
            [moduleId, tagId, operatorId]
          );
        }
      }
      
      await transaction.commit();
      
      logger.info('è®¾ç½®æ¨¡å—æ ‡ç­¾æƒé™æˆåŠŸ', {
        moduleId,
        tagIds,
        operatorId
      });
    } catch (error) {
      await transaction.rollback();
      logger.error('è®¾ç½®æ¨¡å—æ ‡ç­¾æƒé™å¤±è´¥:', error);
      throw new DatabaseError('è®¾ç½®æ¨¡å—æ ‡ç­¾æƒé™å¤±è´¥', error);
    }
  }

  /**
   * è·å–æ‰€æœ‰ç³»ç»Ÿçº§æ¨¡å—ï¼ˆç®¡ç†ç«¯ï¼‰
   */
  static async getSystemModules(includeInactive = false) {
    try {
      let sql = `
        SELECT km.*, u.username as creator_name
        FROM knowledge_modules km
        LEFT JOIN users u ON km.creator_id = u.id
        WHERE km.module_scope = 'system'
      `;
      
      if (!includeInactive) {
        sql += ' AND km.is_active = 1';
      }
      
      sql += ' ORDER BY km.sort_order ASC, km.created_at DESC';
      
      const { rows } = await dbConnection.query(sql);
      
      return rows.map(row => {
        const module = new KnowledgeModule(row);
        module.creator_name = row.creator_name;
        
        // è§£ægroup_ids - ä½¿ç”¨ç»Ÿä¸€çš„è§„èŒƒåŒ–æ–¹æ³•
        module.group_ids = KnowledgeModule.normalizeGroupIds(row.group_ids);
        
        return module;
      });
    } catch (error) {
      logger.error('è·å–ç³»ç»Ÿçº§çŸ¥è¯†æ¨¡å—å¤±è´¥:', error);
      throw new DatabaseError('è·å–ç³»ç»Ÿçº§çŸ¥è¯†æ¨¡å—å¤±è´¥', error);
    }
  }

  /**
   * æ ¹æ®IDè·å–çŸ¥è¯†æ¨¡å—
   */
  static async findById(id, userId = null) {
    try {
      const sql = `
        SELECT km.*, u.username as creator_name, ug.name as group_name,
               GROUP_CONCAT(kmtp.tag_id) as allowed_tag_ids_str
        FROM knowledge_modules km
        LEFT JOIN users u ON km.creator_id = u.id
        LEFT JOIN user_groups ug ON km.group_id = ug.id
        LEFT JOIN knowledge_module_tag_permissions kmtp ON km.id = kmtp.module_id
        WHERE km.id = ?
        GROUP BY km.id
      `;
      
      const { rows } = await dbConnection.query(sql, [id]);
      
      if (rows.length === 0) {
        return null;
      }
      
      const module = new KnowledgeModule(rows[0]);
      module.creator_name = rows[0].creator_name;
      module.group_name = rows[0].group_name;
      
      // è§£ægroup_ids - ä½¿ç”¨ç»Ÿä¸€çš„è§„èŒƒåŒ–æ–¹æ³•
      module.group_ids = KnowledgeModule.normalizeGroupIds(rows[0].group_ids);
      
      // è§£æallowed_tag_ids
      if (rows[0].allowed_tag_ids_str) {
        module.allowed_tag_ids = rows[0].allowed_tag_ids_str.split(',').map(id => parseInt(id));
      } else {
        module.allowed_tag_ids = [];
      }
      
      // æ£€æŸ¥å†…å®¹å¯è§æ€§
      if (userId) {
        // è·å–ç”¨æˆ·è§’è‰²
        const userResult = await dbConnection.query('SELECT role FROM users WHERE id = ?', [userId]);
        const userRole = userResult.rows[0]?.role;
        
        // è¶…çº§ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰å†…å®¹
        if (userRole === 'super_admin') {
          logger.debug('è¶…çº§ç®¡ç†å‘˜æŸ¥çœ‹æ¨¡å—', {
            moduleId: id,
            moduleName: module.name,
            userId
          });
          return module;
        }
        
        // ç³»ç»Ÿçº§æ¨¡å—çš„å†…å®¹å¯è§æ€§å¤„ç†
        if (module.module_scope === 'system') {
          if (!module.content_visible) {
            module.content = null;
            module.content_hidden = true;
          }
        } else if (module.module_scope === 'team') {
          // å›¢é˜Ÿæ¨¡å—ï¼šéåˆ›å»ºè€…éœ€è¦æ£€æŸ¥content_visible
          if (module.creator_id !== userId && !module.content_visible) {
            module.content = null;
            module.content_hidden = true;
          }
        } else if (module.module_scope === 'personal' && module.creator_id !== userId) {
          // ä¸ªäººæ¨¡å—ï¼šéåˆ›å»ºè€…ä¸åº”è¯¥èƒ½è®¿é—®
          return null;
        }
      }
      
      return module;
    } catch (error) {
      logger.error('æ ¹æ®IDæŸ¥æ‰¾çŸ¥è¯†æ¨¡å—å¤±è´¥:', error);
      throw new DatabaseError('æŸ¥æ‰¾çŸ¥è¯†æ¨¡å—å¤±è´¥', error);
    }
  }

  /**
   * åˆ›å»ºçŸ¥è¯†æ¨¡å—
   * ğŸ”§ ä¿®å¤ï¼šç»Ÿä¸€group_idsä¸ºæ•´æ•°æ•°ç»„
   */
  static async create(data, creatorId) {
    const transaction = await dbConnection.beginTransaction();
    try {
      // éªŒè¯æƒé™
      const { module_scope, group_id, group_ids, allowed_tag_ids } = data;
      
      // å¦‚æœæ˜¯å›¢é˜Ÿæ¨¡å—ï¼Œå¿…é¡»æœ‰group_id
      if (module_scope === 'team' && !group_id) {
        throw new ValidationError('å›¢é˜Ÿæ¨¡å—å¿…é¡»æŒ‡å®šæ‰€å±ç»„');
      }
      
      // è®¡ç®—tokenæ•°é‡
      const tokenCount = calculateTokens(data.content || '');
      
      // ğŸ”§ ä¿®å¤ï¼šå¤„ç†group_idsï¼Œç»Ÿä¸€ä¸ºæ•´æ•°æ•°ç»„å¹¶åºåˆ—åŒ–
      let processedGroupIds = null;
      if (module_scope === 'system' && group_ids) {
        const normalized = KnowledgeModule.normalizeGroupIds(group_ids);
        if (normalized && normalized.length > 0) {
          processedGroupIds = JSON.stringify(normalized);
          
          logger.info('ä¿å­˜ç³»ç»Ÿæ¨¡å—çš„group_ids', {
            åŸå§‹å€¼: group_ids,
            è§„èŒƒåŒ–å: normalized,
            JSONå­—ç¬¦ä¸²: processedGroupIds
          });
        }
      }
      
      const sql = `
        INSERT INTO knowledge_modules (
          name, description, content, token_count, prompt_type, module_scope,
          content_visible, creator_id, group_id, group_ids, category, tags,
          sort_order, is_active
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `;
      
      const params = [
        data.name,
        data.description || null,
        data.content,
        tokenCount,
        data.prompt_type || 'normal',
        module_scope || 'personal',
        data.content_visible !== undefined ? data.content_visible : true,
        creatorId,
        module_scope === 'team' ? group_id : null,
        processedGroupIds,
        data.category || null,
        data.tags ? JSON.stringify(data.tags) : null,
        data.sort_order || 0,
        data.is_active !== undefined ? data.is_active : true
      ];
      
      const result = await transaction.query(sql, params);
      const insertId = result.rows.insertId;
      
      // å¦‚æœæ˜¯å›¢é˜Ÿæ¨¡å—ä¸”è®¾ç½®äº†æ ‡ç­¾æƒé™ï¼Œä¿å­˜æ ‡ç­¾æƒé™
      if (module_scope === 'team' && allowed_tag_ids && allowed_tag_ids.length > 0) {
        for (const tagId of allowed_tag_ids) {
          await transaction.query(
            'INSERT INTO knowledge_module_tag_permissions (module_id, tag_id, created_by) VALUES (?, ?, ?)',
            [insertId, tagId, creatorId]
          );
        }
      }
      
      await transaction.commit();
      
      logger.info('åˆ›å»ºçŸ¥è¯†æ¨¡å—æˆåŠŸ', { 
        moduleId: insertId, 
        name: data.name,
        creatorId,
        scope: module_scope,
        group_ids: processedGroupIds,
        allowed_tag_ids,
        tokenCount
      });
      
      return await KnowledgeModule.findById(insertId);
    } catch (error) {
      await transaction.rollback();
      logger.error('åˆ›å»ºçŸ¥è¯†æ¨¡å—å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * æ›´æ–°çŸ¥è¯†æ¨¡å—
   * ğŸ”§ ä¿®å¤ï¼šç»Ÿä¸€group_idsä¸ºæ•´æ•°æ•°ç»„
   */
  static async update(id, data, operatorId) {
    const transaction = await dbConnection.beginTransaction();
    try {
      // è·å–åŸæ¨¡å—ä¿¡æ¯
      const originalModule = await KnowledgeModule.findById(id);
      if (!originalModule) {
        throw new ValidationError('çŸ¥è¯†æ¨¡å—ä¸å­˜åœ¨');
      }
      
      // æ£€æŸ¥æƒé™
      if (originalModule.creator_id !== operatorId) {
        const operator = await transaction.query('SELECT role FROM users WHERE id = ?', [operatorId]);
        if (operator.rows[0]?.role !== 'super_admin') {
          throw new ValidationError('æ— æƒä¿®æ”¹æ­¤æ¨¡å—');
        }
      }
      
      const updateFields = [];
      const updateValues = [];
      
      // å¦‚æœæ›´æ–°äº†å†…å®¹ï¼Œé‡æ–°è®¡ç®—token
      if (data.content !== undefined) {
        const tokenCount = calculateTokens(data.content);
        updateFields.push('content = ?', 'token_count = ?');
        updateValues.push(data.content, tokenCount);
      }
      
      // å…è®¸æ›´æ–°çš„å…¶ä»–å­—æ®µ
      const allowedFields = ['name', 'description', 'prompt_type', 'content_visible', 
                           'category', 'tags', 'sort_order', 'is_active'];
      
      // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯ç³»ç»Ÿçº§æ¨¡å—ï¼Œå…è®¸æ›´æ–°group_idsï¼ˆç»Ÿä¸€ä¸ºæ•´æ•°æ•°ç»„ï¼‰
      if (originalModule.module_scope === 'system' && data.group_ids !== undefined) {
        updateFields.push('group_ids = ?');
        const normalized = KnowledgeModule.normalizeGroupIds(data.group_ids);
        if (normalized && normalized.length > 0) {
          const processedGroupIds = JSON.stringify(normalized);
          updateValues.push(processedGroupIds);
          
          logger.info('æ›´æ–°ç³»ç»Ÿæ¨¡å—çš„group_ids', {
            moduleId: id,
            åŸå§‹å€¼: data.group_ids,
            è§„èŒƒåŒ–å: normalized,
            JSONå­—ç¬¦ä¸²: processedGroupIds
          });
        } else {
          updateValues.push(null);
          logger.info('æ¸…ç©ºç³»ç»Ÿæ¨¡å—çš„group_idsï¼ˆè®¾ä¸ºæ‰€æœ‰ç»„å¯è§ï¼‰', { moduleId: id });
        }
      }
      
      allowedFields.forEach(field => {
        if (data[field] !== undefined && field !== 'content') {
          updateFields.push(`${field} = ?`);
          if (field === 'tags') {
            updateValues.push(data[field] ? JSON.stringify(data[field]) : null);
          } else {
            updateValues.push(data[field]);
          }
        }
      });
      
      if (updateFields.length > 0) {
        updateValues.push(id);
        const sql = `UPDATE knowledge_modules SET ${updateFields.join(', ')} WHERE id = ?`;
        await transaction.query(sql, updateValues);
      }
      
      // å¦‚æœæ˜¯å›¢é˜Ÿæ¨¡å—ï¼Œæ›´æ–°æ ‡ç­¾æƒé™
      if (originalModule.module_scope === 'team' && data.allowed_tag_ids !== undefined) {
        // åˆ é™¤æ—§çš„æƒé™
        await transaction.query('DELETE FROM knowledge_module_tag_permissions WHERE module_id = ?', [id]);
        
        // æ·»åŠ æ–°çš„æƒé™
        if (data.allowed_tag_ids && data.allowed_tag_ids.length > 0) {
          for (const tagId of data.allowed_tag_ids) {
            await transaction.query(
              'INSERT INTO knowledge_module_tag_permissions (module_id, tag_id, created_by) VALUES (?, ?, ?)',
              [id, tagId, operatorId]
            );
          }
        }
      }
      
      await transaction.commit();
      
      logger.info('æ›´æ–°çŸ¥è¯†æ¨¡å—æˆåŠŸ', { 
        moduleId: id, 
        operatorId,
        updatedFields: updateFields,
        allowed_tag_ids: data.allowed_tag_ids
      });
      
      return await KnowledgeModule.findById(id);
    } catch (error) {
      await transaction.rollback();
      logger.error('æ›´æ–°çŸ¥è¯†æ¨¡å—å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * åˆ é™¤çŸ¥è¯†æ¨¡å—
   */
  static async delete(id, operatorId) {
    try {
      // è·å–æ¨¡å—ä¿¡æ¯
      const module = await KnowledgeModule.findById(id);
      if (!module) {
        throw new ValidationError('çŸ¥è¯†æ¨¡å—ä¸å­˜åœ¨');
      }
      
      // æ£€æŸ¥æƒé™
      if (module.creator_id !== operatorId) {
        const operator = await dbConnection.query('SELECT role FROM users WHERE id = ?', [operatorId]);
        if (operator.rows[0]?.role !== 'super_admin') {
          throw new ValidationError('æ— æƒåˆ é™¤æ­¤æ¨¡å—');
        }
      }
      
      // è½¯åˆ é™¤
      const sql = 'UPDATE knowledge_modules SET is_active = 0 WHERE id = ?';
      await dbConnection.query(sql, [id]);
      
      logger.info('åˆ é™¤çŸ¥è¯†æ¨¡å—æˆåŠŸ', { moduleId: id, operatorId });
      
      return true;
    } catch (error) {
      logger.error('åˆ é™¤çŸ¥è¯†æ¨¡å—å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ä½¿ç”¨è¯¥æ¨¡å—
   * ğŸ”§ æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿ç±»å‹å®‰å…¨çš„æƒé™æ¯”è¾ƒ
   */
  static async checkUserAccess(moduleId, userId, groupId, userRole = null) {
    try {
      // å¦‚æœæ²¡æœ‰ä¼ å…¥ç”¨æˆ·è§’è‰²ï¼ŒæŸ¥è¯¢ç”¨æˆ·è§’è‰²
      if (!userRole) {
        const userResult = await dbConnection.query('SELECT role FROM users WHERE id = ?', [userId]);
        userRole = userResult.rows[0]?.role;
      }
      
      // è¶…çº§ç®¡ç†å‘˜æ€»æ˜¯æœ‰æƒé™
      if (userRole === 'super_admin') {
        logger.debug('è¶…çº§ç®¡ç†å‘˜è®¿é—®æ¨¡å—', {
          moduleId,
          userId
        });
        return true;
      }
      
      // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿groupIdæ˜¯æ•´æ•°
      const normalizedGroupId = parseInt(groupId, 10);
      
      // è·å–ç”¨æˆ·çš„æ ‡ç­¾IDåˆ—è¡¨
      const userTagsSql = `
        SELECT tag_id FROM user_tag_relations WHERE user_id = ?
      `;
      const { rows: userTagRows } = await dbConnection.query(userTagsSql, [userId]);
      const userTagIds = userTagRows.map(row => row.tag_id);
      
      // æ£€æŸ¥æ¨¡å—è®¿é—®æƒé™
      const sql = `
        SELECT km.*, 
               (SELECT COUNT(*) FROM knowledge_module_tag_permissions WHERE module_id = km.id) as tag_permission_count
        FROM knowledge_modules km
        WHERE km.id = ? 
        AND km.is_active = 1
      `;
      
      const { rows } = await dbConnection.query(sql, [moduleId]);
      
      if (rows.length === 0) {
        logger.warn('æ¨¡å—ä¸å­˜åœ¨æˆ–æœªæ¿€æ´»', { moduleId, userId });
        return false;
      }
      
      const module = rows[0];
      
      // ä¸ªäººæ¨¡å—ï¼šåªæœ‰åˆ›å»ºè€…å¯ä»¥è®¿é—®
      if (module.module_scope === 'personal') {
        const hasAccess = module.creator_id === userId;
        logger.debug('ä¸ªäººæ¨¡å—æƒé™æ£€æŸ¥', {
          moduleId,
          userId,
          creatorId: module.creator_id,
          hasAccess
        });
        return hasAccess;
      }
      
      // å›¢é˜Ÿæ¨¡å—ï¼šæ£€æŸ¥ç»„å’Œæ ‡ç­¾æƒé™
      if (module.module_scope === 'team') {
        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦åŒç»„
        if (module.group_id !== normalizedGroupId) {
          logger.debug('å›¢é˜Ÿæ¨¡å—ç»„ä¸åŒ¹é…', {
            moduleId,
            userId,
            moduleGroupId: module.group_id,
            userGroupId: normalizedGroupId
          });
          return false;
        }
        
        // åˆ›å»ºè€…å§‹ç»ˆæœ‰æƒé™
        if (module.creator_id === userId) {
          logger.debug('å›¢é˜Ÿæ¨¡å—åˆ›å»ºè€…è®¿é—®', { moduleId, userId });
          return true;
        }
        
        // å¦‚æœæ²¡æœ‰æ ‡ç­¾é™åˆ¶ï¼Œç»„å†…æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æƒé™
        if (module.tag_permission_count === 0) {
          logger.debug('å›¢é˜Ÿæ¨¡å—æ— æ ‡ç­¾é™åˆ¶', { moduleId, userId });
          return true;
        }
        
        // å¦‚æœæœ‰æ ‡ç­¾é™åˆ¶ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰å…è®¸çš„æ ‡ç­¾
        if (userTagIds.length > 0) {
          const checkTagSql = `
            SELECT COUNT(*) as count 
            FROM knowledge_module_tag_permissions 
            WHERE module_id = ? AND tag_id IN (${userTagIds.map(() => '?').join(',')})
          `;
          const { rows: tagCheckRows } = await dbConnection.query(checkTagSql, [moduleId, ...userTagIds]);
          const hasAccess = tagCheckRows[0].count > 0;
          
          logger.debug('å›¢é˜Ÿæ¨¡å—æ ‡ç­¾æƒé™æ£€æŸ¥', {
            moduleId,
            userId,
            userTagIds,
            matchCount: tagCheckRows[0].count,
            hasAccess
          });
          
          return hasAccess;
        }
        
        logger.debug('å›¢é˜Ÿæ¨¡å—ï¼šç”¨æˆ·æ— æ ‡ç­¾ä¸”æ¨¡å—æœ‰æ ‡ç­¾é™åˆ¶', { moduleId, userId });
        return false;
      }
      
      // ğŸ”§ æ ¸å¿ƒä¿®å¤ï¼šç³»ç»Ÿæ¨¡å—æƒé™æ£€æŸ¥ - ç±»å‹å®‰å…¨çš„æ¯”è¾ƒ
      if (module.module_scope === 'system') {
        // è§£ægroup_ids - ä½¿ç”¨ç»Ÿä¸€çš„è§„èŒƒåŒ–æ–¹æ³•
        const allowedGroups = KnowledgeModule.normalizeGroupIds(module.group_ids);
        
        // NULLæˆ–ç©ºæ•°ç»„è¡¨ç¤ºæ‰€æœ‰ç»„å¯è§
        if (!allowedGroups || allowedGroups.length === 0) {
          logger.debug('ç³»ç»Ÿæ¨¡å—å¯¹æ‰€æœ‰ç»„å¯è§', {
            moduleId,
            userId,
            userGroupId: normalizedGroupId
          });
          return true;
        }
        
        // ğŸ”§ ç±»å‹å®‰å…¨çš„æ¯”è¾ƒï¼šç»Ÿä¸€ä¸ºæ•´æ•°åæ¯”è¾ƒ
        const hasAccess = allowedGroups.includes(normalizedGroupId);
        
        logger.debug('ç³»ç»Ÿæ¨¡å—ç»„æƒé™æ£€æŸ¥', {
          moduleId,
          userId,
          userGroupId: normalizedGroupId,
          allowedGroups,
          hasAccess
        });
        
        return hasAccess;
      }
      
      logger.warn('æœªçŸ¥çš„æ¨¡å—ç±»å‹', {
        moduleId,
        moduleScope: module.module_scope,
        userId
      });
      
      return false;
    } catch (error) {
      logger.error('æ£€æŸ¥æ¨¡å—è®¿é—®æƒé™å¤±è´¥:', error);
      return false;
    }
  }

  /**
   * æ›´æ–°ä½¿ç”¨æ¬¡æ•°
   */
  static async incrementUsageCount(moduleId) {
    try {
      const sql = 'UPDATE knowledge_modules SET usage_count = usage_count + 1 WHERE id = ?';
      await dbConnection.query(sql, [moduleId]);
    } catch (error) {
      logger.error('æ›´æ–°æ¨¡å—ä½¿ç”¨æ¬¡æ•°å¤±è´¥:', error);
    }
  }

  /**
   * è½¬æ¢ä¸ºJSONï¼ˆæ§åˆ¶å†…å®¹å¯è§æ€§ï¼‰
   */
  toJSON() {
    const data = {
      id: this.id,
      name: this.name,
      description: this.description,
      token_count: this.token_count,
      prompt_type: this.prompt_type,
      module_scope: this.module_scope,
      content_visible: this.content_visible,
      creator_id: this.creator_id,
      group_id: this.group_id,
      group_ids: this.group_ids,
      category: this.category,
      tags: this.tags,
      sort_order: this.sort_order,
      is_active: this.is_active,
      usage_count: this.usage_count,
      created_at: this.created_at,
      updated_at: this.updated_at,
      allowed_tag_ids: this.allowed_tag_ids
    };
    
    // å¦‚æœå†…å®¹è¢«éšè—ï¼Œæ·»åŠ æ ‡è¯†
    if (this.content_hidden) {
      data.content_hidden = true;
    } else {
      data.content = this.content;
    }
    
    // æ·»åŠ é¢å¤–ä¿¡æ¯
    if (this.creator_name) {
      data.creator_name = this.creator_name;
    }
    if (this.group_name) {
      data.group_name = this.group_name;
    }
    
    return data;
  }
}

module.exports = KnowledgeModule;
