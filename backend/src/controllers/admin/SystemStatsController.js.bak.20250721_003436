/**
 * 系统统计控制器 - 支持基于角色的数据过滤
 */

const { StatsService } = require('../../services/admin');
const ResponseHelper = require('../../utils/response');
const logger = require('../../utils/logger');
const { ROLES } = require('../../middleware/permissions');

class SystemStatsController {
  /**
   * 获取系统统计 - 根据用户角色过滤数据
   */
  static async getSystemStats(req, res) {
    try {
      const currentUser = req.user;
      const userRole = currentUser.role;
      
      // 组管理员只能看到本组数据
      const filterOptions = {
        groupId: userRole === ROLES.ADMIN ? currentUser.group_id : null,
        limitToGroup: userRole === ROLES.ADMIN
      };
      
      const stats = await StatsService.getSystemStats(currentUser, filterOptions);

      return ResponseHelper.success(res, stats, '获取系统统计成功');
    } catch (error) {
      logger.error('获取系统统计失败', { 
        adminId: req.user?.id, 
        error: error.message 
      });
      return ResponseHelper.error(res, error.message || '获取系统统计失败');
    }
  }

  /**
   * 获取系统设置 - 根据角色返回不同的配置
   */
  static async getSystemSettings(req, res) {
    try {
      const userRole = req.user.role;
      
      // 基础设置（所有角色都能看到）
      const settings = {
        site: {
          name: 'AI Platform',
          description: '企业级AI应用聚合平台',
          logo: '',
          favicon: ''
        },
        user: {
          allow_register: true,
          default_token_quota: 10000,
          default_group_id: 1,
          default_credits_quota: 1000
        },
        ai: {
          default_model: 'openai/gpt-4.1-mini',
          temperature: 0.0
        },
        credits: {
          default_credits: 1000,
          max_credits: 100000,
          min_credits_for_chat: 1
        }
      };
      
      // 组管理员：添加只读标记
      if (userRole === ROLES.ADMIN) {
        settings._readOnly = true;
        settings._message = '组管理员只能查看设置，不能修改';
      }

      return ResponseHelper.success(res, settings, '获取系统设置成功');
    } catch (error) {
      logger.error('获取系统设置失败', { 
        userId: req.user?.id, 
        error: error.message 
      });
      return ResponseHelper.error(res, error.message || '获取系统设置失败');
    }
  }

  /**
   * 更新系统设置 - 只有超级管理员可以操作
   */
  static async updateSystemSettings(req, res) {
    try {
      const userRole = req.user.role;
      
      // 双重检查：只有超级管理员可以更新
      if (userRole !== ROLES.SUPER_ADMIN) {
        return ResponseHelper.forbidden(res, '只有超级管理员可以修改系统设置');
      }
      
      const settings = req.body;

      // TODO: 实现系统设置的持久化存储
      logger.info('管理员更新系统设置', { 
        adminId: req.user.id,
        settings
      });

      return ResponseHelper.success(res, settings, '系统设置更新成功');
    } catch (error) {
      logger.error('更新系统设置失败', { 
        adminId: req.user?.id, 
        error: error.message 
      });
      return ResponseHelper.error(res, error.message || '更新系统设置失败');
    }
  }

  /**
   * 获取实时统计数据 - 根据角色过滤
   */
  static async getRealtimeStats(req, res) {
    try {
      const userRole = req.user.role;
      const filterOptions = {
        groupId: userRole === ROLES.ADMIN ? req.user.group_id : null
      };
      
      const stats = await StatsService.getRealtimeStats(filterOptions);

      return ResponseHelper.success(res, stats, '获取实时统计成功');
    } catch (error) {
      logger.error('获取实时统计失败', { 
        adminId: req.user?.id, 
        error: error.message 
      });
      return ResponseHelper.error(res, error.message || '获取实时统计失败');
    }
  }

  /**
   * 生成统计报表 - 组管理员只能生成本组报表
   */
  static async generateReport(req, res) {
    try {
      const { start_date, end_date, group_id, format = 'json' } = req.query;
      const userRole = req.user.role;
      
      // 组管理员强制使用自己的组ID
      let actualGroupId = group_id;
      if (userRole === ROLES.ADMIN) {
        actualGroupId = req.user.group_id;
      }
      
      const report = await StatsService.generateReport({
        startDate: start_date,
        endDate: end_date,
        groupId: actualGroupId,
        format,
        limitToGroup: userRole === ROLES.ADMIN
      });

      return ResponseHelper.success(res, report, '统计报表生成成功');
    } catch (error) {
      logger.error('生成统计报表失败', { 
        adminId: req.user?.id, 
        error: error.message 
      });
      return ResponseHelper.error(res, error.message || '生成统计报表失败');
    }
  }
}

module.exports = SystemStatsController;
