/**
 * 全局授权服务
 * 
 * 功能：
 * - 查询 teaching_global_authorizations 表（新系统）
 * - 解析 config_data JSON 配置
 * - 实现三级权限继承：组 → 标签 → 用户
 * - 支持模块级和课程级权限
 * - 返回用户的最终权限（考虑继承和覆盖）
 * 
 * 权限优先级：
 * 1. 用户级权限（最高优先级）
 * 2. 标签级权限
 * 3. 组级权限
 * 
 * 课程权限优先级：
 * 1. 用户课程级权限
 * 2. 用户模块级权限（继承）
 * 3. 标签课程级权限
 * 4. 标签模块级权限（继承）
 * 5. 组课程级权限
 * 6. 组模块级权限（继承）
 */

const dbConnection = require('../database/connection');
const logger = require('../utils/logger');

class GlobalAuthorizationService {
  /**
   * 获取用户对模块的权限
   * @param {number} userId - 用户ID
   * @param {number} moduleId - 模块ID
   * @param {number} userGroupId - 用户所属组ID
   * @param {Array} userTags - 用户标签列表 [{id, name}, ...]
   * @returns {Object} { hasView: boolean, hasEdit: boolean }
   */
  static async getUserModulePermission(userId, moduleId, userGroupId, userTags = []) {
    try {
      // 获取用户组的全局授权配置
      if (!userGroupId) {
        return { hasView: false, hasEdit: false };
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return { hasView: false, hasEdit: false };
      }

      // 解析配置数据
      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return { hasView: false, hasEdit: false };
      }

      // 1. 检查组级权限
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      let hasView = groupModulePerm?.view || false;
      let hasEdit = groupModulePerm?.edit || false;

      // 2. 检查标签级权限（优先级更高）
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        // 如果标签继承组权限，跳过（已经有组权限了）
        if (tag.inheritFromGroup) {
          continue;
        }

        // 标签有独立权限配置
        const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
        if (tagModulePerm) {
          hasView = tagModulePerm.view || hasView;
          hasEdit = tagModulePerm.edit || hasEdit;
        }
      }

      // 3. 检查用户级权限（最高优先级）
      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (!userConfig) {
          continue;
        }

        // 如果用户继承标签权限，跳过（已经有标签权限了）
        if (userConfig.inheritFromTag) {
          continue;
        }

        // 用户有独立权限配置
        const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
        if (userModulePerm) {
          hasView = userModulePerm.view || false; // 用户级覆盖，不继承
          hasEdit = userModulePerm.edit || false;
        }
      }

      return { hasView, hasEdit };
    } catch (error) {
      logger.error('获取用户模块权限失败:', error);
      return { hasView: false, hasEdit: false };
    }
  }

  /**
   * 获取用户对课程的权限
   * @param {number} userId - 用户ID
   * @param {number} moduleId - 模块ID
   * @param {number} lessonId - 课程ID
   * @param {number} userGroupId - 用户所属组ID
   * @param {Array} userTags - 用户标签列表
   * @returns {Object} { hasView: boolean, hasEdit: boolean }
   */
  static async getUserLessonPermission(userId, moduleId, lessonId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return { hasView: false, hasEdit: false };
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return { hasView: false, hasEdit: false };
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return { hasView: false, hasEdit: false };
      }

      // 1. 组级权限
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      const groupLessonPerm = this._findLessonPermission(groupModulePerm?.lessons || [], lessonId);

      let hasView = groupLessonPerm?.view || groupModulePerm?.view || false;
      let hasEdit = groupLessonPerm?.edit || groupModulePerm?.edit || false;

      // 2. 标签级权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        if (tag.inheritFromGroup) {
          continue;
        }

        const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
        const tagLessonPerm = this._findLessonPermission(tagModulePerm?.lessons || [], lessonId);

        if (tagLessonPerm) {
          hasView = tagLessonPerm.view;
          hasEdit = tagLessonPerm.edit;
        } else if (tagModulePerm) {
          hasView = tagModulePerm.view || hasView;
          hasEdit = tagModulePerm.edit || hasEdit;
        }
      }

      // 3. 用户级权限（最高优先级）
      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (!userConfig || userConfig.inheritFromTag) {
          continue;
        }

        const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
        const userLessonPerm = this._findLessonPermission(userModulePerm?.lessons || [], lessonId);

        if (userLessonPerm) {
          hasView = userLessonPerm.view;
          hasEdit = userLessonPerm.edit;
        } else if (userModulePerm) {
          hasView = userModulePerm.view;
          hasEdit = userModulePerm.edit;
        }
      }

      return { hasView, hasEdit };
    } catch (error) {
      logger.error('获取用户课程权限失败:', error);
      return { hasView: false, hasEdit: false };
    }
  }

  /**
   * 获取用户有权限访问的所有模块ID列表
   * @param {number} userId - 用户ID
   * @param {number} userGroupId - 用户组ID
   * @param {Array} userTags - 用户标签列表
   * @returns {Array} 模块ID列表
   */
  static async getUserAuthorizedModuleIds(userId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return [];
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return [];
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return [];
      }

      const moduleIds = new Set();

      // 收集组级权限的模块
      const groupPerms = config.modulePermissions || [];
      groupPerms.forEach(perm => {
        if (perm.view || perm.edit) {
          moduleIds.add(perm.moduleId);
        }
      });

      // 收集标签级权限的模块
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      tags.forEach(tag => {
        if (!userTagIds.includes(tag.tagId)) {
          return;
        }

        if (!tag.inheritFromGroup) {
          const tagPerms = tag.modulePermissions || [];
          tagPerms.forEach(perm => {
            if (perm.view || perm.edit) {
              moduleIds.add(perm.moduleId);
            }
          });
        }

        // 收集用户级权限的模块
        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (userConfig && !userConfig.inheritFromTag) {
          const userPerms = userConfig.modulePermissions || [];
          userPerms.forEach(perm => {
            if (perm.view || perm.edit) {
              moduleIds.add(perm.moduleId);
            }
          });
        }
      });

      return Array.from(moduleIds);
    } catch (error) {
      logger.error('获取用户授权模块ID失败:', error);
      return [];
    }
  }

  /**
   * 辅助方法：从权限列表中查找指定模块的权限
   */
  static _findModulePermission(permissions, moduleId) {
    return permissions.find(p => p.moduleId === moduleId);
  }

  /**
   * 辅助方法：从课程权限列表中查找指定课程的权限
   */
  static _findLessonPermission(lessons, lessonId) {
    return lessons.find(l => l.lessonId === lessonId);
  }

  /**
   * 检查用户是否有模块的任意权限（查看或编辑）
   */
  static async hasAnyModulePermission(userId, moduleId, userGroupId, userTags = []) {
    const perm = await this.getUserModulePermission(userId, moduleId, userGroupId, userTags);
    return perm.hasView || perm.hasEdit;
  }

  /**
   * 检查用户是否有课程的任意权限
   */
  static async hasAnyLessonPermission(userId, moduleId, lessonId, userGroupId, userTags = []) {
    const perm = await this.getUserLessonPermission(userId, moduleId, lessonId, userGroupId, userTags);
    return perm.hasView || perm.hasEdit;
  }
}

module.exports = GlobalAuthorizationService;
