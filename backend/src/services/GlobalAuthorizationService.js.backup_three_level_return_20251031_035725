/**
 * 全局授权服务（三级权限完整支持版）
 * 
 * 版本更新 v2.1.0 (2025-10-31):
 * ✅ 完整支持三级权限字段：
 *    - view_lesson (Level 1 - 查看课程)
 *    - view_plan (Level 2 - 查看教案)
 *    - edit (Level 3 - 编辑)
 * ✅ 向后兼容旧的 view 字段
 * ✅ 正确处理权限继承链
 * ✅ 修复"取消继承权限消失"问题
 * 
 * 核心修复：
 * - 所有权限判断支持三级权限字段
 * - 课程false权限正确处理
 * - 权限层级关系清晰
 */

const dbConnection = require('../database/connection');
const logger = require('../utils/logger');

class GlobalAuthorizationService {
  /**
   * 检查模块是否有任何权限（三级权限版）
   */
  static _hasAnyPermission(perm) {
    if (!perm) return false;
    return perm.view_lesson || perm.view_plan || perm.edit || perm.view || false;
  }

  /**
   * 获取用户对模块的权限（三级权限完整支持）
   */
  static async getUserModulePermission(userId, moduleId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return { hasView: false, hasEdit: false };
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return { hasView: false, hasEdit: false };
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return { hasView: false, hasEdit: false };
      }

      // 1. 组级权限（基础权限）
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      let hasView = false;
      let hasEdit = false;
      
      // 记录组级权限（三级权限支持）
      const groupView = groupModulePerm?.view_lesson || groupModulePerm?.view_plan || groupModulePerm?.view || this._hasAnyLessonPermission(groupModulePerm) || false;
      const groupEdit = groupModulePerm?.edit || false;

      // 2. 处理标签和用户权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);
      
      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);
        
        if (userConfig) {
          if (userConfig.inheritFromTag) {
            if (tag.inheritFromGroup) {
              hasView = groupView;
              hasEdit = groupEdit;
              
              logger.info('用户继承标签，标签继承组（使用组权限）', {
                userId,
                moduleId,
                tagId: tag.tagId,
                groupView,
                groupEdit,
                hasView,
                hasEdit
              });
            } else {
              const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
              if (tagModulePerm) {
                const tagHasAnyLessonPerm = this._hasAnyLessonPermission(tagModulePerm);
                hasView = tagModulePerm.view_lesson || tagModulePerm.view_plan || tagModulePerm.view || tagHasAnyLessonPerm || false;
                hasEdit = tagModulePerm.edit || false;
              } else {
                hasView = false;
                hasEdit = false;
              }
              
              logger.info('用户继承标签权限', {
                userId,
                moduleId,
                tagId: tag.tagId,
                hasView,
                hasEdit
              });
            }
          } else {
            const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
            if (userModulePerm) {
              const userHasAnyLessonPerm = this._hasAnyLessonPermission(userModulePerm);
              hasView = userModulePerm.view_lesson || userModulePerm.view_plan || userModulePerm.view || userHasAnyLessonPerm || false;
              hasEdit = userModulePerm.edit || false;
              
              logger.info('用户使用自定义权限', {
                userId,
                moduleId,
                hasView,
                hasEdit
              });
            } else {
              hasView = false;
              hasEdit = false;
              
              logger.info('用户无此模块权限配置', {
                userId,
                moduleId
              });
            }
          }
        } else {
          if (tag.inheritFromGroup) {
            hasView = groupView;
            hasEdit = groupEdit;
            
            logger.info('用户无配置，标签继承组权限', {
              userId,
              moduleId,
              tagId: tag.tagId,
              hasView,
              hasEdit
            });
          } else {
            const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
            if (tagModulePerm) {
              const tagHasAnyLessonPerm = this._hasAnyLessonPermission(tagModulePerm);
              hasView = tagModulePerm.view_lesson || tagModulePerm.view_plan || tagModulePerm.view || tagHasAnyLessonPerm || false;
              hasEdit = tagModulePerm.edit || false;
            } else {
              hasView = false;
              hasEdit = false;
            }
            
            logger.info('用户无配置，使用标签权限', {
              userId,
              moduleId,
              tagId: tag.tagId,
              hasView,
              hasEdit
            });
          }
        }
        
        break;
      }

      if (userTagIds.length === 0) {
        hasView = groupView;
        hasEdit = groupEdit;
        
        logger.info('用户无标签，使用组权限', {
          userId,
          moduleId,
          hasView,
          hasEdit
        });
      }

      return { hasView, hasEdit };
    } catch (error) {
      logger.error('获取用户模块权限失败:', error);
      return { hasView: false, hasEdit: false };
    }
  }

  /**
   * 获取用户对课程的权限（三级权限完整支持）
   */
  static async getUserLessonPermission(userId, moduleId, lessonId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return { hasView: false, hasEdit: false };
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return { hasView: false, hasEdit: false };
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return { hasView: false, hasEdit: false };
      }

      // 1. 组级权限
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      const groupLessonPerm = this._findLessonPermission(groupModulePerm?.lessons || [], lessonId);

      let groupView, groupEdit;
      if (groupLessonPerm) {
        groupView = groupLessonPerm.view_lesson || groupLessonPerm.view_plan || groupLessonPerm.view || false;
        groupEdit = groupLessonPerm.edit || false;
      } else {
        groupView = groupModulePerm?.view_lesson || groupModulePerm?.view_plan || groupModulePerm?.view || false;
        groupEdit = groupModulePerm?.edit || false;
      }

      let hasView = false;
      let hasEdit = false;

      // 2. 处理标签和用户权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (userConfig) {
          if (userConfig.inheritFromTag) {
            if (tag.inheritFromGroup) {
              hasView = groupView;
              hasEdit = groupEdit;
            } else {
              const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
              const tagLessonPerm = this._findLessonPermission(tagModulePerm?.lessons || [], lessonId);
              
              if (tagLessonPerm) {
                hasView = tagLessonPerm.view_lesson || tagLessonPerm.view_plan || tagLessonPerm.view || false;
                hasEdit = tagLessonPerm.edit || false;
              } else {
                hasView = tagModulePerm?.view_lesson || tagModulePerm?.view_plan || tagModulePerm?.view || false;
                hasEdit = tagModulePerm?.edit || false;
              }
            }
          } else {
            const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
            const userLessonPerm = this._findLessonPermission(userModulePerm?.lessons || [], lessonId);
            
            if (userLessonPerm) {
              hasView = userLessonPerm.view_lesson || userLessonPerm.view_plan || userLessonPerm.view || false;
              hasEdit = userLessonPerm.edit || false;
            } else {
              hasView = userModulePerm?.view_lesson || userModulePerm?.view_plan || userModulePerm?.view || false;
              hasEdit = userModulePerm?.edit || false;
            }
          }
        } else {
          if (tag.inheritFromGroup) {
            hasView = groupView;
            hasEdit = groupEdit;
          } else {
            const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
            const tagLessonPerm = this._findLessonPermission(tagModulePerm?.lessons || [], lessonId);
            
            if (tagLessonPerm) {
              hasView = tagLessonPerm.view_lesson || tagLessonPerm.view_plan || tagLessonPerm.view || false;
              hasEdit = tagLessonPerm.edit || false;
            } else {
              hasView = tagModulePerm?.view_lesson || tagModulePerm?.view_plan || tagModulePerm?.view || false;
              hasEdit = tagModulePerm?.edit || false;
            }
          }
        }
        
        break;
      }

      if (userTagIds.length === 0) {
        hasView = groupView;
        hasEdit = groupEdit;
      }

      return { hasView, hasEdit };
    } catch (error) {
      logger.error('获取用户课程权限失败:', error);
      return { hasView: false, hasEdit: false };
    }
  }

  /**
   * 获取用户有权限访问的所有模块ID列表（三级权限完整支持）
   */
  static async getUserAuthorizedModuleIds(userId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return [];
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return [];
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return [];
      }

      const moduleIds = new Set();

      // 1. 收集组级权限的模块（三级权限支持）
      const groupPerms = config.modulePermissions || [];
      const groupModuleIds = new Set();
      groupPerms.forEach(perm => {
        if (perm.view_lesson || perm.view_plan || perm.edit || perm.view || this._hasAnyLessonPermission(perm)) {
          groupModuleIds.add(perm.moduleId);
        }
      });

      // 2. 根据用户标签确定最终权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);
      
      let foundUserConfig = false;

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (userConfig) {
          foundUserConfig = true;
          
          if (userConfig.inheritFromTag) {
            if (tag.inheritFromGroup) {
              groupModuleIds.forEach(id => moduleIds.add(id));
            } else {
              const tagPerms = tag.modulePermissions || [];
              tagPerms.forEach(perm => {
                if (perm.view_lesson || perm.view_plan || perm.edit || perm.view || this._hasAnyLessonPermission(perm)) {
                  moduleIds.add(perm.moduleId);
                }
              });
            }
          } else {
            // 【核心修复】用户自定义权限 - 支持三级权限字段
            const userPerms = userConfig.modulePermissions || [];
            userPerms.forEach(perm => {
              if (perm.view_lesson || perm.view_plan || perm.edit || perm.view || this._hasAnyLessonPermission(perm)) {
                moduleIds.add(perm.moduleId);
              }
            });
          }
        } else {
          if (tag.inheritFromGroup) {
            groupModuleIds.forEach(id => moduleIds.add(id));
          } else {
            const tagPerms = tag.modulePermissions || [];
            tagPerms.forEach(perm => {
              if (perm.view_lesson || perm.view_plan || perm.edit || perm.view || this._hasAnyLessonPermission(perm)) {
                moduleIds.add(perm.moduleId);
              }
            });
          }
        }
        
        break;
      }

      if (userTagIds.length === 0 && !foundUserConfig) {
        groupModuleIds.forEach(id => moduleIds.add(id));
      }

      const result = Array.from(moduleIds);
      
      logger.info('用户授权模块列表', {
        userId,
        userGroupId,
        totalModules: result.length,
        moduleIds: result,
        userTags: userTags.map(t => ({ id: t.id, name: t.name }))
      });

      return result;
    } catch (error) {
      logger.error('获取用户授权模块ID失败:', error);
      return [];
    }
  }

  /**
   * 获取用户对指定模块有权限的课程ID列表（三级权限完整支持）
   */
  static async getUserAuthorizedLessonIds(userId, moduleId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return [];
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return [];
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return [];
      }

      let hasModulePermission = false;
      const authorizedLessonIds = new Set();
      const deniedLessonIds = new Set();

      // 1. 组级权限（三级权限支持）
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      const groupHasModulePermission = groupModulePerm?.view_lesson || groupModulePerm?.view_plan || groupModulePerm?.edit || groupModulePerm?.view || false;
      
      if (groupModulePerm) {
        (groupModulePerm.lessons || []).forEach(lesson => {
          if (lesson.view_lesson === false && lesson.view_plan === false && lesson.edit === false && lesson.view === false) {
            deniedLessonIds.add(lesson.lessonId);
          } else if (lesson.view_lesson || lesson.view_plan || lesson.edit || lesson.view) {
            authorizedLessonIds.add(lesson.lessonId);
          }
        });
      }

      // 2. 标签和用户权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        authorizedLessonIds.clear();
        deniedLessonIds.clear();

        if (userConfig) {
          if (userConfig.inheritFromTag) {
            if (tag.inheritFromGroup) {
              hasModulePermission = groupHasModulePermission;
              
              if (groupModulePerm) {
                (groupModulePerm.lessons || []).forEach(lesson => {
                  if (lesson.view_lesson === false && lesson.view_plan === false && lesson.edit === false && lesson.view === false) {
                    deniedLessonIds.add(lesson.lessonId);
                  } else if (lesson.view_lesson || lesson.view_plan || lesson.edit || lesson.view) {
                    authorizedLessonIds.add(lesson.lessonId);
                  }
                });
              }
            } else {
              const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
              if (tagModulePerm) {
                hasModulePermission = tagModulePerm.view_lesson || tagModulePerm.view_plan || tagModulePerm.edit || tagModulePerm.view || false;
                
                (tagModulePerm.lessons || []).forEach(lesson => {
                  if (lesson.view_lesson === false && lesson.view_plan === false && lesson.edit === false && lesson.view === false) {
                    deniedLessonIds.add(lesson.lessonId);
                  } else if (lesson.view_lesson || lesson.view_plan || lesson.edit || lesson.view) {
                    authorizedLessonIds.add(lesson.lessonId);
                  }
                });
              }
            }
          } else {
            const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
            if (userModulePerm) {
              hasModulePermission = userModulePerm.view_lesson || userModulePerm.view_plan || userModulePerm.edit || userModulePerm.view || false;
              
              (userModulePerm.lessons || []).forEach(lesson => {
                if (lesson.view_lesson === false && lesson.view_plan === false && lesson.edit === false && lesson.view === false) {
                  deniedLessonIds.add(lesson.lessonId);
                } else if (lesson.view_lesson || lesson.view_plan || lesson.edit || lesson.view) {
                  authorizedLessonIds.add(lesson.lessonId);
                }
              });
            }
          }
        } else {
          if (tag.inheritFromGroup) {
            hasModulePermission = groupHasModulePermission;
            
            if (groupModulePerm) {
              (groupModulePerm.lessons || []).forEach(lesson => {
                if (lesson.view_lesson === false && lesson.view_plan === false && lesson.edit === false && lesson.view === false) {
                  deniedLessonIds.add(lesson.lessonId);
                } else if (lesson.view_lesson || lesson.view_plan || lesson.edit || lesson.view) {
                  authorizedLessonIds.add(lesson.lessonId);
                }
              });
            }
          } else {
            const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
            if (tagModulePerm) {
              hasModulePermission = tagModulePerm.view_lesson || tagModulePerm.view_plan || tagModulePerm.edit || tagModulePerm.view || false;
              
              (tagModulePerm.lessons || []).forEach(lesson => {
                if (lesson.view_lesson === false && lesson.view_plan === false && lesson.edit === false && lesson.view === false) {
                  deniedLessonIds.add(lesson.lessonId);
                } else if (lesson.view_lesson || lesson.view_plan || lesson.edit || lesson.view) {
                  authorizedLessonIds.add(lesson.lessonId);
                }
              });
            }
          }
        }
        
        break;
      }

      if (userTagIds.length === 0) {
        hasModulePermission = groupHasModulePermission;
        
        if (groupModulePerm) {
          (groupModulePerm.lessons || []).forEach(lesson => {
            if (lesson.view_lesson === false && lesson.view_plan === false && lesson.edit === false && lesson.view === false) {
              deniedLessonIds.add(lesson.lessonId);
            } else if (lesson.view_lesson || lesson.view_plan || lesson.edit || lesson.view) {
              authorizedLessonIds.add(lesson.lessonId);
            }
          });
        }
      }

      if (hasModulePermission) {
        if (deniedLessonIds.size > 0) {
          const result = {
            mode: 'all_except',
            deniedLessonIds: Array.from(deniedLessonIds)
          };
          
          logger.info('用户有模块权限但排除部分课程', {
            userId,
            moduleId,
            deniedLessonIds: result.deniedLessonIds
          });
          
          return result;
        }
        
        return null;
      }
      
      const result = Array.from(authorizedLessonIds);
      
      logger.info('用户课程授权列表', {
        userId,
        moduleId,
        hasModulePermission,
        authorizedCount: result.length,
        deniedCount: deniedLessonIds.size
      });
      
      return result;
    } catch (error) {
      logger.error('获取用户授权课程ID失败:', error);
      return [];
    }
  }

  /**
   * 辅助方法：检查模块权限中是否有任何课程权限（三级权限支持）
   */
  static _hasAnyLessonPermission(modulePerm) {
    if (!modulePerm || !modulePerm.lessons) {
      return false;
    }
    return modulePerm.lessons.some(lesson => 
      lesson.view_lesson === true || 
      lesson.view_plan === true || 
      lesson.edit === true || 
      lesson.view === true
    );
  }

  /**
   * 辅助方法：从权限列表中查找指定模块的权限
   */
  static _findModulePermission(permissions, moduleId) {
    return permissions.find(p => p.moduleId === parseInt(moduleId));
  }

  /**
   * 辅助方法：从课程权限列表中查找指定课程的权限
   */
  static _findLessonPermission(lessons, lessonId) {
    return lessons.find(l => l.lessonId === parseInt(lessonId));
  }

  /**
   * 检查用户是否有模块的任意权限
   */
  static async hasAnyModulePermission(userId, moduleId, userGroupId, userTags = []) {
    const perm = await this.getUserModulePermission(userId, moduleId, userGroupId, userTags);
    return perm.hasView || perm.hasEdit;
  }

  /**
   * 检查用户是否有课程的任意权限
   */
  static async hasAnyLessonPermission(userId, moduleId, lessonId, userGroupId, userTags = []) {
    const perm = await this.getUserLessonPermission(userId, moduleId, lessonId, userGroupId, userTags);
    return perm.hasView || perm.hasEdit;
  }
}

module.exports = GlobalAuthorizationService;
