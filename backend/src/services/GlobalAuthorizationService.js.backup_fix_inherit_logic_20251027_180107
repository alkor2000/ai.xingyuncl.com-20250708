/**
 * 全局授权服务（修复版：支持部分课程授权）
 * 
 * 核心修复：
 * - 支持"模块无权限，但部分课程有权限"的场景
 * - 修复权限计算：如果用户有任何课程权限，模块权限应为 true
 * - 新增：getUserAuthorizedLessonIds - 获取用户授权的课程ID列表
 */

const dbConnection = require('../database/connection');
const logger = require('../utils/logger');

class GlobalAuthorizationService {
  /**
   * 获取用户对模块的权限（修复：考虑课程级权限）
   * @param {number} userId - 用户ID
   * @param {number} moduleId - 模块ID
   * @param {number} userGroupId - 用户所属组ID
   * @param {Array} userTags - 用户标签列表 [{id, name}, ...]
   * @returns {Object} { hasView: boolean, hasEdit: boolean }
   */
  static async getUserModulePermission(userId, moduleId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return { hasView: false, hasEdit: false };
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return { hasView: false, hasEdit: false };
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return { hasView: false, hasEdit: false };
      }

      // 1. 检查组级权限
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      let hasView = groupModulePerm?.view || false;
      let hasEdit = groupModulePerm?.edit || false;
      
      // 检查组级是否有课程权限
      const groupHasAnyLessonPerm = this._hasAnyLessonPermission(groupModulePerm);
      hasView = hasView || groupHasAnyLessonPerm;

      // 2. 检查标签级权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        if (tag.inheritFromGroup) {
          continue;
        }

        const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
        if (tagModulePerm) {
          hasView = tagModulePerm.view || hasView;
          hasEdit = tagModulePerm.edit || hasEdit;
          
          // 检查标签级是否有课程权限
          const tagHasAnyLessonPerm = this._hasAnyLessonPermission(tagModulePerm);
          hasView = hasView || tagHasAnyLessonPerm;
        }
      }

      // 3. 检查用户级权限（最高优先级）
      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (!userConfig) {
          continue;
        }

        if (userConfig.inheritFromTag) {
          continue;
        }

        const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
        if (userModulePerm) {
          // 修复：用户级覆盖，但要考虑课程权限
          const userHasAnyLessonPerm = this._hasAnyLessonPermission(userModulePerm);
          hasView = userModulePerm.view || userHasAnyLessonPerm;
          hasEdit = userModulePerm.edit || false;
        }
      }

      return { hasView, hasEdit };
    } catch (error) {
      logger.error('获取用户模块权限失败:', error);
      return { hasView: false, hasEdit: false };
    }
  }

  /**
   * 获取用户对课程的权限
   */
  static async getUserLessonPermission(userId, moduleId, lessonId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return { hasView: false, hasEdit: false };
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return { hasView: false, hasEdit: false };
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return { hasView: false, hasEdit: false };
      }

      // 1. 组级权限
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      const groupLessonPerm = this._findLessonPermission(groupModulePerm?.lessons || [], lessonId);

      let hasView = groupLessonPerm?.view || groupModulePerm?.view || false;
      let hasEdit = groupLessonPerm?.edit || groupModulePerm?.edit || false;

      // 2. 标签级权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        if (tag.inheritFromGroup) {
          continue;
        }

        const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
        const tagLessonPerm = this._findLessonPermission(tagModulePerm?.lessons || [], lessonId);

        if (tagLessonPerm) {
          hasView = tagLessonPerm.view;
          hasEdit = tagLessonPerm.edit;
        } else if (tagModulePerm) {
          hasView = tagModulePerm.view || hasView;
          hasEdit = tagModulePerm.edit || hasEdit;
        }
      }

      // 3. 用户级权限（最高优先级）
      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (!userConfig || userConfig.inheritFromTag) {
          continue;
        }

        const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
        const userLessonPerm = this._findLessonPermission(userModulePerm?.lessons || [], lessonId);

        if (userLessonPerm) {
          hasView = userLessonPerm.view;
          hasEdit = userLessonPerm.edit;
        } else if (userModulePerm) {
          hasView = userModulePerm.view;
          hasEdit = userModulePerm.edit;
        }
      }

      return { hasView, hasEdit };
    } catch (error) {
      logger.error('获取用户课程权限失败:', error);
      return { hasView: false, hasEdit: false };
    }
  }

  /**
   * 获取用户有权限访问的所有模块ID列表（修复：考虑课程权限）
   */
  static async getUserAuthorizedModuleIds(userId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return [];
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return [];
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return [];
      }

      const moduleIds = new Set();

      // 收集组级权限的模块
      const groupPerms = config.modulePermissions || [];
      groupPerms.forEach(perm => {
        // 修复：如果有模块权限或任何课程权限，都算授权
        if (perm.view || perm.edit || this._hasAnyLessonPermission(perm)) {
          moduleIds.add(perm.moduleId);
        }
      });

      // 收集标签级权限的模块
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      tags.forEach(tag => {
        if (!userTagIds.includes(tag.tagId)) {
          return;
        }

        if (!tag.inheritFromGroup) {
          const tagPerms = tag.modulePermissions || [];
          tagPerms.forEach(perm => {
            if (perm.view || perm.edit || this._hasAnyLessonPermission(perm)) {
              moduleIds.add(perm.moduleId);
            }
          });
        }

        // 收集用户级权限的模块
        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (userConfig && !userConfig.inheritFromTag) {
          const userPerms = userConfig.modulePermissions || [];
          userPerms.forEach(perm => {
            if (perm.view || perm.edit || this._hasAnyLessonPermission(perm)) {
              moduleIds.add(perm.moduleId);
            }
          });
        }
      });

      return Array.from(moduleIds);
    } catch (error) {
      logger.error('获取用户授权模块ID失败:', error);
      return [];
    }
  }

  /**
   * 获取用户对指定模块有权限的课程ID列表（新增）
   */
  static async getUserAuthorizedLessonIds(userId, moduleId, userGroupId, userTags = []) {
    try {
      if (!userGroupId) {
        return [];
      }

      const sql = `
        SELECT config_data 
        FROM teaching_global_authorizations 
        WHERE group_id = ?
      `;

      const { rows } = await dbConnection.query(sql, [userGroupId]);

      if (rows.length === 0) {
        return [];
      }

      let config;
      try {
        config = typeof rows[0].config_data === 'string' 
          ? JSON.parse(rows[0].config_data) 
          : rows[0].config_data;
      } catch (error) {
        logger.error('解析授权配置失败:', error);
        return [];
      }

      const lessonIds = new Set();

      // 1. 收集组级权限的课程
      const groupModulePerm = this._findModulePermission(config.modulePermissions || [], moduleId);
      if (groupModulePerm) {
        // 如果模块有查看权限，所有课程都可见
        if (groupModulePerm.view || groupModulePerm.edit) {
          return null; // null 表示所有课程
        }
        // 否则只收集明确授权的课程
        (groupModulePerm.lessons || []).forEach(lesson => {
          if (lesson.view || lesson.edit) {
            lessonIds.add(lesson.lessonId);
          }
        });
      }

      // 2. 标签级权限
      const tags = config.tags || [];
      const userTagIds = userTags.map(t => t.id);

      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        if (tag.inheritFromGroup) {
          continue;
        }

        const tagModulePerm = this._findModulePermission(tag.modulePermissions || [], moduleId);
        if (tagModulePerm) {
          if (tagModulePerm.view || tagModulePerm.edit) {
            return null; // 所有课程
          }
          (tagModulePerm.lessons || []).forEach(lesson => {
            if (lesson.view || lesson.edit) {
              lessonIds.add(lesson.lessonId);
            }
          });
        }
      }

      // 3. 用户级权限（最高优先级，会覆盖）
      for (const tag of tags) {
        if (!userTagIds.includes(tag.tagId)) {
          continue;
        }

        const users = tag.users || [];
        const userConfig = users.find(u => u.userId === userId);

        if (!userConfig || userConfig.inheritFromTag) {
          continue;
        }

        const userModulePerm = this._findModulePermission(userConfig.modulePermissions || [], moduleId);
        if (userModulePerm) {
          // 用户级会覆盖
          lessonIds.clear();
          
          if (userModulePerm.view || userModulePerm.edit) {
            return null; // 所有课程
          }
          (userModulePerm.lessons || []).forEach(lesson => {
            if (lesson.view || lesson.edit) {
              lessonIds.add(lesson.lessonId);
            }
          });
        }
      }

      return Array.from(lessonIds);
    } catch (error) {
      logger.error('获取用户授权课程ID失败:', error);
      return [];
    }
  }

  /**
   * 辅助方法：检查模块权限中是否有任何课程权限
   */
  static _hasAnyLessonPermission(modulePerm) {
    if (!modulePerm || !modulePerm.lessons) {
      return false;
    }
    return modulePerm.lessons.some(lesson => lesson.view || lesson.edit);
  }

  /**
   * 辅助方法：从权限列表中查找指定模块的权限
   */
  static _findModulePermission(permissions, moduleId) {
    return permissions.find(p => p.moduleId === moduleId);
  }

  /**
   * 辅助方法：从课程权限列表中查找指定课程的权限
   */
  static _findLessonPermission(lessons, lessonId) {
    return lessons.find(l => l.lessonId === lessonId);
  }

  /**
   * 检查用户是否有模块的任意权限
   */
  static async hasAnyModulePermission(userId, moduleId, userGroupId, userTags = []) {
    const perm = await this.getUserModulePermission(userId, moduleId, userGroupId, userTags);
    return perm.hasView || perm.hasEdit;
  }

  /**
   * 检查用户是否有课程的任意权限
   */
  static async hasAnyLessonPermission(userId, moduleId, lessonId, userGroupId, userTags = []) {
    const perm = await this.getUserLessonPermission(userId, moduleId, lessonId, userGroupId, userTags);
    return perm.hasView || perm.hasEdit;
  }
}

module.exports = GlobalAuthorizationService;
