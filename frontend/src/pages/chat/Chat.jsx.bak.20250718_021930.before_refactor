import React, { useState, useEffect, useRef } from 'react'
// 设置全局引用供authStore使用
if (typeof window !== "undefined") {
  window.useChatStore = useChatStore;
}

import {
  Layout,
  Input,
  Button,
  List,
  Card,
  Empty,
  Spin,
  Typography,
  Space,
  Select,
  Drawer,
  Form,
  InputNumber,
  Slider,
  Switch,
  Tag,
  message,
  Modal,
  Tooltip,
  Upload,
  Badge
} from 'antd'
import {
  SendOutlined,
  PlusOutlined,
  MenuOutlined,
  SettingOutlined,
  DeleteOutlined,
  EditOutlined,
  RobotOutlined,
  UserOutlined,
  ClockCircleOutlined,
  MessageOutlined,
  PushpinOutlined,
  PushpinFilled,
  StopOutlined,
  StarOutlined,
  StarFilled,
  InfoCircleOutlined,
  PictureOutlined,
  CloseOutlined
} from '@ant-design/icons'
import { useTranslation } from 'react-i18next'
import { useNavigate } from 'react-router-dom'
import useChatStore from '../../stores/chatStore'
import useAuthStore from '../../stores/authStore'
import MessageList from '../../components/chat/MessageList'
import './Chat.less'

const { Content, Sider } = Layout
const { TextArea } = Input
const { Title, Text, Paragraph } = Typography
const { Option } = Select

const Chat = () => {
  const { t } = useTranslation()
  const navigate = useNavigate()
  const { user } = useAuthStore()
  
  const {
    conversations,
    currentConversation,
    messages,
    aiModels,
    userCredits,
    typing,
    isStreaming,
    conversationsLoading,
    messagesLoading,
    getConversations,
    createConversation,
    selectConversation,
    updateConversation,
    deleteConversation,
    sendMessage,
    stopGeneration,
    getAIModels,
    getUserCredits,
    checkCreditsForModel,
    getModelCredits,
    saveDraft,
    getDraft,
    clearDraft
  } = useChatStore()

  const [inputValue, setInputValue] = useState('')
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false)
  const [showSettings, setShowSettings] = useState(false)
  const [settingsForm] = Form.useForm()
  const [deleteModalVisible, setDeleteModalVisible] = useState(false)
  const [deletingConversationId, setDeletingConversationId] = useState(null)
  const [showNewChatModal, setShowNewChatModal] = useState(false)
  const [newChatForm] = Form.useForm()
  const [uploadedImage, setUploadedImage] = useState(null)
  const [uploading, setUploading] = useState(false)
  
  const messagesEndRef = useRef(null)
  const inputRef = useRef(null)
  const fileInputRef = useRef(null)
  const draftTimerRef = useRef(null)

  // 初始化
  useEffect(() => {
    // 获取会话列表并自动选择第一个
    getConversations(true, true)
    // 获取AI模型列表
    getAIModels()
    // 获取用户积分
    getUserCredits()
  }, [])

  // 恢复草稿
  useEffect(() => {
    if (currentConversation) {
      const draft = getDraft(currentConversation.id)
      if (draft && !inputValue) {
        setInputValue(draft)
      }
    }
  }, [currentConversation?.id])

  // 自动保存草稿
  useEffect(() => {
    if (draftTimerRef.current) {
      clearTimeout(draftTimerRef.current)
    }
    
    if (currentConversation && inputValue.trim()) {
      draftTimerRef.current = setTimeout(() => {
        saveDraft(currentConversation.id, inputValue)
      }, 1000) // 1秒后保存
    }
    
    return () => {
      if (draftTimerRef.current) {
        clearTimeout(draftTimerRef.current)
      }
    }
  }, [inputValue, currentConversation?.id])

  // 滚动到底部
  useEffect(() => {
    scrollToBottom()
  }, [messages])

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }

  // 创建新对话
  const handleCreateConversation = async (values) => {
    try {
      const conversation = await createConversation({
        title: values.title || 'New Chat',
        model_name: values.model_name,
        system_prompt: values.system_prompt,
        context_length: values.context_length,
        ai_temperature: values.ai_temperature,
        priority: values.priority || 0
      })
      
      setShowNewChatModal(false)
      newChatForm.resetFields()
      message.success(t('chat.conversation.create.success'))
    } catch (error) {
      message.error(t('chat.conversation.create.failed'))
    }
  }

  // 快速创建对话
  const handleQuickCreateConversation = async () => {
    try {
      const defaultModel = aiModels.find(m => m.is_active)?.name || 'gpt-3.5-turbo'
      await createConversation({
        model_name: defaultModel
      })
      message.success(t('chat.conversation.create.success'))
    } catch (error) {
      message.error(t('chat.conversation.create.failed'))
    }
  }

  // 图片上传
  const handleImageUpload = async (file) => {
    // 检查文件大小
    if (file.size > 10 * 1024 * 1024) {
      message.error(t('chat.upload.size.error'))
      return false
    }
    
    // 检查文件类型
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
    if (!allowedTypes.includes(file.type)) {
      message.error(t('chat.upload.type.error'))
      return false
    }
    
    setUploading(true)
    const formData = new FormData()
    formData.append('image', file)
    
    try {
      const response = await fetch('/api/chat/upload-image', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('auth-storage') ? JSON.parse(localStorage.getItem('auth-storage')).state.accessToken : ''}`
        },
        body: formData
      })
      
      const result = await response.json()
      
      if (result.success) {
        setUploadedImage(result.data)
        message.success(t('chat.upload.success'))
      } else {
        message.error(result.message || t('chat.upload.failed'))
      }
    } catch (error) {
      console.error('图片上传失败:', error)
      message.error(t('chat.upload.failed'))
    } finally {
      setUploading(false)
    }
    
    return false // 阻止默认上传
  }

  // 移除已上传的图片
  const handleRemoveImage = () => {
    setUploadedImage(null)
  }

  // 发送消息
  const handleSendMessage = async () => {
    if (!currentConversation) {
      message.warning(t('chat.selectConversation'))
      return
    }

    const trimmedValue = inputValue.trim()
    if (!trimmedValue && !uploadedImage) {
      return
    }

    // 检查积分
    const model = aiModels.find(m => m.name === currentConversation.model_name)
    const requiredCredits = model?.credits_per_chat || 10
    
    if (!checkCreditsForModel(currentConversation.model_name)) {
      Modal.confirm({
        title: t('chat.credits.insufficient.title'),
        content: t('chat.credits.insufficient.content', { 
          required: requiredCredits,
          current: userCredits?.credits_stats?.remaining || 0 
        }),
        okText: t('chat.credits.recharge'),
        cancelText: t('button.cancel'),
        onOk: () => {
          navigate('/profile')
        }
      })
      return
    }

    // 如果有图片但模型不支持
    if (uploadedImage && !model?.image_upload_enabled) {
      message.warning(t('chat.model.noImageSupport'))
      return
    }

    // 清空输入和图片
    setInputValue('')
    setUploadedImage(null)
    
    try {
      await sendMessage(trimmedValue, uploadedImage?.id)
      
      // 消息发送成功后刷新积分
      getUserCredits()
    } catch (error) {
      console.error('发送消息失败:', error)
      message.error(t('chat.send.failed'))
      
      // 恢复输入内容
      setInputValue(trimmedValue)
    }
  }

  // 处理回车发送
  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSendMessage()
    }
  }

  // 停止生成
  const handleStopGeneration = () => {
    stopGeneration()
  }

  // 更新对话设置
  const handleUpdateSettings = async (values) => {
    try {
      await updateConversation(currentConversation.id, values)
      setShowSettings(false)
      message.success(t('chat.conversation.update.success'))
    } catch (error) {
      message.error(t('chat.conversation.update.failed'))
    }
  }

  // 删除对话
  const handleDeleteConversation = async () => {
    try {
      await deleteConversation(deletingConversationId)
      setDeleteModalVisible(false)
      setDeletingConversationId(null)
      message.success(t('chat.conversation.delete.success'))
    } catch (error) {
      message.error(t('chat.conversation.delete.failed'))
    }
  }

  // 编辑对话（用于对话列表的设置按钮）
  const handleEditConversation = (conversation) => {
    settingsForm.setFieldsValue({
      title: conversation.title,
      model_name: conversation.model_name,
      system_prompt: conversation.system_prompt,
      context_length: conversation.context_length,
      ai_temperature: conversation.ai_temperature,
      priority: conversation.priority
    })
    setShowSettings(true)
  }

  // 固定/取消固定对话
  const handleTogglePin = async (conversationId, isPinned) => {
    try {
      await updateConversation(conversationId, { is_pinned: !isPinned })
    } catch (error) {
      message.error(t('chat.conversation.update.failed'))
    }
  }

  // 更新优先级
  const handleUpdatePriority = async (conversationId, priority) => {
    try {
      await updateConversation(conversationId, { priority })
    } catch (error) {
      message.error(t('chat.conversation.update.failed'))
    }
  }

  // 渲染对话列表项
  const renderConversationItem = (conversation) => {
    const isActive = currentConversation?.id === conversation.id
    const model = aiModels.find(m => m.name === conversation.model_name)
    
    return (
      <div
        className={`conversation-item ${isActive ? 'active' : ''}`}
        onClick={() => selectConversation(conversation.id)}
      >
        <div className="conversation-header">
          <div className="conversation-title">
            {conversation.is_pinned && <PushpinFilled className="pin-icon" />}
            {conversation.priority > 0 && (
              <Tag color="gold" size="small">
                <StarFilled /> {conversation.priority}
              </Tag>
            )}
            <span className="title-text">{conversation.title}</span>
          </div>
          <div className="conversation-actions">
            <Tooltip title={t('chat.conversation.settings')}>
              <Button
                type="text"
                size="small"
                icon={<SettingOutlined />}
                onClick={(e) => {
                  e.stopPropagation()
                  handleEditConversation(conversation)
                }}
              />
            </Tooltip>
            <Tooltip title={conversation.is_pinned ? t('chat.conversation.unpin') : t('chat.conversation.pin')}>
              <Button
                type="text"
                size="small"
                icon={conversation.is_pinned ? <PushpinFilled /> : <PushpinOutlined />}
                onClick={(e) => {
                  e.stopPropagation()
                  handleTogglePin(conversation.id, conversation.is_pinned)
                }}
              />
            </Tooltip>
            <Tooltip title={t('button.delete')}>
              <Button
                type="text"
                size="small"
                danger
                icon={<DeleteOutlined />}
                onClick={(e) => {
                  e.stopPropagation()
                  setDeletingConversationId(conversation.id)
                  setDeleteModalVisible(true)
                }}
              />
            </Tooltip>
          </div>
        </div>
        <div className="conversation-meta">
          <Tag size="small" color="blue">{model?.display_name || conversation.model_name}</Tag>
          <Text type="secondary" className="message-count">
            <MessageOutlined /> {conversation.message_count}
          </Text>
        </div>
        {conversation.last_message_at && (
          <div className="conversation-time">
            <ClockCircleOutlined /> {new Date(conversation.last_message_at).toLocaleString()}
          </div>
        )}
      </div>
    )
  }

  return (
    <Layout className="chat-container">
      {/* 侧边栏 - 对话列表 */}
      <Sider
        width={300}
        collapsed={sidebarCollapsed}
        collapsedWidth={0}
        breakpoint="xl"
        onBreakpoint={(broken) => {
          // 只在大屏幕下自动折叠
          if (window.innerWidth > 1600) {
            setSidebarCollapsed(broken)
          }
        }}
        className="chat-sidebar"
        trigger={null}
      >
        
        <div className="conversations-list">
          {conversationsLoading ? (
            <div className="loading-container">
              <Spin tip={t('status.loading')} />
            </div>
          ) : conversations.length === 0 ? (
            <Empty
              image={Empty.PRESENTED_IMAGE_SIMPLE}
              description={t('chat.noConversations')}
            />
          ) : (
            conversations.map(conversation => (
              <div key={conversation.id}>
                {renderConversationItem(conversation)}
              </div>
            ))
          )}
        </div>
        
        {/* 积分显示 */}
        {userCredits && (
          <div className="sidebar-footer">
            <Card size="small" className="credits-card">
              <div className="credits-info">
                <Text strong>{t('chat.credits.title')}</Text>
                <div className="credits-stats">
                  <div className="credits-item">
                    <Text type="secondary">{t('chat.credits.remaining')}:</Text>
                    <Text strong className="credits-value">
                      {userCredits.credits_stats.remaining.toLocaleString()}
                  {userCredits.credits_stats?.isExpired && (
                    <div style={{ color: "#ff4d4f", fontSize: 12, marginTop: 4 }}>
                      <ExclamationCircleOutlined /> 积分已过期
                    </div>
                  )}
                  {userCredits.credits_stats?.remainingDays !== null && userCredits.credits_stats.remainingDays <= 7 && !userCredits.credits_stats.isExpired && (
                    <div style={{ color: "#fa8c16", fontSize: 12, marginTop: 4 }}>
                      <ClockCircleOutlined /> {userCredits.credits_stats.remainingDays}天后过期
                    </div>
                  )}
                    </Text>
                  </div>
                  <div className="credits-item">
                    <Text type="secondary">{t('chat.credits.used')}:</Text>
                    <Text className="credits-value">
                      {userCredits.credits_stats.used.toLocaleString()}
                    </Text>
                  </div>
                </div>
              </div>
            </Card>
          </div>
        )}
      </Sider>

      {/* 主内容区 - 对话界面 */}
      <Layout className="chat-main">
        <Content className="chat-content">
          {!currentConversation ? (
            <div className="no-conversation">
              <Empty
                image={<RobotOutlined style={{ fontSize: 64, color: '#bfbfbf' }} />}
                description={
                  <Space direction="vertical" size="large">
                    <Title level={4}>{t('chat.welcome')}</Title>
                    <Paragraph>{t('chat.selectOrCreate')}</Paragraph>
                    <Button
                      type="primary"
                      size="large"
                      icon={<PlusOutlined />}
                      onClick={handleQuickCreateConversation}
                    >
                      {t('chat.startNewChat')}
                    </Button>
                  </Space>
                }
              />
            </div>
          ) : (
            <>
              {/* 对话头部 */}
              <div className="chat-header">
                <div className="header-left">
                  <Button
                    icon={<MenuOutlined />}
                    onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                    className="menu-button"
                    type="text"
                    size="large"
                  />
                  <Title level={4} className="conversation-title">
                    {currentConversation.title}
                  </Title>
                  <Tag color="blue">{aiModels.find(m => m.name === currentConversation.model_name)?.display_name}</Tag>
                  {aiModels.find(m => m.name === currentConversation.model_name)?.image_upload_enabled && (
                    <Tag color="green" icon={<PictureOutlined />}>{t('chat.supportsImage')}</Tag>
                  )}
                </div>
                <div className="header-right">
                  <Button
                    icon={<PlusOutlined />}
                    onClick={() => setShowNewChatModal(true)}
                  >
                    {t("chat.newConversation")}
                  </Button>
                  <Button
                    type="primary"
                    icon={<SettingOutlined />}
                    onClick={() => {
                      if (currentConversation) {
                        handleEditConversation(currentConversation)
                      }
                    }}
                  >
                    {t("chat.conversation.settings")}
                  </Button>
                </div>
              </div>

              {/* 消息列表 */}
              <div className="messages-container">
                {messagesLoading ? (
                  <div className="loading-container">
                    <Spin size="large" tip={t('status.loading')} />
                  </div>
                ) : (
                  <MessageList
                    messages={messages}
                    currentModel={currentConversation.model_name}
                    typing={typing}
                    isStreaming={isStreaming}
                  />
                )}
                <div ref={messagesEndRef} />
              </div>

              {/* 输入区域 */}
              <div className="input-container">
                {/* 已上传的图片预览 */}
                {uploadedImage && (
                  <div className="uploaded-image-preview">
                    <Badge
                      count={
                        <Button
                          type="text"
                          size="small"
                          icon={<CloseOutlined />}
                          onClick={handleRemoveImage}
                          className="remove-image-btn"
                        />
                      }
                    >
                      <img 
                        src={uploadedImage.url} 
                        alt={uploadedImage.original_name}
                        className="preview-image"
                      />
                    </Badge>
                    <Text size="small" type="secondary">{uploadedImage.original_name}</Text>
                  </div>
                )}
                
                <div className="input-wrapper">
                  <div className="input-actions-left">
                    {/* 图片上传按钮 */}
                    {aiModels.find(m => m.name === currentConversation?.model_name)?.image_upload_enabled && (
                      <Upload
                        beforeUpload={handleImageUpload}
                        showUploadList={false}
                        accept="image/*"
                        disabled={uploading || typing || isStreaming}
                      >
                        <Tooltip title={t('chat.upload.image')}>
                          <Button
                            type="text"
                            icon={<PictureOutlined />}
                            loading={uploading}
                            disabled={typing || isStreaming}
                          />
                        </Tooltip>
                      </Upload>
                    )}
                  </div>
                  
                  <TextArea
                    ref={inputRef}
                    value={inputValue}
                    onChange={(e) => setInputValue(e.target.value)}
                    onKeyDown={handleKeyPress}
                    placeholder={
                      uploadedImage 
                        ? t('chat.input.placeholderWithImage')
                        : t('chat.input.placeholder')
                    }
                    autoSize={{ minRows: 1, maxRows: 6 }}
                    disabled={typing || isStreaming}
                    className="message-input"
                  />
                  
                  <div className="input-actions-right">
                    {isStreaming ? (
                      <Button
                        type="primary"
                        danger
                        icon={<StopOutlined />}
                        onClick={handleStopGeneration}
                      >
                        {t('chat.stop')}
                      </Button>
                    ) : (
                      <Button
                        type="primary"
                        icon={<SendOutlined />}
                        onClick={handleSendMessage}
                        disabled={(!inputValue.trim() && !uploadedImage) || typing}
                        loading={typing}
                      >
                        {t('chat.send')}
                      </Button>
                    )}
                  </div>
                </div>
                
                {/* 积分提示 */}
                <div className="input-tips">
                  <Text type="secondary" size="small">
                    {t('chat.credits.cost', { 
                      cost: getModelCredits(currentConversation?.model_name),
                      remaining: userCredits?.credits_stats?.remaining || 0
                    })}
                  </Text>
                </div>
              </div>
            </>
          )}
        </Content>
      </Layout>

      {/* 对话设置抽屉 */}
      <Drawer
        title={t('chat.conversation.settings')}
        placement="right"
        width={500}
        open={showSettings}
        onClose={() => setShowSettings(false)}
        footer={
          <Space>
            <Button onClick={() => setShowSettings(false)}>
              {t('button.cancel')}
            </Button>
            <Button type="primary" onClick={() => settingsForm.submit()}>
              {t('button.save')}
            </Button>
          </Space>
        }
      >
        <Form
          form={settingsForm}
          layout="vertical"
          onFinish={handleUpdateSettings}
        >
          <Form.Item
            name="title"
            label={t('chat.form.title')}
            rules={[{ required: true, message: t('chat.form.title.required') }]}
          >
            <Input />
          </Form.Item>

          <Form.Item
            name="model_name"
            label={t('chat.form.model')}
            rules={[{ required: true, message: t('chat.form.model.required') }]}
          >
            <Select>
              {aiModels.filter(m => m.is_active).map(model => (
                <Option key={model.name} value={model.name}>
                  <Space>
                    {model.display_name}
                    <Tag color="blue" size="small">{model.credits_per_chat}{t('unit.credits')}</Tag>
                    {model.stream_enabled && <Tag color="processing" size="small">{t('chat.stream')}</Tag>}
                    {model.image_upload_enabled && <Tag color="success" size="small">{t('chat.image')}</Tag>}
                  </Space>
                </Option>
              ))}
            </Select>
          </Form.Item>

          <Form.Item
            name="system_prompt"
            label={t('chat.form.systemPrompt')}
          >
            <TextArea rows={4} placeholder={t('chat.form.systemPrompt.placeholder')} />
          </Form.Item>

          <Form.Item
            name="context_length"
            label={
              <Space>
                {t('chat.form.contextLength')}
                <Tooltip title={t('chat.form.contextLength.tooltip')}>
                  <InfoCircleOutlined />
                </Tooltip>
              </Space>
            }
          >
            <InputNumber min={0} max={100} style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item
            name="ai_temperature"
            label={
              <Space>
                {t('chat.form.temperature')}
                <Tooltip title={t('chat.form.temperature.tooltip')}>
                  <InfoCircleOutlined />
                </Tooltip>
              </Space>
            }
          >
            <Slider
              min={0}
              max={1}
              step={0.1}
              marks={{
                0: t('chat.form.temperature.precise'),
                0.5: t('chat.form.temperature.balanced'),
                1: t('chat.form.temperature.creative')
              }}
            />
          </Form.Item>

          <Form.Item
            name="priority"
            label={
              <Space>
                {t('chat.form.priority')}
                <Tooltip title={t('chat.form.priority.tooltip')}>
                  <InfoCircleOutlined />
                </Tooltip>
              </Space>
            }
          >
            <InputNumber min={0} max={10} style={{ width: '100%' }} />
          </Form.Item>
        </Form>
      </Drawer>

      {/* 删除确认弹窗 */}
      <Modal
        title={t('chat.conversation.delete.title')}
        open={deleteModalVisible}
        onOk={handleDeleteConversation}
        onCancel={() => {
          setDeleteModalVisible(false)
          setDeletingConversationId(null)
        }}
        okText={t('button.confirm')}
        cancelText={t('button.cancel')}
        okButtonProps={{ danger: true }}
      >
        <p>{t('chat.conversation.delete.confirm')}</p>
      </Modal>

      {/* 新建对话弹窗 */}
      <Modal
        title={t('chat.newConversation')}
        open={showNewChatModal}
        onCancel={() => {
          setShowNewChatModal(false)
          newChatForm.resetFields()
        }}
        footer={null}
        width={600}
      >
        <Form
          form={newChatForm}
          layout="vertical"
          onFinish={handleCreateConversation}
          initialValues={{
            model_name: aiModels.find(m => m.is_active)?.name,
            context_length: 20,
            ai_temperature: 0.7,
            priority: 0
          }}
        >
          <Form.Item
            name="title"
            label={t('chat.form.title')}
          >
            <Input placeholder={t('chat.form.title.placeholder')} />
          </Form.Item>

          <Form.Item
            name="model_name"
            label={t('chat.form.model')}
            rules={[{ required: true, message: t('chat.form.model.required') }]}
          >
            <Select>
              {aiModels.filter(m => m.is_active).map(model => (
                <Option key={model.name} value={model.name}>
                  <Space>
                    {model.display_name}
                    <Tag color="blue" size="small">{model.credits_per_chat}{t('unit.credits')}</Tag>
                    {model.stream_enabled && <Tag color="processing" size="small">{t('chat.stream')}</Tag>}
                    {model.image_upload_enabled && <Tag color="success" size="small">{t('chat.image')}</Tag>}
                  </Space>
                </Option>
              ))}
            </Select>
          </Form.Item>

          <Form.Item
            name="system_prompt"
            label={t('chat.form.systemPrompt')}
          >
            <TextArea rows={3} placeholder={t('chat.form.systemPrompt.placeholder')} />
          </Form.Item>

          <Form.Item
            name="context_length"
            label={t('chat.form.contextLength')}
          >
            <InputNumber min={0} max={100} style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item
            name="ai_temperature"
            label={t('chat.form.temperature')}
          >
            <Slider
              min={0}
              max={1}
              step={0.1}
              marks={{
                0: t('chat.form.temperature.precise'),
                0.5: t('chat.form.temperature.balanced'),
                1: t('chat.form.temperature.creative')
              }}
            />
          </Form.Item>

          <Form.Item
            name="priority"
            label={t('chat.form.priority')}
          >
            <InputNumber min={0} max={10} style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                {t('button.create')}
              </Button>
              <Button onClick={() => {
                setShowNewChatModal(false)
                newChatForm.resetFields()
              }}>
                {t('button.cancel')}
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </Layout>
  )
}

export default Chat
