import React, { useEffect, useState, useRef } from 'react'
import { 
  Layout, 
  Card, 
  Input, 
  Button, 
  Typography, 
  Space, 
  Avatar,
  Modal,
  Form,
  Select,
  message,
  Spin,
  Empty,
  Tag,
  Alert,
  InputNumber,
  Tooltip
} from 'antd'
import {
  SendOutlined,
  RobotOutlined,
  UserOutlined,
  ExclamationCircleOutlined,
  HistoryOutlined,
  InfoCircleOutlined,
  FireOutlined,
  PlusOutlined,
  LoadingOutlined,
  StopOutlined
} from '@ant-design/icons'
import useChatStore from '../../stores/chatStore'
import useAuthStore from '../../stores/authStore'
import MessageContent from '../../components/chat/MessageContent'
import ConversationList from '../../components/chat/ConversationList'

const { Sider, Content } = Layout
const { Title, Text } = Typography
const { TextArea } = Input

const Chat = () => {
  const { user } = useAuthStore()
  const {
    conversations,
    conversationsLoading,
    currentConversationId,
    currentConversation,
    messages,
    messagesLoading,
    aiModels,
    userCredits,
    typing,
    creditsLoading,
    streamingMessageId,
    isStreaming,
    getConversations,
    createConversation,
    selectConversation,
    sendMessage,
    stopStreaming,
    updateConversation,
    deleteConversation,
    getAIModels,
    getUserCredits,
    checkCreditsForModel,
    getModelCredits
  } = useChatStore()

  const [messageInput, setMessageInput] = useState('')
  const [isModalVisible, setIsModalVisible] = useState(false)
  const [form] = Form.useForm()
  const [editingConversation, setEditingConversation] = useState(null)
  
  // åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†çŠ¶æ€
  const [deleteModalVisible, setDeleteModalVisible] = useState(false)
  const [conversationToDelete, setConversationToDelete] = useState(null)
  const [deleting, setDeleting] = useState(false)
  
  // æ¶ˆæ¯åˆ—è¡¨è‡ªåŠ¨æ»šåŠ¨å¼•ç”¨
  const messagesEndRef = useRef(null)

  // ğŸ”¥ ç»„ä»¶åŠ è½½æ—¶è·å–æ•°æ® - ä¼˜åŒ–åŠ è½½ç­–ç•¥
  useEffect(() => {
    // ç«‹å³åŠ è½½å¯¹è¯åˆ—è¡¨å’ŒAIæ¨¡å‹ï¼Œç§¯åˆ†æŒ‰éœ€è·å–
    getConversations()
    getAIModels()
  }, [])

  // è‡ªåŠ¨æ»šåŠ¨åˆ°æ¶ˆæ¯åº•éƒ¨
  useEffect(() => {
    scrollToBottom()
  }, [messages, typing])

  const scrollToBottom = () => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ 
        behavior: 'smooth',
        block: 'end'
      })
    }
  }

  // ğŸ”¥ é€‰æ‹©ä¼šè¯å¤„ç† - ç®€åŒ–é€»è¾‘
  const handleSelectConversation = (conversationId) => {
    selectConversation(conversationId)
  }

  // åˆ›å»ºæ–°ä¼šè¯ - ä¿ç•™ç§¯åˆ†æ£€æŸ¥ä½†ä¸æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
  const handleCreateConversation = async (values) => {
    try {
      // é™é»˜æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
      if (!checkCreditsForModel(values.model_name)) {
        // æ­¤æ—¶è·å–ä¸€æ¬¡ç§¯åˆ†çŠ¶æ€ç”¨äºé”™è¯¯æç¤º
        await getUserCredits()
        const requiredCredits = getModelCredits(values.model_name)
        message.error(`ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºä¼šè¯`)
        return
      }

      await createConversation({
        title: values.title || 'New Chat',
        model_name: values.model_name || 'gpt-3.5-turbo',
        system_prompt: values.system_prompt,
        context_length: values.context_length || 20,
        ai_temperature: parseFloat(values.ai_temperature) || 0.0
      })
      setIsModalVisible(false)
      form.resetFields()
      message.success('ä¼šè¯åˆ›å»ºæˆåŠŸ')
    } catch (error) {
      message.error(error.response?.data?.message || 'ä¼šè¯åˆ›å»ºå¤±è´¥')
    }
  }

  // å‘é€æ¶ˆæ¯ - è‡ªåŠ¨å¤„ç†æµå¼/éæµå¼
  const handleSendMessage = async () => {
    if (!messageInput.trim() || !currentConversation) {
      return
    }

    // é™é»˜æ£€æŸ¥ç§¯åˆ†æ˜¯å¦å……è¶³
    if (!checkCreditsForModel(currentConversation.model_name)) {
      message.error('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å‘é€æ¶ˆæ¯')
      return
    }

    try {
      // sendMessageæ–¹æ³•ä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æµå¼
      await sendMessage(messageInput.trim())
      setMessageInput('')
      
      // éæµå¼æ—¶æ˜¾ç¤ºæˆåŠŸæç¤º
      const model = aiModels.find(m => m.name === currentConversation.model_name)
      if (!model?.stream_enabled) {
        message.success('æ¶ˆæ¯å‘é€æˆåŠŸï¼')
      }
      
      // å‘é€åç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨
      setTimeout(scrollToBottom, 100)
    } catch (error) {
      const errorMessage = error.response?.data?.message || error.message || 'æ¶ˆæ¯å‘é€å¤±è´¥'
      message.error(errorMessage)
      
      // å¦‚æœæ˜¯ç§¯åˆ†ç›¸å…³é”™è¯¯ï¼Œé™é»˜åˆ·æ–°ç§¯åˆ†çŠ¶æ€
      if (errorMessage.includes('ç§¯åˆ†')) {
        getUserCredits()
      }
    }
  }

  // åœæ­¢æµå¼ä¼ è¾“
  const handleStopStreaming = () => {
    stopStreaming()
    message.info('å·²åœæ­¢ç”Ÿæˆ')
  }

  // å¤„ç†Enteré”®å‘é€
  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      if (e.shiftKey) {
        return
      } else {
        e.preventDefault()
        if (!isStreaming) {
          handleSendMessage()
        }
      }
    }
  }

  // ç¼–è¾‘ä¼šè¯
  const handleEditConversation = (conversation) => {
    setEditingConversation(conversation)
    form.setFieldsValue({
      title: conversation.title,
      model_name: conversation.model_name,
      system_prompt: conversation.system_prompt,
      context_length: conversation.context_length || 20,
      ai_temperature: conversation.ai_temperature !== undefined ? conversation.ai_temperature : 0.0
    })
    setIsModalVisible(true)
  }

  // æ›´æ–°ä¼šè¯
  const handleUpdateConversation = async (values) => {
    try {
      // ç¡®ä¿ai_temperatureæ˜¯æ•°å­—ç±»å‹
      const updateData = {
        ...values,
        ai_temperature: parseFloat(values.ai_temperature) || 0.0
      }
      
      await updateConversation(editingConversation.id, updateData)
      setIsModalVisible(false)
      setEditingConversation(null)
      form.resetFields()
      message.success('ä¼šè¯è®¾ç½®æ›´æ–°æˆåŠŸ')
    } catch (error) {
      message.error('ä¼šè¯è®¾ç½®æ›´æ–°å¤±è´¥')
    }
  }

  // åˆ é™¤ä¼šè¯
  const handleDeleteConversation = (conversationId) => {
    const targetConversation = conversations.find(c => c.id === conversationId)
    setConversationToDelete(targetConversation)
    setDeleteModalVisible(true)
  }

  // ç¡®è®¤åˆ é™¤ä¼šè¯
  const confirmDeleteConversation = async () => {
    if (!conversationToDelete) return
    
    try {
      setDeleting(true)
      await deleteConversation(conversationToDelete.id)
      
      setDeleteModalVisible(false)
      setConversationToDelete(null)
      setDeleting(false)
      message.success('ä¼šè¯åˆ é™¤æˆåŠŸ')
      
    } catch (error) {
      console.error('âŒ åˆ é™¤æ“ä½œå¤±è´¥:', error)
      setDeleting(false)
      message.error(`ä¼šè¯åˆ é™¤å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // å–æ¶ˆåˆ é™¤
  const cancelDeleteConversation = () => {
    setDeleteModalVisible(false)
    setConversationToDelete(null)
  }

  // åˆ›å»ºæ–°å¯¹è¯å¤„ç†
  const handleCreateNew = () => {
    setEditingConversation(null)
    form.resetFields()
    setIsModalVisible(true)
  }

  // æ¸²æŸ“æ¶ˆæ¯
  const renderMessage = (msg) => {
    const isStreamingMsg = msg.id === streamingMessageId || msg.streaming
    
    return (
      <div 
        key={msg.id} 
        style={{ 
          display: 'flex', 
          marginBottom: 16,
          justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start'
        }}
      >
        {msg.role === 'assistant' && (
          <Avatar 
            icon={<RobotOutlined />} 
            style={{ 
              backgroundColor: '#1677ff',
              marginRight: 8,
              alignSelf: 'flex-start'
            }} 
          />
        )}
        
        <Card
          size="small"
          style={{
            maxWidth: '70%',
            backgroundColor: msg.role === 'user' ? '#1677ff' : '#f6f6f6',
            color: msg.role === 'user' ? 'white' : 'inherit'
          }}
          bodyStyle={{ padding: '12px 16px' }}
        >
          <MessageContent content={msg.content} role={msg.role} isStreaming={isStreamingMsg && isStreaming} />
          
          {/* æµå¼åŠ è½½æŒ‡ç¤ºå™¨ */}
          {isStreamingMsg && isStreaming && (
            <div style={{ marginTop: 8 }}>
              <LoadingOutlined style={{ marginRight: 4 }} />
              <Text type="secondary" style={{ fontSize: 12 }}>
                ç”Ÿæˆä¸­...
              </Text>
            </div>
          )}
          
          {msg.tokens > 0 && !isStreamingMsg && (
            <div style={{ 
              fontSize: 11, 
              marginTop: 8, 
              opacity: 0.7,
              textAlign: 'right'
            }}>
              {msg.tokens} tokens
            </div>
          )}
        </Card>
        
        {msg.role === 'user' && (
          <Avatar 
            icon={<UserOutlined />} 
            style={{ 
              backgroundColor: '#52c41a',
              marginLeft: 8,
              alignSelf: 'flex-start'
            }} 
          />
        )}
      </div>
    )
  }

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘é€æ¶ˆæ¯
  const canSendMessage = () => {
    if (!currentConversation || !messageInput.trim() || typing || isStreaming) return false
    return checkCreditsForModel(currentConversation.model_name)
  }

  // è·å–temperatureæ ‡ç­¾é¢œè‰²
  const getTemperatureTagColor = (temp) => {
    if (temp === 0) return 'purple'
    if (temp <= 0.3) return 'blue'
    if (temp <= 0.7) return 'cyan'
    return 'volcano'
  }

  // è·å–temperatureæè¿°
  const getTemperatureDesc = (temp) => {
    if (temp === 0) return 'ä¸¥æ ¼æ¨¡å¼'
    if (temp <= 0.3) return 'ç²¾å‡†æ¨¡å¼'
    if (temp <= 0.7) return 'å¹³è¡¡æ¨¡å¼'
    return 'åˆ›æ„æ¨¡å¼'
  }

  // è‡ªå®šä¹‰TemperatureéªŒè¯å‡½æ•°
  const validateTemperature = (_, value) => {
    if (value === '' || value === null || value === undefined) {
      return Promise.reject(new Error('è¯·è®¾ç½®Temperatureå‚æ•°'))
    }
    
    const numValue = parseFloat(value)
    if (isNaN(numValue)) {
      return Promise.reject(new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—'))
    }
    
    if (numValue < 0 || numValue > 1) {
      return Promise.reject(new Error('èŒƒå›´ï¼š0-1'))
    }
    
    return Promise.resolve()
  }

  // è·å–å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒæµå¼
  const isStreamEnabled = () => {
    if (!currentConversation) return false
    const model = aiModels.find(m => m.name === currentConversation.model_name)
    return model?.stream_enabled === true
  }

  return (
    <Layout className="chat-layout">
      {/* ğŸ”¥ ä¾§è¾¹æ  - ä½¿ç”¨ç‹¬ç«‹ç»„ä»¶ï¼ŒçŠ¶æ€å®Œå…¨éš”ç¦» */}
      <Sider width={350}>
        <ConversationList 
          conversations={conversations}
          conversationsLoading={conversationsLoading}
          currentConversationId={currentConversationId}
          onSelectConversation={handleSelectConversation}
          onEditConversation={handleEditConversation}
          onDeleteConversation={handleDeleteConversation}
          onCreateConversation={handleCreateNew}
          getModelCredits={getModelCredits}
        />
      </Sider>

      {/* ğŸ”¥ èŠå¤©åŒºåŸŸ - æ–°çš„ç®€æ´åŠ è½½çŠ¶æ€ */}
      <Content className="chat-main">
        {messagesLoading ? (
          <div style={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            height: '100%',
            flexDirection: 'column',
            gap: '16px'
          }}>
            <Spin size="large" tip="åŠ è½½å¯¹è¯ä¸­..." />
            <Text type="secondary">æ­£åœ¨è·å–æ¶ˆæ¯å†å²...</Text>
          </div>
        ) : currentConversation ? (
          <>
            {/* ä¼šè¯å¤´éƒ¨ - å›ºå®šåœ¨é¡¶éƒ¨ï¼Œç®€åŒ–æ˜¾ç¤º */}
            <div className="chat-header">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <Title level={4} style={{ margin: 0 }}>
                    {currentConversation.title}
                  </Title>
                  <Space>
                    <Text type="secondary">
                      {currentConversation.model_name} â€¢ {messages.length} æ¡æ¶ˆæ¯
                    </Text>
                    {isStreamEnabled() && (
                      <Tag color="green" icon={<LoadingOutlined />}>
                        æµå¼è¾“å‡º
                      </Tag>
                    )}
                    <Tooltip title="å½“å‰å¯¹è¯æºå¸¦çš„ä¸Šä¸‹æ–‡æ•°é‡ï¼Œå½±å“AIçš„è®°å¿†é•¿åº¦">
                      <Tag color="cyan" icon={<HistoryOutlined />}>
                        ä¸Šä¸‹æ–‡ {currentConversation.context_length || 20} æ¡
                      </Tag>
                    </Tooltip>
                    <Tooltip title="AIåˆ›é€ æ€§å‚æ•°ï¼š0=ä¸¥æ ¼ï¼Œ0.3=ç²¾å‡†ï¼Œ0.7=å¹³è¡¡ï¼Œ1.0=æœ€åˆ›æ„">
                      <Tag 
                        color={getTemperatureTagColor(currentConversation.ai_temperature || 0.0)} 
                        icon={<FireOutlined />}
                      >
                        {getTemperatureDesc(currentConversation.ai_temperature || 0.0)} {currentConversation.ai_temperature || 0.0}
                      </Tag>
                    </Tooltip>
                  </Space>
                </div>
              </div>
            </div>

            {/* æ¶ˆæ¯åˆ—è¡¨ - å›ºå®šå¯æ»šåŠ¨åŒºåŸŸ */}
            <div className="chat-messages">
              <div className="chat-messages-content">
                {messages.length === 0 ? (
                  <div className="chat-empty">
                    <Empty 
                      description="å¼€å§‹æ–°çš„å¯¹è¯å§"
                      image={Empty.PRESENTED_IMAGE_SIMPLE}
                    />
                  </div>
                ) : (
                  <div className="chat-messages-list">
                    {messages.map(renderMessage)}
                    {typing && !isStreaming && (
                      <div style={{ textAlign: 'left', marginTop: 16 }}>
                        <Spin size="small" />
                        <span style={{ marginLeft: 8, color: '#999' }}>
                          AI æ­£åœ¨æ€è€ƒ...
                        </span>
                      </div>
                    )}
                    <div ref={messagesEndRef} />
                  </div>
                )}
              </div>
            </div>

            {/* è¾“å…¥æ¡† - å›ºå®šåœ¨åº•éƒ¨ */}
            <div className="chat-input">
              {/* ç§¯åˆ†ä¸è¶³è­¦å‘Š - ç®€åŒ–æ˜¾ç¤º*/}
              {currentConversation && !checkCreditsForModel(currentConversation.model_name) && (
                <Alert
                  message="ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å‘é€æ¶ˆæ¯"
                  type="error"
                  showIcon
                  style={{ marginBottom: 12 }}
                  action={
                    <Button size="small" type="primary" ghost>
                      è”ç³»ç®¡ç†å‘˜
                    </Button>
                  }
                />
              )}

              <div className="chat-input-container">
                <TextArea
                  value={messageInput}
                  onChange={(e) => setMessageInput(e.target.value)}
                  placeholder="è¾“å…¥æ¶ˆæ¯... (Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ)"
                  autoSize={{ minRows: 3, maxRows: 8 }}
                  onKeyDown={handleKeyPress}
                  disabled={typing}
                  className="chat-input-textarea"
                />
                {isStreaming ? (
                  <Button 
                    type="primary"
                    danger
                    icon={<StopOutlined />}
                    onClick={handleStopStreaming}
                    className="chat-input-send-button"
                  >
                    åœæ­¢
                  </Button>
                ) : (
                  <Button 
                    type="primary" 
                    icon={<SendOutlined />}
                    loading={typing}
                    onClick={handleSendMessage}
                    disabled={!canSendMessage()}
                    className="chat-input-send-button"
                  >
                    å‘é€
                  </Button>
                )}
              </div>
              
              {/* è¾“å…¥æç¤º - è¿›ä¸€æ­¥ç®€åŒ– */}
              <div className="chat-input-tip">
                <span>Enter å‘é€ â€¢ Shift + Enter æ¢è¡Œ â€¢ æ”¯æŒå¤šè¡Œè¾“å…¥</span>
                {currentConversation && (
                  <span>
                    {isStreamEnabled() ? 'æµå¼è¾“å‡ºå·²å¯ç”¨' : 'æ ‡å‡†è¾“å‡ºæ¨¡å¼'} â€¢ 
                    ä¸Šä¸‹æ–‡: {currentConversation.context_length || 20} æ¡ â€¢ 
                    {getTemperatureDesc(currentConversation.ai_temperature || 0.0)}: {currentConversation.ai_temperature || 0.0}
                  </span>
                )}
              </div>
            </div>
          </>
        ) : (
          <div className="chat-empty-state">
            <Empty 
              description="é€‰æ‹©ä¸€ä¸ªå¯¹è¯å¼€å§‹èŠå¤©"
              image={Empty.PRESENTED_IMAGE_SIMPLE}
            />
            <Button 
              type="primary" 
              icon={<PlusOutlined />}
              style={{ marginTop: 16 }}
              onClick={handleCreateNew}
            >
              åˆ›å»ºæ–°å¯¹è¯
            </Button>
          </div>
        )}
      </Content>

      {/* ğŸ”¥ ä¼šè¯è®¾ç½®å¯¹è¯æ¡† - ä¿®å¤TemperatureéªŒè¯ */}
      <Modal
        title={editingConversation ? 'ä¼šè¯è®¾ç½®' : 'åˆ›å»ºæ–°ä¼šè¯'}
        open={isModalVisible}
        onCancel={() => {
          setIsModalVisible(false)
          setEditingConversation(null)
          form.resetFields()
        }}
        footer={null}
        width={600}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={editingConversation ? handleUpdateConversation : handleCreateConversation}
          initialValues={{
            context_length: 20,
            ai_temperature: 0.0
          }}
        >
          <Form.Item
            name="title"
            label="ä¼šè¯æ ‡é¢˜"
            rules={[{ required: true, message: 'è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜' }]}
          >
            <Input placeholder="è¾“å…¥ä¼šè¯æ ‡é¢˜" />
          </Form.Item>

          <Form.Item
            name="model_name"
            label="AIæ¨¡å‹"
            rules={[{ required: true, message: 'è¯·é€‰æ‹©AIæ¨¡å‹' }]}
          >
            <Select placeholder="é€‰æ‹©AIæ¨¡å‹">
              {aiModels.map(model => (
                <Select.Option key={model.name} value={model.name}>
                  <Space>
                    <span>{model.display_name}</span>
                    {model.stream_enabled && (
                      <Tag color="green" size="small">æµå¼</Tag>
                    )}
                  </Space>
                </Select.Option>
              ))}
            </Select>
          </Form.Item>

          {/* ğŸ”¥ ç®€åŒ–ä¸Šä¸‹æ–‡æ•°é‡è®¾ç½® - ä¿®æ”¹å¤‡æ³¨ä¿¡æ¯ */}
          <Form.Item
            name="context_length"
            label={
              <Space>
                <span>ä¸Šä¸‹æ–‡æ•°é‡</span>
                <Tooltip title="è®¾ç½®AIå¯¹è¯æ—¶æºå¸¦çš„å†å²æ¶ˆæ¯æ•°é‡ï¼Œ1-500è¡¨ç¤ºæºå¸¦å¯¹åº”æ•°é‡çš„å†å²æ¶ˆæ¯">
                  <InfoCircleOutlined style={{ color: '#999' }} />
                </Tooltip>
              </Space>
            }
            rules={[
              { required: true, message: 'è¯·è®¾ç½®ä¸Šä¸‹æ–‡æ•°é‡' },
              { type: 'number', min: 1, max: 500, message: 'èŒƒå›´ï¼š1-500' }
            ]}
            extra="èŒƒå›´ï¼š1-500"
          >
            <InputNumber
              min={1}
              max={500}
              style={{ width: '100%' }}
              placeholder="20"
            />
          </Form.Item>

          {/* ğŸ”¥ ä¿®å¤Temperatureè®¾ç½® - ä½¿ç”¨è‡ªå®šä¹‰éªŒè¯ */}
          <Form.Item
            name="ai_temperature"
            label={
              <Space>
                <FireOutlined style={{ color: '#ff7a00' }} />
                <span>Temperatureå‚æ•°</span>
                <Tooltip title="æ§åˆ¶AIå›å¤çš„åˆ›é€ æ€§å’Œéšæœºæ€§ï¼Œ0=æœ€ä¸¥æ ¼ï¼Œ1=æœ€æœ‰åˆ›æ„">
                  <InfoCircleOutlined style={{ color: '#999' }} />
                </Tooltip>
              </Space>
            }
            rules={[
              { validator: validateTemperature }
            ]}
            extra="èŒƒå›´ï¼š0-1ï¼Œæ¨èï¼šç¿»è¯‘ä»£ç 0ï¼Œæ—¥å¸¸å¯¹è¯0.3ï¼Œåˆ›æ„å†™ä½œ0.7"
          >
            <Input
              placeholder="0.0"
              style={{ width: 200 }}
            />
          </Form.Item>

          <Form.Item
            name="system_prompt"
            label="ç³»ç»Ÿæç¤ºè¯"
          >
            <TextArea 
              placeholder="å¯é€‰ï¼šè®¾ç½®AIçš„è§’è‰²å’Œè¡Œä¸ºæ–¹å¼"
              autoSize={{ minRows: 3, maxRows: 6 }}
            />
          </Form.Item>

          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                {editingConversation ? 'ä¿å­˜è®¾ç½®' : 'åˆ›å»º'}
              </Button>
              <Button onClick={() => {
                setIsModalVisible(false)
                setEditingConversation(null)
                form.resetFields()
              }}>
                å–æ¶ˆ
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>

      {/* åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† */}
      <Modal
        title="åˆ é™¤ä¼šè¯"
        open={deleteModalVisible}
        onOk={confirmDeleteConversation}
        onCancel={cancelDeleteConversation}
        okText="ç¡®è®¤åˆ é™¤"
        cancelText="å–æ¶ˆ"
        okType="danger"
        confirmLoading={deleting}
        centered
      >
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: 16 }}>
          <ExclamationCircleOutlined style={{ color: '#ff4d4f', fontSize: 22, marginRight: 8 }} />
          <span>ç¡®å®šè¦åˆ é™¤ä¼šè¯å—ï¼Ÿ</span>
        </div>
        {conversationToDelete && (
          <div>
            <p><strong>ä¼šè¯æ ‡é¢˜:</strong> {conversationToDelete.title}</p>
            <p><strong>æ¶ˆæ¯æ•°é‡:</strong> {conversationToDelete.message_count} æ¡</p>
            <p><strong>ä¸Šä¸‹æ–‡è®¾ç½®:</strong> {conversationToDelete.context_length || 20} æ¡</p>
            <p style={{ color: '#ff4d4f', marginTop: 16 }}>
              <strong>æ³¨æ„ï¼šæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œæ‰€æœ‰èŠå¤©è®°å½•å°†è¢«æ°¸ä¹…åˆ é™¤ï¼</strong>
            </p>
          </div>
        )}
      </Modal>
    </Layout>
  )
}

export default Chat
