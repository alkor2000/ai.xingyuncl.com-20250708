/**
 * Mermaid 图表预览组件
 * 支持实时渲染各种类型的 Mermaid 图表
 */

import React, { useEffect, useRef, useState } from 'react';
import { message, Spin } from 'antd';
import mermaid from 'mermaid';

const MermaidPreview = ({ code, onError }) => {
  const containerRef = useRef(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const renderTimeoutRef = useRef(null);

  // 初始化 Mermaid 配置
  useEffect(() => {
    mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'loose',
      fontFamily: '-apple-system, BlinkMacSystemFont, sans-serif',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      },
      sequence: {
        useMaxWidth: true,
        wrap: true
      },
      gantt: {
        useMaxWidth: true
      }
    });
  }, []);

  // 渲染 Mermaid 图表
  useEffect(() => {
    if (!code || !containerRef.current) {
      setLoading(false);
      return;
    }

    // 清除之前的渲染超时
    if (renderTimeoutRef.current) {
      clearTimeout(renderTimeoutRef.current);
    }

    // 防抖渲染（500ms）
    renderTimeoutRef.current = setTimeout(async () => {
      try {
        setLoading(true);
        setError(null);

        // 清空容器
        containerRef.current.innerHTML = '';

        // 创建临时div用于渲染
        const id = `mermaid-${Date.now()}`;
        const tempDiv = document.createElement('div');
        tempDiv.id = id;
        tempDiv.innerHTML = code;

        // 渲染图表
        const { svg } = await mermaid.render(id, code);
        
        // 将渲染结果插入到容器
        containerRef.current.innerHTML = svg;

        // 添加样式
        const svgElement = containerRef.current.querySelector('svg');
        if (svgElement) {
          svgElement.style.maxWidth = '100%';
          svgElement.style.height = 'auto';
        }

        setLoading(false);
      } catch (err) {
        console.error('Mermaid 渲染失败:', err);
        setError(err.message || '渲染失败');
        setLoading(false);
        
        if (onError) {
          onError(err);
        }
      }
    }, 500);

    return () => {
      if (renderTimeoutRef.current) {
        clearTimeout(renderTimeoutRef.current);
      }
    };
  }, [code, onError]);

  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        alignItems: 'center', 
        justifyContent: 'center',
        height: '100%',
        minHeight: '400px'
      }}>
        <Spin size="large" tip="渲染图表中..." />
      </div>
    );
  }

  if (error) {
    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '100%',
        minHeight: '400px',
        flexDirection: 'column',
        color: '#ff4d4f'
      }}>
        <div style={{ fontSize: 48, marginBottom: 16 }}>⚠️</div>
        <div style={{ fontSize: 16, marginBottom: 8 }}>图表渲染失败</div>
        <div style={{ fontSize: 14, color: '#999' }}>{error}</div>
      </div>
    );
  }

  return (
    <div 
      ref={containerRef} 
      style={{
        width: '100%',
        height: '100%',
        overflow: 'auto',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px'
      }}
    />
  );
};

export default MermaidPreview;
