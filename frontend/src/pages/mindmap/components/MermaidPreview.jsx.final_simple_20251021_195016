/**
 * Mermaid 图表预览组件
 * 支持实时渲染各种类型的 Mermaid 图表
 */

import React, { useEffect, useRef, useState, useCallback } from 'react';
import { Spin, Empty } from 'antd';
import mermaid from 'mermaid';

const MermaidPreview = ({ code }) => {
  const [container, setContainer] = useState(null);
  const [loading, setLoading] = useState(true);
  const renderTimeoutRef = useRef(null);
  const renderCountRef = useRef(0);

  // 使用回调 ref，确保 DOM 挂载时立即获得引用
  const containerCallbackRef = useCallback((node) => {
    if (node !== null) {
      console.log('Container DOM 已挂载');
      setContainer(node);
    }
  }, []);

  // 初始化 Mermaid 配置（只执行一次）
  useEffect(() => {
    mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'loose',
      fontFamily: 'Arial, sans-serif, "Microsoft YaHei", "微软雅黑"',
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'basis',
        padding: 15
      },
      sequence: {
        useMaxWidth: false,
        wrap: true,
        width: 150
      },
      gantt: {
        useMaxWidth: false,
        fontSize: 12
      },
      logLevel: 'error'
    });
  }, []);

  // 渲染 Mermaid 图表
  useEffect(() => {
    console.log('useEffect 触发:', { hasCode: !!code, hasContainer: !!container });

    // 如果代码为空
    if (!code || code.trim() === '') {
      setLoading(false);
      if (container) {
        container.innerHTML = '';
      }
      return;
    }

    // 如果容器还没准备好，等待
    if (!container) {
      console.log('容器还没准备好，等待下次更新');
      return;
    }

    // 清除之前的渲染超时
    if (renderTimeoutRef.current) {
      clearTimeout(renderTimeoutRef.current);
    }

    // 设置加载状态
    setLoading(true);

    // 防抖渲染（300ms）
    renderTimeoutRef.current = setTimeout(async () => {
      console.log('开始渲染 Mermaid');

      try {
        // 清空容器
        container.innerHTML = '';

        // 生成唯一ID
        renderCountRef.current += 1;
        const id = `mermaid-${Date.now()}-${renderCountRef.current}`;

        // 创建临时容器
        const tempDiv = document.createElement('div');
        tempDiv.id = id;
        tempDiv.style.display = 'none';
        document.body.appendChild(tempDiv);

        try {
          // 渲染图表
          const { svg } = await mermaid.render(id, code);
          
          console.log('Mermaid 渲染成功');

          // 清理临时容器
          if (tempDiv.parentNode) {
            tempDiv.parentNode.removeChild(tempDiv);
          }

          // 插入 SVG
          if (container) {
            container.innerHTML = svg;
            
            // 优化 SVG 显示
            const svgEl = container.querySelector('svg');
            if (svgEl) {
              const w = svgEl.getAttribute('width');
              const h = svgEl.getAttribute('height');
              
              if (w && h && !svgEl.getAttribute('viewBox')) {
                svgEl.setAttribute('viewBox', `0 0 ${w} ${h}`);
              }
              
              svgEl.removeAttribute('width');
              svgEl.removeAttribute('height');
              svgEl.style.width = '100%';
              svgEl.style.height = 'auto';
              svgEl.style.maxWidth = '100%';
              svgEl.style.display = 'block';
              svgEl.style.margin = '0 auto';
            }
          }

          setLoading(false);
        } catch (renderError) {
          // 清理临时容器
          if (tempDiv.parentNode) {
            tempDiv.parentNode.removeChild(tempDiv);
          }
          throw renderError;
        }

      } catch (err) {
        console.error('Mermaid 渲染失败:', err);
        setLoading(false);

        // 显示错误提示
        if (container) {
          container.innerHTML = `
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 400px;
              color: #ff4d4f;
              padding: 20px;
              text-align: center;
            ">
              <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
              <div style="font-size: 16px; margin-bottom: 8px; font-weight: 600;">Mermaid 图表渲染失败</div>
              <div style="font-size: 14px; color: #999; max-width: 500px; word-break: break-word;">
                ${err.message || err.toString()}
              </div>
              <div style="font-size: 12px; color: #999; margin-top: 16px;">
                请检查 Mermaid 语法是否正确
              </div>
            </div>
          `;
        }
      }
    }, 300);

    return () => {
      if (renderTimeoutRef.current) {
        clearTimeout(renderTimeoutRef.current);
      }
    };
  }, [code, container]); // 依赖 container，当它变化时重新渲染

  // 加载中
  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        alignItems: 'center', 
        justifyContent: 'center',
        height: '100%',
        minHeight: '400px'
      }}>
        <Spin size="large" tip="渲染图表中..." />
      </div>
    );
  }

  // 代码为空
  if (!code || code.trim() === '') {
    return (
      <div style={{ 
        display: 'flex', 
        alignItems: 'center', 
        justifyContent: 'center',
        height: '100%',
        minHeight: '400px'
      }}>
        <Empty description="请输入 Mermaid 代码" />
      </div>
    );
  }

  // 渲染容器
  return (
    <div 
      ref={containerCallbackRef}
      style={{
        width: '100%',
        height: '100%',
        overflow: 'auto',
        display: 'flex',
        alignItems: 'flex-start',
        justifyContent: 'center',
        padding: '20px',
        minHeight: '400px'
      }}
    />
  );
};

export default MermaidPreview;
