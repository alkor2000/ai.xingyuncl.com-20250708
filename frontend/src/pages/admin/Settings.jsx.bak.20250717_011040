import React, { useEffect, useState } from 'react'
import {
  Card,
  Form,
  Input,
  Button,
  Switch,
  InputNumber,
  Select,
  Table,
  Modal,
  Space,
  Row,
  Col,
  Statistic,
  Typography,
  Tag,
  Tabs,
  message,
  Tooltip,
  Popconfirm,
  Badge
} from 'antd'
import {
  SaveOutlined,
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  ExperimentOutlined,
  SettingOutlined,
  RobotOutlined,
  BarChartOutlined,
  EyeOutlined,
  EyeInvisibleOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  QuestionCircleOutlined,
  ClockCircleOutlined,
  AppstoreOutlined,
  PlayCircleOutlined,
  StopOutlined,
  ApiOutlined,
  WalletOutlined,
  ThunderboltOutlined,
  FireOutlined,
  PictureOutlined,
  FileImageOutlined
} from '@ant-design/icons'
import { useTranslation } from 'react-i18next'
import useAdminStore from '../../stores/adminStore'
import useAuthStore from '../../stores/authStore'

const { TextArea } = Input
const { TabPane } = Tabs
const { Title, Text } = Typography

const Settings = () => {
  const { t } = useTranslation()
  const { hasPermission } = useAuthStore()
  const {
    aiModels,
    modules,
    systemStats,
    systemSettings,
    loading,
    getAIModels,
    createAIModel,
    updateAIModel,
    deleteAIModel,
    testAIModel,
    getModules,
    createModule,
    updateModule,
    deleteModule,
    checkModuleHealth,
    getSystemStats,
    getSystemSettings,
    updateSystemSettings
  } = useAdminStore()

  const [settingsForm] = Form.useForm()
  const [modelForm] = Form.useForm()
  const [moduleForm] = Form.useForm()
  
  const [isModelModalVisible, setIsModelModalVisible] = useState(false)
  const [isModuleModalVisible, setIsModuleModalVisible] = useState(false)
  const [editingModel, setEditingModel] = useState(null)
  const [editingModule, setEditingModule] = useState(null)
  const [testingModelId, setTestingModelId] = useState(null)
  const [checkingModuleId, setCheckingModuleId] = useState(null)
  const [showApiKey, setShowApiKey] = useState({})

  useEffect(() => {
    if (hasPermission('system.all')) {
      getSystemStats()
      getAIModels()
      getModules()
      getSystemSettings()
    }
  }, [hasPermission])

  useEffect(() => {
    if (systemSettings && Object.keys(systemSettings).length > 0) {
      settingsForm.setFieldsValue(systemSettings)
    }
  }, [systemSettings, settingsForm])

  // ä¿å­˜ç³»ç»Ÿè®¾ç½®
  const handleSaveSettings = async (values) => {
    try {
      await updateSystemSettings(values)
      message.success(t('admin.settings.save.success'))
    } catch (error) {
      message.error(t('admin.settings.save.failed'))
    }
  }

  // åˆ›å»ºAIæ¨¡å‹
  const handleCreateModel = async (values) => {
    try {
      await createAIModel(values)
      setIsModelModalVisible(false)
      modelForm.resetFields()
      message.success(t('admin.models.create.success'))
    } catch (error) {
      message.error(error.response?.data?.message || t('admin.models.create.failed'))
    }
  }

  // æ›´æ–°AIæ¨¡å‹
  const handleUpdateModel = async (values) => {
    try {
      await updateAIModel(editingModel.id, values)
      setIsModelModalVisible(false)
      setEditingModel(null)
      modelForm.resetFields()
      message.success(t('admin.models.update.success'))
    } catch (error) {
      message.error(error.response?.data?.message || t('admin.models.update.failed'))
    }
  }

  // åˆ é™¤AIæ¨¡å‹
  const handleDeleteModel = async (modelId) => {
    try {
      await deleteAIModel(modelId)
      message.success(t('admin.models.delete.success'))
    } catch (error) {
      message.error(error.response?.data?.message || t('admin.models.delete.failed'))
    }
  }

  // æµ‹è¯•AIæ¨¡å‹
  const handleTestModel = async (modelId) => {
    setTestingModelId(modelId)
    try {
      const result = await testAIModel(modelId)
      if (result.success && result.data) {
        if (result.data.success) {
          message.success(t('admin.models.test.success'))
        } else {
          message.warning(t('admin.models.test.failed', { message: result.data.message }))
        }
        await getAIModels()
      } else {
        message.error(result.message || t('admin.models.test.error'))
      }
    } catch (error) {
      console.error('æµ‹è¯•å¤±è´¥:', error)
      message.error(error.message || t('admin.models.test.error'))
    } finally {
      setTestingModelId(null)
    }
  }

  // ç¼–è¾‘AIæ¨¡å‹
  const handleEditModel = (model) => {
    setEditingModel(model)
    modelForm.setFieldsValue({
      name: model.name,
      display_name: model.display_name,
      api_key: '',
      api_endpoint: '',
      stream_enabled: model.stream_enabled !== undefined ? model.stream_enabled : true,
      image_upload_enabled: model.image_upload_enabled !== undefined ? model.image_upload_enabled : false,
      credits_per_chat: model.credits_per_chat,
      is_active: model.is_active,
      sort_order: model.sort_order
    })
    setIsModelModalVisible(true)
  }

  // åˆ›å»ºç³»ç»Ÿæ¨¡å—
  const handleCreateModule = async (values) => {
    try {
      await createModule(values)
      setIsModuleModalVisible(false)
      moduleForm.resetFields()
      message.success('ç³»ç»Ÿæ¨¡å—åˆ›å»ºæˆåŠŸ')
    } catch (error) {
      message.error(error.response?.data?.message || 'ç³»ç»Ÿæ¨¡å—åˆ›å»ºå¤±è´¥')
    }
  }

  // æ›´æ–°ç³»ç»Ÿæ¨¡å—
  const handleUpdateModule = async (values) => {
    try {
      await updateModule(editingModule.id, values)
      setIsModuleModalVisible(false)
      setEditingModule(null)
      moduleForm.resetFields()
      message.success('ç³»ç»Ÿæ¨¡å—æ›´æ–°æˆåŠŸ')
    } catch (error) {
      message.error(error.response?.data?.message || 'ç³»ç»Ÿæ¨¡å—æ›´æ–°å¤±è´¥')
    }
  }

  // åˆ é™¤ç³»ç»Ÿæ¨¡å—
  const handleDeleteModule = async (moduleId) => {
    try {
      await deleteModule(moduleId)
      message.success('ç³»ç»Ÿæ¨¡å—åˆ é™¤æˆåŠŸ')
    } catch (error) {
      message.error(error.response?.data?.message || 'ç³»ç»Ÿæ¨¡å—åˆ é™¤å¤±è´¥')
    }
  }

  // ç¼–è¾‘ç³»ç»Ÿæ¨¡å—
  const handleEditModule = (module) => {
    setEditingModule(module)
    moduleForm.setFieldsValue({
      name: module.name,
      display_name: module.display_name,
      description: module.description,
      module_type: module.module_type,
      api_endpoint: module.api_endpoint,
      frontend_url: module.frontend_url,
      proxy_path: module.proxy_path,
      auth_mode: module.auth_mode,
      is_active: module.is_active,
      permissions: module.permissions || [],
      config: module.config || {},
      health_check_url: module.health_check_url
    })
    setIsModuleModalVisible(true)
  }

  // æ£€æŸ¥æ¨¡å—å¥åº·çŠ¶æ€
  const handleCheckModuleHealth = async (moduleId) => {
    setCheckingModuleId(moduleId)
    try {
      const result = await checkModuleHealth(moduleId)
      if (result.success) {
        message.success(`å¥åº·æ£€æŸ¥å®Œæˆï¼š${result.data.message}`)
      } else {
        message.warning('å¥åº·æ£€æŸ¥å¤±è´¥')
      }
    } catch (error) {
      message.error('å¥åº·æ£€æŸ¥å‡ºé”™')
    } finally {
      setCheckingModuleId(null)
    }
  }

  // åˆ‡æ¢æ¨¡å—å¯ç”¨çŠ¶æ€
  const handleToggleModuleStatus = async (moduleId, isActive) => {
    try {
      await updateModule(moduleId, { is_active: isActive })
      message.success(isActive ? 'æ¨¡å—å·²å¯ç”¨' : 'æ¨¡å—å·²ç¦ç”¨')
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥')
    }
  }

  // ğŸ†• å¿«é€Ÿåˆ‡æ¢æµå¼è¾“å‡ºçŠ¶æ€
  const handleToggleStreamEnabled = async (modelId, streamEnabled) => {
    try {
      await updateAIModel(modelId, { stream_enabled: streamEnabled })
      message.success(streamEnabled ? 'æµå¼è¾“å‡ºå·²å¯ç”¨' : 'æµå¼è¾“å‡ºå·²ç¦ç”¨')
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥')
    }
  }

  // ğŸ†• å¿«é€Ÿåˆ‡æ¢å›¾ç‰‡ä¸Šä¼ çŠ¶æ€
  const handleToggleImageUploadEnabled = async (modelId, imageUploadEnabled) => {
    try {
      await updateAIModel(modelId, { image_upload_enabled: imageUploadEnabled })
      message.success(imageUploadEnabled ? 'å›¾ç‰‡ä¸Šä¼ å·²å¯ç”¨' : 'å›¾ç‰‡ä¸Šä¼ å·²ç¦ç”¨')
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥')
    }
  }

  // æ¸²æŸ“æµ‹è¯•çŠ¶æ€
  const renderTestStatus = (status, lastTestedAt, modelId) => {
    if (testingModelId === modelId) {
      return (
        <Tag icon={<ClockCircleOutlined />} color="processing">
          {t('status.loading')}
        </Tag>
      )
    }

    switch (status) {
      case 'success':
        return (
          <Tag icon={<CheckCircleOutlined />} color="success">
            {t('status.success')}
          </Tag>
        )
      case 'failed':
        return (
          <Tag icon={<CloseCircleOutlined />} color="error">
            {t('status.failed')}
          </Tag>
        )
      default:
        return (
          <Tag icon={<QuestionCircleOutlined />} color="default">
            {t('status.error')}
          </Tag>
        )
    }
  }

  // æ¸²æŸ“æ¨¡å—çŠ¶æ€
  const renderModuleStatus = (status) => {
    switch (status) {
      case 'online':
        return <Tag color="success">{t('status.online')}</Tag>
      case 'offline':
        return <Tag color="error">{t('status.offline')}</Tag>
      case 'error':
        return <Tag color="error">{t('status.error')}</Tag>
      default:
        return <Tag color="default">{t('status.error')}</Tag>
    }
  }
  
  // ğŸ†• AIæ¨¡å‹è¡¨æ ¼åˆ— - å¢å¼ºæµå¼è¾“å‡ºå’Œå›¾ç‰‡ä¸Šä¼ æ˜¾ç¤º
  const modelColumns = [
    {
      title: t('admin.models.table.name'),
      dataIndex: 'name',
      key: 'name',
      width: 140
    },
    {
      title: t('admin.models.table.displayName'),
      dataIndex: 'display_name',
      key: 'display_name',
      width: 160
    },
    {
      title: t('admin.models.table.credits'),
      dataIndex: 'credits_per_chat',
      key: 'credits_per_chat',
      width: 100,
      render: (credits) => (
        <Space>
          <WalletOutlined style={{ color: '#1677ff' }} />
          <span style={{ fontWeight: 'bold', color: '#1677ff' }}>
            {credits}{t('admin.models.perChat')}
          </span>
        </Space>
      )
    },
    {
      title: t('admin.models.table.streamEnabled'),
      dataIndex: 'stream_enabled',
      key: 'stream_enabled',
      width: 120,
      render: (streamEnabled, record) => (
        <Space>
          <Switch
            checked={streamEnabled}
            size="small"
            loading={loading}
            onChange={(checked) => handleToggleStreamEnabled(record.id, checked)}
            checkedChildren={<ThunderboltOutlined />}
            unCheckedChildren={<CloseCircleOutlined />}
          />
          {streamEnabled ? (
            <Tag color="processing" icon={<ThunderboltOutlined />} size="small">
              {t('admin.models.stream')}
            </Tag>
          ) : (
            <Tag color="default" icon={<CloseCircleOutlined />} size="small">
              {t('admin.models.standard')}
            </Tag>
          )}
        </Space>
      )
    },
    {
      title: t('admin.models.table.imageUploadEnabled'),
      dataIndex: 'image_upload_enabled',
      key: 'image_upload_enabled',
      width: 120,
      render: (imageUploadEnabled, record) => (
        <Space>
          <Switch
            checked={imageUploadEnabled}
            size="small"
            loading={loading}
            onChange={(checked) => handleToggleImageUploadEnabled(record.id, checked)}
            checkedChildren={<PictureOutlined />}
            unCheckedChildren={<CloseCircleOutlined />}
          />
          {imageUploadEnabled ? (
            <Tag color="success" icon={<FileImageOutlined />} size="small">
              {t('admin.models.image')}
            </Tag>
          ) : (
            <Tag color="default" icon={<CloseCircleOutlined />} size="small">
              {t('admin.models.textOnly')}
            </Tag>
          )}
        </Space>
      )
    },
    {
      title: t('admin.models.table.apiKey'),
      dataIndex: 'api_key',
      key: 'api_key',
      width: 120,
      render: (apiKey, record) => (
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <span style={{ minWidth: 80 }}>
            {showApiKey[record.id] ? 
              (apiKey ? `${apiKey.substring(0, 15)}...` : t('admin.models.notConfigured')) : 
              'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'
            }
          </span>
          <Button
            type="text"
            size="small"
            icon={showApiKey[record.id] ? <EyeInvisibleOutlined /> : <EyeOutlined />}
            onClick={() => setShowApiKey(prev => ({ ...prev, [record.id]: !prev[record.id] }))}
          />
        </div>
      )
    },
    {
      title: t('admin.models.table.status'),
      key: 'status',
      width: 140,
      render: (_, record) => (
        <Space direction="vertical" size="small">
          <div>
            {record.is_active ? (
              <Tag color="success" size="small">{t('status.active')}</Tag>
            ) : (
              <Tag color="default" size="small">{t('status.inactive')}</Tag>
            )}
            {renderTestStatus(record.test_status, record.last_tested_at, record.id)}
          </div>
        </Space>
      )
    },
    {
      title: t('admin.models.table.actions'),
      key: 'actions',
      width: 120,
      render: (_, record) => (
        <Space size="small">
          <Tooltip title={t('admin.models.testConnection')}>
            <Button
              type="text"
              size="small"
              icon={<ExperimentOutlined />}
              loading={testingModelId === record.id}
              onClick={() => handleTestModel(record.id)}
            />
          </Tooltip>
          <Tooltip title={t('button.edit')}>
            <Button
              type="text"
              size="small"
              icon={<EditOutlined />}
              onClick={() => handleEditModel(record)}
            />
          </Tooltip>
          <Tooltip title={t('button.delete')}>
            <Popconfirm
              title={t('admin.models.delete.confirm')}
              onConfirm={() => handleDeleteModel(record.id)}
              okText={t('button.confirm')}
              cancelText={t('button.cancel')}
            >
              <Button
                type="text"
                size="small"
                danger
                icon={<DeleteOutlined />}
              />
            </Popconfirm>
          </Tooltip>
        </Space>
      )
    }
  ]

  // ç³»ç»Ÿæ¨¡å—è¡¨æ ¼åˆ—
  const moduleColumns = [
    {
      title: t('admin.modules.table.name'),
      dataIndex: 'display_name', 
      key: 'display_name',
      render: (text, record) => (
        <div>
          <div style={{ fontWeight: 500 }}>{text}</div>
          <div style={{ fontSize: 12, color: '#999' }}>{record.name}</div>
        </div>
      )
    },
    {
      title: t('admin.modules.table.type'),
      dataIndex: 'module_type',
      key: 'module_type',
      render: (type) => {
        const typeMap = {
          'frontend': { color: 'blue', text: t('admin.modules.type.frontend') },
          'backend': { color: 'green', text: t('admin.modules.type.backend') },
          'fullstack': { color: 'purple', text: t('admin.modules.type.fullstack') }
        }
        const config = typeMap[type] || { color: 'default', text: type }
        return <Tag color={config.color}>{config.text}</Tag>
      }
    },
    {
      title: t('admin.modules.table.proxyPath'),
      dataIndex: 'proxy_path',
      key: 'proxy_path',
      render: (path) => (
        <span style={{ fontFamily: 'monospace', fontSize: 12, backgroundColor: '#f5f5f5', padding: '2px 6px', borderRadius: 4 }}>
          {path}
        </span>
      )
    },
    {
      title: t('admin.modules.table.status'),
      key: 'status',
      render: (_, record) => (
        <Space>
          <Badge 
            status={record.is_active ? 'success' : 'default'} 
            text={record.is_active ? t('status.active') : t('status.inactive')} 
          />
          {renderModuleStatus(record.status)}
        </Space>
      )
    },
    {
      title: t('table.actions'),
      key: 'actions',
      render: (_, record) => (
        <Space size="small">
          <Tooltip title={t('admin.modules.healthCheck')}>
            <Button
              type="text"
              size="small"
              icon={<ApiOutlined />}
              loading={checkingModuleId === record.id}
              onClick={() => handleCheckModuleHealth(record.id)}
            />
          </Tooltip>
          <Tooltip title={record.is_active ? t('admin.modules.disable') : t('admin.modules.enable')}>
            <Button
              type="text"
              size="small"
              icon={record.is_active ? <StopOutlined /> : <PlayCircleOutlined />}
              onClick={() => handleToggleModuleStatus(record.id, !record.is_active)}
            />
          </Tooltip>
          <Tooltip title={t('button.edit')}>
            <Button
              type="text"
              size="small"
              icon={<EditOutlined />}
              onClick={() => handleEditModule(record)}
            />
          </Tooltip>
          <Tooltip title={t('button.delete')}>
            <Popconfirm
              title="ç¡®å®šåˆ é™¤è¿™ä¸ªæ¨¡å—å—ï¼Ÿ"
              onConfirm={() => handleDeleteModule(record.id)}
              okText={t('button.confirm')}
              cancelText={t('button.cancel')}
            >
              <Button
                type="text"
                size="small"
                danger
                icon={<DeleteOutlined />}
              />
            </Popconfirm>
          </Tooltip>
        </Space>
      )
    }
  ]

  // æƒé™æ£€æŸ¥
  if (!hasPermission('system.all')) {
    return (
      <div className="page-container">
        <Card>
          <div style={{ textAlign: 'center', padding: '50px 0' }}>
            <p>{t('admin.noPermission')}</p>
          </div>
        </Card>
      </div>
    )
  }
  
  return (
    <div className="page-container">
      <Tabs defaultActiveKey="statistics" type="card">
        {/* ç³»ç»Ÿç»Ÿè®¡ (å¢å¼ºç§¯åˆ†ç»Ÿè®¡) */}
        <TabPane tab={<span><BarChartOutlined />{t('admin.settings.tabs.statistics')}</span>} key="statistics">
          <Row gutter={[16, 16]}>
            <Col xs={24} lg={12}>
              <Card title={t('admin.settings.userStats')} size="small">
                <Row gutter={16}>
                  <Col span={12}>
                    <Statistic 
                      title={t('admin.settings.totalUsers')} 
                      value={systemStats.users?.total_users || 0} 
                      valueStyle={{ color: '#1677ff' }}
                    />
                  </Col>
                  <Col span={12}>
                    <Statistic 
                      title={t('admin.settings.activeUsers')} 
                      value={systemStats.users?.active_users || 0} 
                      valueStyle={{ color: '#52c41a' }}
                    />
                  </Col>
                  <Col span={12}>
                    <Statistic 
                      title={t('admin.settings.totalCreditsQuota')} 
                      value={systemStats.users?.total_credits_quota || 0} 
                      valueStyle={{ color: '#722ed1' }}
                      formatter={value => value?.toLocaleString()}
                    />
                  </Col>
                  <Col span={12}>
                    <Statistic 
                      title={t('admin.settings.totalCreditsUsed')} 
                      value={systemStats.users?.total_credits_used || 0} 
                      valueStyle={{ color: '#fa8c16' }}
                      formatter={value => value?.toLocaleString()}
                    />
                  </Col>
                </Row>
              </Card>
            </Col>

            <Col xs={24} lg={12}>
              <Card title={t('admin.settings.conversationStats')} size="small">
                <Row gutter={16}>
                  <Col span={12}>
                    <Statistic 
                      title={t('admin.settings.totalConversations')} 
                      value={systemStats.conversations?.total_conversations || 0} 
                      valueStyle={{ color: '#1677ff' }}
                    />
                  </Col>
                  <Col span={12}>
                    <Statistic 
                      title={t('admin.settings.totalMessages')} 
                      value={systemStats.conversations?.total_messages || 0} 
                      valueStyle={{ color: '#52c41a' }}
                    />
                  </Col>
                  <Col span={24}>
                    <Statistic 
                      title={t('admin.settings.avgMessagesPerConversation')} 
                      value={systemStats.conversations?.avg_messages_per_conversation || 0} 
                      precision={1}
                      valueStyle={{ color: '#fa8c16' }}
                    />
                  </Col>
                </Row>
              </Card>
            </Col>

            <Col xs={24}>
              <Card title={t('admin.settings.modelUsage')} size="small">
                <div style={{ maxHeight: 300, overflowY: 'auto' }}>
                  {systemStats.models?.map((model, index) => (
                    <div key={model.model_name} style={{ 
                      display: 'flex', 
                      justifyContent: 'space-between', 
                      alignItems: 'center',
                      padding: '8px 0',
                      borderBottom: index < systemStats.models.length - 1 ? '1px solid #f0f0f0' : 'none'
                    }}>
                      <Space>
                        <span>#{index + 1} {model.model_name}</span>
                        {model.credits_per_chat && (
                          <Tag color="blue" size="small">
                            ğŸ’° {model.credits_per_chat} {t('admin.models.perChat')}
                          </Tag>
                        )}
                      </Space>
                      <Space>
                        <span>{model.conversation_count} {t('admin.settings.conversations')}</span>
                        {model.total_credits_consumed && (
                          <span style={{ color: '#722ed1' }}>
                            ğŸª™ {model.total_credits_consumed?.toLocaleString()} {t('unit.credits', { defaultValue: 'ç§¯åˆ†' })}
                          </span>
                        )}
                        <span style={{ color: '#999' }}>
                          {model.total_tokens?.toLocaleString()} {t('unit.tokens')}
                        </span>
                      </Space>
                    </div>
                  )) || <div style={{ color: '#999' }}>{t('message.noData')}</div>}
                </div>
              </Card>
            </Col>
          </Row>
        </TabPane>

        {/* ğŸ†• AIæ¨¡å‹ç®¡ç† - å¢å¼ºæµå¼è¾“å‡ºå’Œå›¾ç‰‡ä¸Šä¼ é…ç½® */}
        <TabPane tab={<span><RobotOutlined />{t('admin.settings.tabs.models')}</span>} key="models">
          <Card 
            title={
              <Space>
                <RobotOutlined />
                <span>{t('admin.models.config')}</span>
                <Tag color="blue">ğŸ’° {t('admin.models.creditsSystem')}</Tag>
                <Tag color="processing" icon={<ThunderboltOutlined />}>ğŸš€ {t('admin.models.streamOutput')}</Tag>
                <Tag color="success" icon={<FileImageOutlined />}>ğŸ–¼ï¸ {t('admin.models.imageUpload')}</Tag>
                <Tag color="green">ğŸ”“ {t('admin.models.noOutputLimit')}</Tag>
              </Space>
            }
            extra={
              <Button 
                type="primary" 
                icon={<PlusOutlined />}
                onClick={() => {
                  setEditingModel(null)
                  modelForm.resetFields()
                  setIsModelModalVisible(true)
                }}
              >
                {t('admin.models.addModel')}
              </Button>
            }
          >
            <Table
              columns={modelColumns}
              dataSource={aiModels}
              rowKey="id"
              loading={loading}
              pagination={false}
              size="small"
              scroll={{ x: 'max-content' }}
            />
          </Card>
        </TabPane>

        {/* æ¨¡å—æ¥å…¥ */}
        <TabPane tab={<span><AppstoreOutlined />{t('admin.settings.tabs.modules')}</span>} key="modules">
          <Card
            title={t('admin.modules.title')}
            extra={
              <Button
                type="primary"
                icon={<PlusOutlined />}
                onClick={() => {
                  setEditingModule(null)
                  moduleForm.resetFields()
                  setIsModuleModalVisible(true)
                }}
              >
                {t('admin.modules.addModule')}
              </Button>
            }
          >
            <Table
              columns={moduleColumns}
              dataSource={modules}
              rowKey="id"
              loading={loading}
              pagination={false}
              size="small"
              scroll={{ x: 'max-content' }}
            />
          </Card>
        </TabPane>

        {/* åŸºç¡€è®¾ç½® (ç§»é™¤maxTokenè®¾ç½®) */}
        <TabPane tab={<span><SettingOutlined />{t('admin.settings.tabs.basic')}</span>} key="settings">
          <Form
            form={settingsForm}
            layout="vertical"
            onFinish={handleSaveSettings}
          >
            <Row gutter={24}>
              <Col xs={24} lg={12}>
                <Card title={t('admin.settings.site.title')} size="small" style={{ marginBottom: 16 }}>
                  <Form.Item name={['site', 'name']} label={t('admin.settings.site.name')}>
                    <Input placeholder="AI Platform" />
                  </Form.Item>
                  
                  <Form.Item name={['site', 'description']} label={t('admin.settings.site.description')}>
                    <TextArea rows={3} placeholder={t('app.description')} />
                  </Form.Item>
                </Card>

                <Card title={t('admin.settings.user.title')} size="small">
                  <Form.Item name={['user', 'allow_register']} label={t('admin.settings.user.allowRegister')} valuePropName="checked">
                    <Switch />
                  </Form.Item>
                  
                  <Form.Item name={['user', 'email_verification']} label={t('admin.settings.user.emailVerification')} valuePropName="checked">
                    <Switch />
                  </Form.Item>
                  
                  <Form.Item name={['user', 'default_token_quota']} label={t('admin.settings.user.defaultTokenQuota')}>
                    <InputNumber
                      style={{ width: '100%' }}
                      min={0}
                      formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                      parser={value => value.replace(/\$\s?|(,*)/g, '')}
                    />
                  </Form.Item>

                  <Form.Item name={['user', 'default_credits_quota']} label={t('admin.settings.user.defaultCreditsQuota')}>
                    <InputNumber
                      style={{ width: '100%' }}
                      min={0}
                      formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                      parser={value => value.replace(/\$\s?|(,*)/g, '')}
                    />
                  </Form.Item>
                </Card>
              </Col>

              <Col xs={24} lg={12}>
                <Card title={t('admin.settings.ai.title')} size="small" style={{ marginBottom: 16 }}>
                  <Form.Item name={['ai', 'default_model']} label={t('admin.settings.ai.defaultModel')}>
                    <Select>
                      {aiModels.filter(m => m.is_active).map(model => (
                        <Select.Option key={model.name} value={model.name}>
                          <Space>
                            <span>{model.display_name}</span>
                            <Tag color="blue" size="small">{model.credits_per_chat}{t('unit.credits', { defaultValue: 'ç§¯åˆ†' })}</Tag>
                            {model.stream_enabled && (
                              <Tag color="processing" icon={<ThunderboltOutlined />} size="small">{t('admin.models.stream')}</Tag>
                            )}
                            {model.image_upload_enabled && (
                              <Tag color="success" icon={<FileImageOutlined />} size="small">{t('admin.models.image')}</Tag>
                            )}
                          </Space>
                        </Select.Option>
                      ))}
                    </Select>
                  </Form.Item>
                  
                  <Form.Item name={['ai', 'temperature']} label={t('admin.settings.ai.temperature')}>
                    <InputNumber style={{ width: '100%' }} min={0} max={2} step={0.1} />
                  </Form.Item>
                </Card>

                <Card title={t('admin.settings.credits.title')} size="small" style={{ marginBottom: 16 }}>
                  <Form.Item name={['credits', 'enable_credits']} label={t('admin.settings.credits.enable')} valuePropName="checked">
                    <Switch />
                  </Form.Item>
                  
                  <Form.Item name={['credits', 'default_credits']} label={t('admin.settings.credits.default')}>
                    <InputNumber 
                      style={{ width: '100%' }} 
                      min={0} 
                      max={100000}
                      formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                      parser={value => value.replace(/\$\s?|(,*)/g, '')}
                    />
                  </Form.Item>
                  
                  <Form.Item name={['credits', 'min_credits_for_chat']} label={t('admin.settings.credits.minForChat')}>
                    <InputNumber style={{ width: '100%' }} min={1} max={100} />
                  </Form.Item>
                </Card>

                <Card title={t('admin.settings.security.title')} size="small">
                  <Form.Item name={['security', 'session_timeout']} label={t('admin.settings.security.sessionTimeout')}>
                    <InputNumber style={{ width: '100%' }} min={5} max={1440} />
                  </Form.Item>
                  
                  <Form.Item name={['security', 'max_login_attempts']} label={t('admin.settings.security.maxLoginAttempts')}>
                    <InputNumber style={{ width: '100%' }} min={1} max={10} />
                  </Form.Item>
                  
                  <Form.Item name={['security', 'enable_rate_limit']} label={t('admin.settings.security.enableRateLimit')} valuePropName="checked">
                    <Switch />
                  </Form.Item>
                </Card>
              </Col>
            </Row>

            <Form.Item style={{ textAlign: 'center', marginTop: 24 }}>
              <Space>
                <Button type="primary" icon={<SaveOutlined />} htmlType="submit" loading={loading}>
                  {t('button.save')}
                </Button>
                <Button onClick={() => settingsForm.resetFields()}>
                  {t('button.reset')}
                </Button>
              </Space>
            </Form.Item>
          </Form>
        </TabPane>
      </Tabs>

      {/* ğŸ†• AIæ¨¡å‹åˆ›å»º/ç¼–è¾‘å¼¹çª— - æ–°å¢å›¾ç‰‡ä¸Šä¼ é…ç½® */}
      <Modal
        title={editingModel ? t('admin.models.editModel') : t('admin.models.createModel')}
        open={isModelModalVisible}
        onCancel={() => {
          setIsModelModalVisible(false)
          setEditingModel(null)
          modelForm.resetFields()
        }}
        footer={null}
        destroyOnClose
        width={700}
      >
        <Form
          form={modelForm}
          layout="vertical"
          onFinish={editingModel ? handleUpdateModel : handleCreateModel}
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="name"
                label={t('admin.models.form.name')}
                rules={[{ required: true, message: t('admin.models.form.name.required') }]}
              >
                <Input placeholder={t('admin.models.form.name.placeholder')} disabled={!!editingModel} />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="display_name"
                label={t('admin.models.form.displayName')}
                rules={[{ required: true, message: t('admin.models.form.displayName.required') }]}
              >
                <Input placeholder={t('admin.models.form.displayName.placeholder')} />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="api_key"
                label={t('admin.models.form.apiKey')}
                rules={[{ required: !editingModel, message: t('admin.models.form.apiKey.required') }]}
              >
                <Input.Password placeholder="sk-..." />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="api_endpoint"
                label={t('admin.models.form.apiEndpoint')}
                rules={[{ required: !editingModel, message: t('admin.models.form.apiEndpoint.required') }]}
              >
                <Input placeholder="https://api.openai.com/v1" />
              </Form.Item>
            </Col>
          </Row>

          {/* ğŸ†• æµå¼è¾“å‡ºé…ç½®åŒºåŸŸ */}
          <Row gutter={16}>
            <Col span={24}>
              <Card 
                title={
                  <Space>
                    <ThunderboltOutlined style={{ color: '#1677ff' }} />
                    <span>{t('admin.models.form.streamConfig')}</span>
                    <Tag color="processing">ğŸš€ {t('admin.models.streamOutput')}</Tag>
                  </Space>
                } 
                size="small" 
                style={{ marginBottom: 16 }}
              >
                <Row gutter={16}>
                  <Col span={12}>
                    <Form.Item
                      name="stream_enabled"
                      label={t('admin.models.form.enableStream')}
                      valuePropName="checked"
                      initialValue={true}
                    >
                      <Switch
                        checkedChildren={<ThunderboltOutlined />}
                        unCheckedChildren={<CloseCircleOutlined />}
                      />
                    </Form.Item>
                  </Col>
                  <Col span={12}>
                    <div style={{ 
                      marginTop: 30, 
                      padding: '8px 12px',
                      backgroundColor: '#f0f9ff',
                      borderRadius: '4px',
                      borderLeft: '3px solid #1677ff',
                      fontSize: '12px',
                      color: '#1677ff'
                    }}
                    dangerouslySetInnerHTML={{ 
                      __html: t('admin.models.form.streamTip')
                    }}
                    />
                  </Col>
                </Row>
              </Card>
            </Col>
          </Row>

          {/* ğŸ†• å›¾ç‰‡è¯†åˆ«é…ç½®åŒºåŸŸ */}
          <Row gutter={16}>
            <Col span={24}>
              <Card 
                title={
                  <Space>
                    <FileImageOutlined style={{ color: '#52c41a' }} />
                    <span>{t('admin.models.form.imageConfig')}</span>
                    <Tag color="success">ğŸ–¼ï¸ {t('admin.models.imageUpload')}</Tag>
                  </Space>
                } 
                size="small" 
                style={{ marginBottom: 16 }}
              >
                <Row gutter={16}>
                  <Col span={12}>
                    <Form.Item
                      name="image_upload_enabled"
                      label={t('admin.models.form.enableImageUpload')}
                      valuePropName="checked"
                      initialValue={false}
                    >
                      <Switch
                        checkedChildren={<PictureOutlined />}
                        unCheckedChildren={<CloseCircleOutlined />}
                      />
                    </Form.Item>
                  </Col>
                  <Col span={12}>
                    <div style={{ 
                      marginTop: 30, 
                      padding: '8px 12px',
                      backgroundColor: '#f0fff7',
                      borderRadius: '4px',
                      borderLeft: '3px solid #52c41a',
                      fontSize: '12px',
                      color: '#52c41a'
                    }}
                    dangerouslySetInnerHTML={{ 
                      __html: t('admin.models.form.imageTip')
                    }}
                    />
                  </Col>
                </Row>
              </Card>
            </Col>
          </Row>

          {/* ç§¯åˆ†é…ç½®åŒºåŸŸ */}
          <Row gutter={16}>
            <Col span={24}>
              <Card 
                title={
                  <Space>
                    <WalletOutlined style={{ color: '#1677ff' }} />
                    <span>{t('admin.models.form.creditsConfig')}</span>
                    <Tag color="green">ğŸš€ {t('admin.models.noOutputLimit')}</Tag>
                  </Space>
                } 
                size="small" 
                style={{ marginBottom: 16 }}
              >
                <Row gutter={16}>
                  <Col span={12}>
                    <Form.Item
                      name="credits_per_chat"
                      label={t('admin.models.form.creditsPerChat')}
                      rules={[{ required: true, message: t('admin.models.form.creditsPerChat.required') }]}
                      initialValue={10}
                    >
                      <InputNumber
                        style={{ width: '100%' }}
                        min={1}
                        max={1000}
                        addonAfter={t('admin.models.perChat')}
                        formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        parser={value => value.replace(/\$\s?|(,*)/g, '')}
                      />
                    </Form.Item>
                  </Col>
                  <Col span={12}>
                    <div style={{ 
                      marginTop: 30, 
                      padding: '8px 12px',
                      backgroundColor: '#f0f9ff',
                      borderRadius: '4px',
                      borderLeft: '3px solid #1677ff',
                      fontSize: '12px',
                      color: '#1677ff'
                    }}
                    dangerouslySetInnerHTML={{ 
                      __html: t('admin.models.form.creditsTip')
                    }}
                    />
                  </Col>
                </Row>
              </Card>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item name="is_active" label={t('admin.models.form.status')} valuePropName="checked">
                <Switch />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="sort_order" label={t('admin.models.form.sort')}>
                <InputNumber min={0} style={{ width: '100%' }} />
              </Form.Item>
            </Col>
          </Row>

          <Form.Item style={{ textAlign: 'right', marginBottom: 0 }}>
            <Space>
              <Button onClick={() => {
                setIsModelModalVisible(false)
                setEditingModel(null)
                modelForm.resetFields()
              }}>
                {t('button.cancel')}
              </Button>
              <Button type="primary" htmlType="submit" loading={loading}>
                {editingModel ? t('button.update') : t('button.create')}
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>

      {/* ç³»ç»Ÿæ¨¡å—åˆ›å»º/ç¼–è¾‘å¼¹çª— (ä¿æŒä¸å˜) */}
      <Modal
        title={editingModule ? 'ç¼–è¾‘ç³»ç»Ÿæ¨¡å—' : 'åˆ›å»ºç³»ç»Ÿæ¨¡å—'}
        open={isModuleModalVisible}
        onCancel={() => {
          setIsModuleModalVisible(false)
          setEditingModule(null)
          moduleForm.resetFields()
        }}
        footer={null}
        destroyOnClose
        width={800}
      >
        <Form
          form={moduleForm}
          layout="vertical"
          onFinish={editingModule ? handleUpdateModule : handleCreateModule}
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="name"
                label="æ¨¡å—æ ‡è¯†"
                rules={[{ required: true, message: 'è¯·è¾“å…¥æ¨¡å—æ ‡è¯†' }]}
              >
                <Input placeholder="å¦‚: ai-image-generator" disabled={!!editingModule} />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="display_name"
                label="æ˜¾ç¤ºåç§°"
                rules={[{ required: true, message: 'è¯·è¾“å…¥æ˜¾ç¤ºåç§°' }]}
              >
                <Input placeholder="å¦‚: AIå›¾åƒç”Ÿæˆ" />
              </Form.Item>
            </Col>
          </Row>

          <Form.Item name="description" label="æ¨¡å—æè¿°">
            <TextArea rows={2} placeholder="æè¿°æ¨¡å—çš„åŠŸèƒ½å’Œç”¨é€”" />
          </Form.Item>

          <Row gutter={16}>
            <Col span={8}>
              <Form.Item name="module_type" label="æ¨¡å—ç±»å‹" rules={[{ required: true }]}>
                <Select>
                  <Select.Option value="frontend">å‰ç«¯æ¨¡å—</Select.Option>
                  <Select.Option value="backend">åç«¯æ¨¡å—</Select.Option>
                  <Select.Option value="fullstack">å…¨æ ˆæ¨¡å—</Select.Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item name="auth_mode" label="è®¤è¯æ¨¡å¼" rules={[{ required: true }]}>
                <Select>
                  <Select.Option value="jwt">JWTè®¤è¯</Select.Option>
                  <Select.Option value="oauth">OAuthè®¤è¯</Select.Option>
                  <Select.Option value="none">æ— è®¤è¯</Select.Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item
                name="proxy_path"
                label="ä»£ç†è·¯å¾„"
                rules={[{ required: true, message: 'è¯·è¾“å…¥ä»£ç†è·¯å¾„' }]}
              >
                <Input placeholder="/image-generation" />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item name="api_endpoint" label="åç«¯APIåœ°å€">
                <Input placeholder="http://localhost:5000/api" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="frontend_url" label="å‰ç«¯åœ°å€">
                <Input placeholder="http://localhost:5001" />
              </Form.Item>
            </Col>
          </Row>

          <Form.Item name="health_check_url" label="å¥åº·æ£€æŸ¥åœ°å€">
            <Input placeholder="http://localhost:5000/health" />
          </Form.Item>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item name="permissions" label="æ‰€éœ€æƒé™">
                <Select mode="tags" placeholder="æ·»åŠ æƒé™æ ‡è¯†">
                  <Select.Option value="image.generate">image.generate</Select.Option>
                  <Select.Option value="image.view">image.view</Select.Option>
                  <Select.Option value="code.generate">code.generate</Select.Option>
                  <Select.Option value="document.process">document.process</Select.Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="is_active" label="å¯ç”¨çŠ¶æ€" valuePropName="checked">
                <Switch />
              </Form.Item>
            </Col>
          </Row>

          <Form.Item style={{ textAlign: 'right', marginBottom: 0 }}>
            <Space>
              <Button onClick={() => {
                setIsModuleModalVisible(false)
                setEditingModule(null)
                moduleForm.resetFields()
              }}>
                {t('button.cancel')}
              </Button>
              <Button type="primary" htmlType="submit" loading={loading}>
                {editingModule ? t('button.update') : t('button.create')}
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  )
}

export default Settings
