/**
 * è¯¾ç¨‹ç¼–è¾‘å™¨ç»„ä»¶ï¼ˆçº¯ç™½åº•iOSç§‘æŠ€é£ + æ•™æ¡ˆç¼–è¾‘åŠŸèƒ½ï¼‰
 * è®¾è®¡ç†å¿µï¼šç™½è‰²ä¸ºä¸» + ç²¾è‡´å¡ç‰‡ + è½»æŸ”é˜´å½± + iOSç»†èŠ‚
 * é…è‰²ï¼šçº¯ç™½èƒŒæ™¯ï¼Œç™½è‰²å¡ç‰‡ï¼Œæ·±è‰²æ–‡å­—ï¼Œè“è‰²ç‚¹ç¼€
 * ä¸‰æ å¸ƒå±€ï¼šå·¦ä¾§é¡µé¢ç®¡ç† | ä¸­é—´Monacoç¼–è¾‘å™¨ | å³ä¾§å®æ—¶é¢„è§ˆ
 * ä¿®å¤ï¼šTinyMCEæœ¬åœ°åŒ–é…ç½®ï¼ˆv1.1.1 - 2025-10-29ï¼‰
 */

import React, { useState, useEffect, useRef } from 'react';
import {
  Layout,
  Button,
  Input,
  List,
  Space,
  Breadcrumb,
  message,
  Modal,
  Form,
  Select,
  Tooltip,
  Popconfirm,
  Badge,
  Spin
} from 'antd';
import {
  SaveOutlined,
  PlusOutlined,
  DeleteOutlined,
  EyeOutlined,
  ArrowLeftOutlined,
  FileTextOutlined,
  EditOutlined,
  SyncOutlined,
  BookOutlined
} from '@ant-design/icons';
import Editor from '@monaco-editor/react';
import { useParams, useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import useTeachingStore from '../../stores/teachingStore';

const { Sider, Content } = Layout;

// iOSç§‘æŠ€é£é…è‰²æ–¹æ¡ˆï¼ˆçº¯ç™½åº•ï¼‰
const iosColors = {
  primary: '#0A84FF',
  success: '#30D158',
  warning: '#FF9F0A',
  danger: '#FF453A',
  bgPrimary: '#FFFFFF',
  bgSecondary: '#F5F7FA',
  cardWhite: '#FFFFFF',
  border: 'rgba(0, 0, 0, 0.06)',
  textPrimary: '#1a1a1a',
  textSecondary: '#666666',
  textTertiary: '#999999',
  selectedBg: '#F0F8FF',
  hoverBg: '#F8FAFB',
  shadow: '0 2px 8px rgba(0, 0, 0, 0.06)',
  shadowHover: '0 4px 16px rgba(0, 0, 0, 0.08)'
};

const LessonEditor = () => {
  const { t } = useTranslation();
  const { id } = useParams();
  const navigate = useNavigate();

  const {
    currentLesson,
    currentLessonLoading,
    fetchLesson,
    updateLesson,
    saveTeachingPlan,
    fetchTeachingPlan,
    teachingPlanSaving,
    teachingPlanLoading
  } = useTeachingStore();

  // é¡µé¢çŠ¶æ€
  const [pages, setPages] = useState([
    { id: 1, title: 'Page 1', html: '<h1>æ–°é¡µé¢</h1>' }
  ]);
  const [currentPageIndex, setCurrentPageIndex] = useState(0);
  const [htmlContent, setHtmlContent] = useState('');
  const [lessonInfo, setLessonInfo] = useState({
    title: '',
    description: '',
    content_type: 'course',
    status: 'draft'
  });

  // UIçŠ¶æ€
  const [isSaving, setIsSaving] = useState(false);
  const [previewContent, setPreviewContent] = useState('');
  const [pageModalVisible, setPageModalVisible] = useState(false);
  const [titleEditModalVisible, setTitleEditModalVisible] = useState(false);
  const [editingPageIndex, setEditingPageIndex] = useState(null);
  const [editorReady, setEditorReady] = useState(false);

  // æ•™æ¡ˆç¼–è¾‘çŠ¶æ€ï¼ˆæ–°å¢ï¼‰
  const [teachingPlanModalVisible, setTeachingPlanModalVisible] = useState(false);
  const [currentTeachingPlanPageIndex, setCurrentTeachingPlanPageIndex] = useState(null);
  const [teachingPlanContent, setTeachingPlanContent] = useState('');
  const [tinyMCEReady, setTinyMCEReady] = useState(false);
  const teachingPlanEditorRef = useRef(null);

  const [pageForm] = Form.useForm();
  const [titleForm] = Form.useForm();

  // åŠ è½½è¯¾ç¨‹æ•°æ®
  useEffect(() => {
    if (id) {
      loadLessonData();
    }
  }, [id]);

  // åŠ è½½TinyMCEè„šæœ¬ï¼ˆä¿®å¤ï¼šç¡®ä¿å®Œæ•´è·¯å¾„ï¼‰
  useEffect(() => {
    if (!window.tinymce) {
      const script = document.createElement('script');
      script.src = '/tinymce/tinymce.min.js';
      script.onload = () => {
        console.log('TinyMCE åŠ è½½æˆåŠŸ');
        setTinyMCEReady(true);
      };
      script.onerror = () => {
        console.error('TinyMCE åŠ è½½å¤±è´¥');
        message.error('å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠ è½½å¤±è´¥');
      };
      document.head.appendChild(script);
    } else {
      setTinyMCEReady(true);
    }

    return () => {
      if (teachingPlanEditorRef.current && window.tinymce) {
        window.tinymce.remove(teachingPlanEditorRef.current);
      }
    };
  }, []);

  const loadLessonData = async () => {
    try {
      const lesson = await fetchLesson(id);
      
      setLessonInfo({
        title: lesson.title,
        description: lesson.description,
        content_type: lesson.content_type,
        status: lesson.status
      });

      if (lesson.content) {
        const content = typeof lesson.content === 'string'
          ? JSON.parse(lesson.content)
          : lesson.content;
        
        if (content.pages && content.pages.length > 0) {
          setPages(content.pages);
          setHtmlContent(content.pages[0].html || '');
        }
      }
    } catch (error) {
      message.error(t('teaching.loadFailed'));
    }
  };

  // å®æ—¶é¢„è§ˆæ›´æ–°
  useEffect(() => {
    setPreviewContent(htmlContent || '<div style="padding:20px;color:#999;">å¼€å§‹ç¼–å†™å†…å®¹...</div>');
  }, [htmlContent]);

  // ä¿å­˜å½“å‰é¡µé¢åˆ°pagesæ•°ç»„
  const saveCurrentPageContent = () => {
    const newPages = [...pages];
    newPages[currentPageIndex] = {
      ...newPages[currentPageIndex],
      html: htmlContent
    };
    setPages(newPages);
    return newPages;
  };

  // åˆ‡æ¢é¡µé¢
  const handlePageChange = (index) => {
    const newPages = saveCurrentPageContent();
    setCurrentPageIndex(index);
    setHtmlContent(newPages[index].html || '');
  };

  // æ·»åŠ é¡µé¢
  const handleAddPage = () => {
    pageForm.setFieldsValue({ title: `Page ${pages.length + 1}` });
    setEditingPageIndex(null);
    setPageModalVisible(true);
  };

  // ç¼–è¾‘é¡µé¢æ ‡é¢˜
  const handleEditPage = (index) => {
    pageForm.setFieldsValue({ title: pages[index].title });
    setEditingPageIndex(index);
    setPageModalVisible(true);
  };

  // ç¡®è®¤é¡µé¢æ“ä½œ
  const handlePageSubmit = async () => {
    try {
      const values = await pageForm.validateFields();
      
      if (editingPageIndex !== null) {
        const newPages = [...pages];
        newPages[editingPageIndex].title = values.title;
        setPages(newPages);
        message.success(t('teaching.updateSuccess'));
      } else {
        const newPage = {
          id: Date.now(),
          title: values.title,
          html: '<h1>æ–°é¡µé¢</h1>'
        };
        setPages([...pages, newPage]);
        message.success(t('teaching.pageAdded'));
      }
      
      setPageModalVisible(false);
      pageForm.resetFields();
    } catch (error) {
      console.error('é¡µé¢æ“ä½œå¤±è´¥:', error);
    }
  };

  // åˆ é™¤é¡µé¢
  const handleDeletePage = (index) => {
    if (pages.length === 1) {
      message.warning(t('teaching.lastPageCannotDelete'));
      return;
    }

    const newPages = pages.filter((_, i) => i !== index);
    setPages(newPages);
    
    if (index === currentPageIndex) {
      setCurrentPageIndex(0);
      setHtmlContent(newPages[0].html || '');
    } else if (index < currentPageIndex) {
      setCurrentPageIndex(currentPageIndex - 1);
    }
    
    message.success(t('teaching.deleteSuccess'));
  };

  // æ‰“å¼€æ ‡é¢˜ç¼–è¾‘æ¨¡æ€æ¡†
  const handleEditTitle = () => {
    titleForm.setFieldsValue({
      title: lessonInfo.title,
      description: lessonInfo.description,
      content_type: lessonInfo.content_type
    });
    setTitleEditModalVisible(true);
  };

  // ç¡®è®¤æ ‡é¢˜ç¼–è¾‘
  const handleTitleSubmit = async () => {
    try {
      const values = await titleForm.validateFields();
      setLessonInfo({
        ...lessonInfo,
        ...values
      });
      setTitleEditModalVisible(false);
      message.success(t('teaching.updateSuccess'));
    } catch (error) {
      console.error('æ ‡é¢˜ç¼–è¾‘å¤±è´¥:', error);
    }
  };

  // ä¿å­˜è¯¾ç¨‹
  const handleSave = async () => {
    if (!lessonInfo.title.trim()) {
      message.warning(t('teaching.lessonTitleRequired'));
      return;
    }

    setIsSaving(true);
    try {
      const finalPages = saveCurrentPageContent();

      const updateData = {
        title: lessonInfo.title,
        description: lessonInfo.description,
        content_type: lessonInfo.content_type,
        status: lessonInfo.status,
        content: JSON.stringify({ pages: finalPages })
      };

      await updateLesson(id, updateData);
      message.success(t('teaching.saveSuccess'));
    } catch (error) {
      message.error(t('teaching.saveFailed'));
    } finally {
      setIsSaving(false);
    }
  };

  // è¿”å›è¯¾ç¨‹é¡µé¢åˆ—è¡¨
  const handleBack = () => {
    navigate(`/teaching/lessons/${id}`);
  };

  // é¢„è§ˆç¬¬ä¸€é¡µ
  const handlePreview = () => {
    navigate(`/teaching/lessons/${id}/pages/1`);
  };

  // ==================== æ•™æ¡ˆç¼–è¾‘åŠŸèƒ½ï¼ˆä¿®å¤ç‰ˆï¼‰====================

  /**
   * æ‰“å¼€æ•™æ¡ˆç¼–è¾‘å™¨
   */
  const handleOpenTeachingPlan = async (pageIndex) => {
    if (!tinyMCEReady) {
      message.warning('å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™');
      return;
    }

    setCurrentTeachingPlanPageIndex(pageIndex);
    setTeachingPlanContent('');
    setTeachingPlanModalVisible(true);

    // åŠ è½½æ•™æ¡ˆå†…å®¹
    try {
      const pageNumber = pageIndex + 1;
      const plan = await fetchTeachingPlan(id, pageNumber);
      
      if (plan && plan.content) {
        setTeachingPlanContent(plan.content);
      } else {
        setTeachingPlanContent('<p>å¼€å§‹ç¼–å†™æ•™æ¡ˆ...</p>');
      }
    } catch (error) {
      console.error('åŠ è½½æ•™æ¡ˆå¤±è´¥:', error);
      setTeachingPlanContent('<p>å¼€å§‹ç¼–å†™æ•™æ¡ˆ...</p>');
    }
  };

  /**
   * åˆå§‹åŒ–TinyMCEç¼–è¾‘å™¨ï¼ˆä¿®å¤ï¼šæ·»åŠ base_urlé…ç½®ï¼‰
   */
  useEffect(() => {
    if (teachingPlanModalVisible && tinyMCEReady && window.tinymce) {
      // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
      const timer = setTimeout(() => {
        if (document.getElementById('teachingPlanEditor')) {
          window.tinymce.init({
            selector: '#teachingPlanEditor',
            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæŒ‡å®šæœ¬åœ°è·¯å¾„
            base_url: '/tinymce',
            suffix: '.min',
            // å…¶ä»–é…ç½®
            height: 500,
            language: 'zh_CN',
            menubar: true,
            plugins: [
              'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
              'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
              'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
            setup: (editor) => {
              teachingPlanEditorRef.current = editor;
              editor.on('init', () => {
                editor.setContent(teachingPlanContent);
              });
            }
          });
        }
      }, 100);

      return () => {
        clearTimeout(timer);
        if (teachingPlanEditorRef.current && window.tinymce) {
          window.tinymce.remove(teachingPlanEditorRef.current);
          teachingPlanEditorRef.current = null;
        }
      };
    }
  }, [teachingPlanModalVisible, tinyMCEReady, teachingPlanContent]);

  /**
   * ä¿å­˜æ•™æ¡ˆ
   */
  const handleSaveTeachingPlan = async () => {
    if (!teachingPlanEditorRef.current) {
      message.error('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–');
      return;
    }

    try {
      const content = teachingPlanEditorRef.current.getContent();
      const pageNumber = currentTeachingPlanPageIndex + 1;
      
      await saveTeachingPlan(id, pageNumber, content);
      
      setTeachingPlanModalVisible(false);
      
      // æ¸…ç†ç¼–è¾‘å™¨
      if (window.tinymce && teachingPlanEditorRef.current) {
        window.tinymce.remove(teachingPlanEditorRef.current);
        teachingPlanEditorRef.current = null;
      }
    } catch (error) {
      console.error('ä¿å­˜æ•™æ¡ˆå¤±è´¥:', error);
    }
  };

  /**
   * å…³é—­æ•™æ¡ˆç¼–è¾‘å™¨
   */
  const handleCloseTeachingPlan = () => {
    setTeachingPlanModalVisible(false);
    
    // æ¸…ç†ç¼–è¾‘å™¨
    if (window.tinymce && teachingPlanEditorRef.current) {
      window.tinymce.remove(teachingPlanEditorRef.current);
      teachingPlanEditorRef.current = null;
    }
  };

  // Monacoç¼–è¾‘å™¨é…ç½®
  const editorOptions = {
    minimap: { enabled: false },
    fontSize: 14,
    fontFamily: 'SF Mono, Monaco, Consolas, monospace',
    formatOnPaste: true,
    formatOnType: true,
    automaticLayout: true,
    tabSize: 2,
    wordWrap: 'on',
    scrollBeyondLastLine: false,
    lineNumbers: 'on',
    renderWhitespace: 'selection',
    folding: true,
    bracketPairColorization: { enabled: true }
  };

  const handleEditorDidMount = (editor, monaco) => {
    setEditorReady(true);
  };

  if (currentLessonLoading || !currentLesson) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh',
        background: iosColors.bgSecondary
      }}>
        <SyncOutlined spin style={{ fontSize: 48, color: iosColors.primary }} />
      </div>
    );
  }

  return (
    <div style={{ 
      height: '100vh', 
      background: iosColors.bgSecondary,
      overflow: 'hidden',
      display: 'flex',
      flexDirection: 'column'
    }}>
      {/* é¡¶éƒ¨æ“ä½œæ  - ç™½è‰²å¡ç‰‡ */}
      <div style={{
        background: iosColors.cardWhite,
        padding: '16px 24px',
        borderRadius: '0 0 20px 20px',
        margin: '0 16px 16px 16px',
        boxShadow: iosColors.shadow,
        border: `1px solid ${iosColors.border}`,
        flexShrink: 0
      }}>
        {/* ç¬¬ä¸€è¡Œï¼šé¢åŒ…å±‘ + æ“ä½œæŒ‰é’® */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          marginBottom: 12
        }}>
          <Breadcrumb 
            separator={<span style={{ color: iosColors.textSecondary }}>â€º</span>}
          >
            <Breadcrumb.Item>
              <a 
                onClick={handleBack}
                style={{ 
                  color: iosColors.textSecondary,
                  fontSize: 13,
                  transition: 'color 0.2s'
                }}
                onMouseEnter={(e) => e.target.style.color = iosColors.primary}
                onMouseLeave={(e) => e.target.style.color = iosColors.textSecondary}
              >
                {currentLesson.module_name}
              </a>
            </Breadcrumb.Item>
            <Breadcrumb.Item style={{ color: iosColors.textPrimary, fontSize: 13, fontWeight: 500 }}>
              {t('teaching.editLesson')}
            </Breadcrumb.Item>
          </Breadcrumb>

          <Space size={12}>
            <Button 
              icon={<ArrowLeftOutlined />} 
              onClick={handleBack}
              style={{
                background: iosColors.cardWhite,
                border: `1px solid ${iosColors.border}`,
                borderRadius: 10,
                color: iosColors.textPrimary,
                height: 40,
                padding: '0 20px',
                fontWeight: 500,
                transition: 'all 0.2s',
                boxShadow: iosColors.shadow
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = iosColors.shadowHover;
                e.currentTarget.style.borderColor = iosColors.primary;
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = iosColors.shadow;
                e.currentTarget.style.borderColor = iosColors.border;
              }}
            >
              {t('common.back')}
            </Button>
            
            <Button 
              icon={<EyeOutlined />} 
              onClick={handlePreview}
              style={{
                background: iosColors.cardWhite,
                border: `1px solid ${iosColors.border}`,
                borderRadius: 10,
                color: iosColors.textPrimary,
                height: 40,
                padding: '0 20px',
                fontWeight: 500,
                transition: 'all 0.2s',
                boxShadow: iosColors.shadow
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = iosColors.shadowHover;
                e.currentTarget.style.borderColor = iosColors.primary;
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = iosColors.shadow;
                e.currentTarget.style.borderColor = iosColors.border;
              }}
            >
              {t('teaching.preview')}
            </Button>
            
            <Button
              type="primary"
              icon={<SaveOutlined />}
              onClick={handleSave}
              loading={isSaving}
              disabled={!lessonInfo.title.trim()}
              style={{
                background: `linear-gradient(135deg, ${iosColors.primary}, #5AC8FA)`,
                border: 'none',
                borderRadius: 10,
                color: '#FFFFFF',
                height: 40,
                padding: '0 24px',
                fontWeight: 600,
                boxShadow: `0 4px 12px rgba(10, 132, 255, 0.3)`,
                transition: 'all 0.2s'
              }}
              onMouseEnter={(e) => {
                if (!e.currentTarget.disabled) {
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.boxShadow = `0 6px 20px rgba(10, 132, 255, 0.4)`;
                }
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = `0 4px 12px rgba(10, 132, 255, 0.3)`;
              }}
            >
              {t('common.save')}
            </Button>
          </Space>
        </div>

        {/* ç¬¬äºŒè¡Œï¼šæ ‡é¢˜æ˜¾ç¤º + å†…å®¹ç±»å‹ */}
        <div style={{ 
          display: 'flex', 
          alignItems: 'center',
          gap: 16
        }}>
          <div 
            style={{
              flex: 1,
              display: 'flex',
              alignItems: 'center',
              gap: 12,
              background: iosColors.selectedBg,
              padding: '10px 16px',
              borderRadius: 10,
              border: `1px solid ${iosColors.border}`,
              borderLeft: `4px solid ${iosColors.primary}`
            }}
          >
            <FileTextOutlined style={{ 
              fontSize: 18,
              color: iosColors.primary
            }} />
            <h2 style={{ 
              margin: 0,
              fontSize: 16,
              fontWeight: 600,
              color: iosColors.textPrimary,
              flex: 1
            }}>
              {lessonInfo.title || t('teaching.lessonTitle')}
            </h2>
            <Tooltip title={t('teaching.editInfo')}>
              <Button
                type="text"
                size="small"
                icon={<EditOutlined />}
                onClick={handleEditTitle}
                style={{
                  color: iosColors.primary,
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(10, 132, 255, 0.1)';
                  e.currentTarget.style.transform = 'scale(1.1)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.transform = 'scale(1)';
                }}
              />
            </Tooltip>
          </div>

          <Select
            value={lessonInfo.content_type}
            onChange={(value) => setLessonInfo({ ...lessonInfo, content_type: value })}
            style={{ width: 160 }}
          >
            <Select.Option value="course">{t('teaching.contentTypes.course')}</Select.Option>
            <Select.Option value="experiment">{t('teaching.contentTypes.experiment')}</Select.Option>
            <Select.Option value="exercise">{t('teaching.contentTypes.exercise')}</Select.Option>
            <Select.Option value="reference">{t('teaching.contentTypes.reference')}</Select.Option>
            <Select.Option value="teaching_plan">{t('teaching.contentTypes.teaching_plan')}</Select.Option>
            <Select.Option value="answer">{t('teaching.contentTypes.answer')}</Select.Option>
            <Select.Option value="guide">{t('teaching.contentTypes.guide')}</Select.Option>
            <Select.Option value="assessment">{t('teaching.contentTypes.assessment')}</Select.Option>
          </Select>
        </div>
      </div>

      {/* ä¸»ä½“å†…å®¹ - ä¸‰æ å¸ƒå±€ */}
      <div style={{
        flex: 1,
        display: 'flex',
        gap: 16,
        padding: '0 16px 16px 16px',
        overflow: 'hidden'
      }}>
        {/* å·¦ä¾§ - é¡µé¢åˆ—è¡¨ï¼ˆç™½è‰²å¡ç‰‡ï¼‰*/}
        <div style={{
          width: 300,
          background: iosColors.cardWhite,
          borderRadius: 20,
          border: `1px solid ${iosColors.border}`,
          boxShadow: iosColors.shadow,
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}>
          <div style={{ 
            padding: '20px',
            height: '100%',
            display: 'flex',
            flexDirection: 'column'
          }}>
            <div style={{ 
              display: 'flex', 
              justifyContent: 'space-between', 
              alignItems: 'center',
              marginBottom: 16
            }}>
              <h4 style={{ 
                margin: 0,
                color: iosColors.textPrimary,
                fontSize: 16,
                fontWeight: 600,
                display: 'flex',
                alignItems: 'center',
                gap: 8
              }}>
                <FileTextOutlined style={{ color: iosColors.primary, fontSize: 18 }} />
                {t('teaching.pageManagement')}
              </h4>
              <Badge 
                count={pages.length} 
                showZero 
                style={{ 
                  background: iosColors.primary,
                  boxShadow: `0 2px 8px rgba(10, 132, 255, 0.3)`
                }}
              />
            </div>

            <Button
              icon={<PlusOutlined />}
              onClick={handleAddPage}
              block
              style={{
                background: iosColors.cardWhite,
                border: `1px dashed ${iosColors.primary}`,
                borderRadius: 12,
                color: iosColors.primary,
                height: 44,
                marginBottom: 16,
                fontWeight: 500,
                transition: 'all 0.2s'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = iosColors.selectedBg;
                e.currentTarget.style.borderStyle = 'solid';
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = iosColors.shadowHover;
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = iosColors.cardWhite;
                e.currentTarget.style.borderStyle = 'dashed';
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = 'none';
              }}
            >
              {t('teaching.addPage')}
            </Button>

            <div style={{ flex: 1, overflow: 'auto', marginRight: -8, paddingRight: 8 }}>
              <List
                size="small"
                dataSource={pages}
                renderItem={(page, index) => {
                  const isActive = index === currentPageIndex;
                  return (
                    <List.Item
                      key={page.id}
                      style={{
                        background: isActive ? iosColors.selectedBg : 'transparent',
                        padding: '12px 16px',
                        borderRadius: 12,
                        marginBottom: 10,
                        cursor: 'pointer',
                        border: `1px solid ${isActive ? iosColors.border : 'transparent'}`,
                        borderLeft: isActive ? `4px solid ${iosColors.primary}` : '4px solid transparent',
                        boxShadow: isActive ? iosColors.shadow : 'none',
                        transition: 'all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1)'
                      }}
                      onClick={() => handlePageChange(index)}
                      onMouseEnter={(e) => {
                        if (!isActive) {
                          e.currentTarget.style.background = iosColors.hoverBg;
                          e.currentTarget.style.borderColor = iosColors.border;
                        }
                      }}
                      onMouseLeave={(e) => {
                        if (!isActive) {
                          e.currentTarget.style.background = 'transparent';
                          e.currentTarget.style.borderColor = 'transparent';
                        }
                      }}
                    >
                      <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: 10 }}>
                        <FileTextOutlined 
                          style={{ 
                            color: isActive ? iosColors.primary : iosColors.textSecondary,
                            fontSize: 16
                          }} 
                        />
                        <span style={{ 
                          fontWeight: isActive ? 600 : 400,
                          color: isActive ? iosColors.textPrimary : iosColors.textSecondary,
                          flex: 1
                        }}>
                          {page.title}
                        </span>
                      </div>
                      <Space size={4}>
                        <Tooltip title={t('teaching.editTeachingPlan')}>
                          <Button
                            type="text"
                            size="small"
                            icon={<BookOutlined />}
                            onClick={(e) => {
                              e.stopPropagation();
                              handleOpenTeachingPlan(index);
                            }}
                            style={{
                              color: iosColors.warning,
                              transition: 'all 0.2s'
                            }}
                          />
                        </Tooltip>
                        <Tooltip title={t('common.edit')}>
                          <Button
                            type="text"
                            size="small"
                            icon={<EditOutlined />}
                            onClick={(e) => {
                              e.stopPropagation();
                              handleEditPage(index);
                            }}
                            style={{
                              color: isActive ? iosColors.primary : iosColors.textSecondary,
                              transition: 'all 0.2s'
                            }}
                          />
                        </Tooltip>
                        {pages.length > 1 && (
                          <Popconfirm
                            title={t('teaching.confirmDeletePage')}
                            onConfirm={(e) => {
                              e.stopPropagation();
                              handleDeletePage(index);
                            }}
                            okText={t('common.confirm')}
                            cancelText={t('common.cancel')}
                          >
                            <Tooltip title={t('common.delete')}>
                              <Button
                                type="text"
                                size="small"
                                danger
                                icon={<DeleteOutlined />}
                                onClick={(e) => e.stopPropagation()}
                                style={{
                                  color: iosColors.danger,
                                  transition: 'all 0.2s'
                                }}
                              />
                            </Tooltip>
                          </Popconfirm>
                        )}
                      </Space>
                    </List.Item>
                  );
                }}
              />
            </div>
          </div>
        </div>

        {/* ä¸­é—´ - Monacoç¼–è¾‘å™¨ï¼ˆç™½è‰²å¡ç‰‡ï¼‰*/}
        <div style={{ 
          flex: 1,
          display: 'flex', 
          flexDirection: 'column',
          background: iosColors.cardWhite,
          borderRadius: 20,
          border: `1px solid ${iosColors.border}`,
          boxShadow: iosColors.shadow,
          overflow: 'hidden'
        }}>
          <div style={{
            padding: '12px 20px',
            background: iosColors.bgSecondary,
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            borderBottom: `1px solid ${iosColors.border}`,
            flexShrink: 0
          }}>
            <span style={{ 
              fontWeight: 600,
              fontSize: 14,
              color: iosColors.textPrimary
            }}>
              {t('teaching.htmlEditor')}: {pages[currentPageIndex]?.title}
            </span>
            <span style={{ 
              fontSize: 12,
              color: editorReady ? iosColors.success : iosColors.textSecondary,
              display: 'flex',
              alignItems: 'center',
              gap: 6
            }}>
              <span style={{
                width: 6,
                height: 6,
                borderRadius: '50%',
                background: editorReady ? iosColors.success : iosColors.textSecondary,
                boxShadow: editorReady ? `0 0 10px ${iosColors.success}` : 'none'
              }} />
              {editorReady ? t('teaching.editorReady') : t('teaching.editorLoading')}
            </span>
          </div>

          <div style={{ 
            flex: 1,
            background: '#1e1e1e',
            overflow: 'hidden'
          }}>
            <Editor
              height="100%"
              language="html"
              theme="vs-dark"
              value={htmlContent}
              onChange={(value) => setHtmlContent(value || '')}
              options={editorOptions}
              onMount={handleEditorDidMount}
            />
          </div>
        </div>

        {/* å³ä¾§ - å®æ—¶é¢„è§ˆï¼ˆç™½è‰²å¡ç‰‡ï¼‰*/}
        <div style={{
          width: 800,
          background: iosColors.cardWhite,
          borderRadius: 20,
          border: `1px solid ${iosColors.border}`,
          boxShadow: iosColors.shadow,
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}>
          <div style={{
            padding: '12px 20px',
            background: iosColors.bgSecondary,
            borderBottom: `1px solid ${iosColors.border}`,
            display: 'flex',
            alignItems: 'center',
            gap: 8,
            flexShrink: 0
          }}>
            <EyeOutlined style={{ color: iosColors.primary, fontSize: 16 }} />
            <span style={{ 
              fontWeight: 600,
              fontSize: 14,
              color: iosColors.textPrimary
            }}>
              {t('teaching.realTimePreview')}
            </span>
          </div>

          <div style={{ 
            flex: 1,
            overflow: 'auto',
            background: iosColors.cardWhite
          }}>
            <iframe
              srcDoc={previewContent}
              style={{
                width: '100%',
                height: '100%',
                border: 'none',
                display: 'block'
              }}
              sandbox="allow-scripts allow-forms allow-modals allow-popups allow-same-origin"
              title="Preview"
            />
          </div>
        </div>
      </div>

      {/* é¡µé¢æ ‡é¢˜ç¼–è¾‘æ¨¡æ€æ¡† */}
      <Modal
        title={<span style={{ color: iosColors.textPrimary, fontSize: 18, fontWeight: 600 }}>{editingPageIndex !== null ? t('teaching.editPageTitle') : t('teaching.addPage')}</span>}
        open={pageModalVisible}
        onOk={handlePageSubmit}
        onCancel={() => { setPageModalVisible(false); pageForm.resetFields(); }}
        okText={t('common.confirm')}
        cancelText={t('common.cancel')}
        okButtonProps={{
          style: {
            background: `linear-gradient(135deg, ${iosColors.primary}, #5AC8FA)`,
            border: 'none',
            borderRadius: 8,
            height: 40,
            fontWeight: 600
          }
        }}
        cancelButtonProps={{
          style: {
            background: iosColors.cardWhite,
            border: `1px solid ${iosColors.border}`,
            borderRadius: 8,
            color: iosColors.textPrimary,
            height: 40
          }
        }}
      >
        <Form form={pageForm} layout="vertical">
          <Form.Item name="title" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.pageTitle')}</span>} rules={[{ required: true, message: t('teaching.pageTitleRequired') }]}>
            <Input 
              placeholder={t('teaching.pageTitlePlaceholder')}
              style={{
                height: 44,
                borderRadius: 10,
                fontSize: 15
              }}
            />
          </Form.Item>
        </Form>
      </Modal>

      {/* è¯¾ç¨‹ä¿¡æ¯ç¼–è¾‘æ¨¡æ€æ¡† */}
      <Modal
        title={<span style={{ color: iosColors.textPrimary, fontSize: 18, fontWeight: 600 }}>{t('teaching.editLessonInfo')}</span>}
        open={titleEditModalVisible}
        onOk={handleTitleSubmit}
        onCancel={() => { setTitleEditModalVisible(false); titleForm.resetFields(); }}
        width={600}
        okButtonProps={{
          style: {
            background: `linear-gradient(135deg, ${iosColors.primary}, #5AC8FA)`,
            border: 'none',
            borderRadius: 8,
            height: 40,
            fontWeight: 600
          }
        }}
        cancelButtonProps={{
          style: {
            background: iosColors.cardWhite,
            border: `1px solid ${iosColors.border}`,
            borderRadius: 8,
            color: iosColors.textPrimary,
            height: 40
          }
        }}
      >
        <Form form={titleForm} layout="vertical">
          <Form.Item name="title" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.lessonTitle')}</span>} rules={[{ required: true }]}>
            <Input 
              style={{
                height: 44,
                borderRadius: 10,
                fontSize: 15
              }}
            />
          </Form.Item>
          <Form.Item name="description" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.lessonDescription')}</span>}>
            <Input.TextArea 
              rows={3}
              style={{
                borderRadius: 10,
                fontSize: 14
              }}
            />
          </Form.Item>
          <Form.Item name="content_type" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.contentType')}</span>}>
            <Select style={{ height: 44 }}>
              <Select.Option value="course">{t('teaching.contentTypes.course')}</Select.Option>
              <Select.Option value="experiment">{t('teaching.contentTypes.experiment')}</Select.Option>
              <Select.Option value="exercise">{t('teaching.contentTypes.exercise')}</Select.Option>
              <Select.Option value="reference">{t('teaching.contentTypes.reference')}</Select.Option>
              <Select.Option value="teaching_plan">{t('teaching.contentTypes.teaching_plan')}</Select.Option>
              <Select.Option value="answer">{t('teaching.contentTypes.answer')}</Select.Option>
              <Select.Option value="guide">{t('teaching.contentTypes.guide')}</Select.Option>
              <Select.Option value="assessment">{t('teaching.contentTypes.assessment')}</Select.Option>
            </Select>
          </Form.Item>
        </Form>
      </Modal>

      {/* æ•™æ¡ˆç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆä¿®å¤ç‰ˆï¼‰*/}
      <Modal
        title={
          <span style={{ color: iosColors.textPrimary, fontSize: 18, fontWeight: 600 }}>
            <BookOutlined style={{ marginRight: 8, color: iosColors.warning }} />
            {t('teaching.editTeachingPlan')} - {pages[currentTeachingPlanPageIndex]?.title}
          </span>
        }
        open={teachingPlanModalVisible}
        onOk={handleSaveTeachingPlan}
        onCancel={handleCloseTeachingPlan}
        width={1000}
        okText={t('teaching.saveTeachingPlan')}
        cancelText={t('common.cancel')}
        confirmLoading={teachingPlanSaving}
        okButtonProps={{
          style: {
            background: `linear-gradient(135deg, ${iosColors.warning}, #FFB340)`,
            border: 'none',
            borderRadius: 8,
            height: 40,
            fontWeight: 600
          }
        }}
        cancelButtonProps={{
          style: {
            background: iosColors.cardWhite,
            border: `1px solid ${iosColors.border}`,
            borderRadius: 8,
            color: iosColors.textPrimary,
            height: 40
          }
        }}
        bodyStyle={{ padding: '24px' }}
      >
        <Spin spinning={teachingPlanLoading} tip={t('teaching.loadingTeachingPlan')}>
          <div style={{ minHeight: 500 }}>
            <textarea 
              id="teachingPlanEditor" 
              style={{ width: '100%', height: '500px', display: 'none' }}
            />
          </div>
        </Spin>
      </Modal>
    </div>
  );
};

export default LessonEditor;
