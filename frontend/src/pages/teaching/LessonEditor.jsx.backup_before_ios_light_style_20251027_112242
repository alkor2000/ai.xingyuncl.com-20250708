/**
 * 课程编辑器组件（布局优化版）
 * 修复：保持预览功能正常，优化整体三栏布局
 * 三栏布局：左侧页面管理(300px) | 中间Monaco编辑器(flex) | 右侧实时预览(800px)
 */

import React, { useState, useEffect } from 'react';
import {
  Layout,
  Button,
  Input,
  List,
  Space,
  Breadcrumb,
  message,
  Modal,
  Form,
  Select,
  Tooltip,
  Popconfirm,
  Badge
} from 'antd';
import {
  SaveOutlined,
  PlusOutlined,
  DeleteOutlined,
  EyeOutlined,
  ArrowLeftOutlined,
  FileTextOutlined,
  EditOutlined,
  SyncOutlined
} from '@ant-design/icons';
import Editor from '@monaco-editor/react';
import { useParams, useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import useTeachingStore from '../../stores/teachingStore';

const { Sider, Content } = Layout;

// 清爽蓝色配色方案
const iosColors = {
  primary: '#0A84FF',
  success: '#30D158',
  warning: '#FF9F0A',
  danger: '#FF453A',
  glass: 'rgba(255, 255, 255, 0.15)',
  glassBorder: 'rgba(255, 255, 255, 0.25)',
  textPrimary: '#FFFFFF',
  textSecondary: 'rgba(255, 255, 255, 0.8)',
  cardDark: 'rgba(0, 0, 0, 0.25)',
  selectedGlow: 'rgba(10, 132, 255, 0.5)'
};

const LessonEditor = () => {
  const { t } = useTranslation();
  const { id } = useParams();
  const navigate = useNavigate();

  const {
    currentLesson,
    currentLessonLoading,
    fetchLesson,
    updateLesson
  } = useTeachingStore();

  // 页面状态
  const [pages, setPages] = useState([
    { id: 1, title: 'Page 1', html: '<h1>新页面</h1>' }
  ]);
  const [currentPageIndex, setCurrentPageIndex] = useState(0);
  const [htmlContent, setHtmlContent] = useState('');
  const [lessonInfo, setLessonInfo] = useState({
    title: '',
    description: '',
    content_type: 'course',
    status: 'draft'
  });

  // UI状态
  const [isSaving, setIsSaving] = useState(false);
  const [previewContent, setPreviewContent] = useState('');
  const [pageModalVisible, setPageModalVisible] = useState(false);
  const [titleEditModalVisible, setTitleEditModalVisible] = useState(false);
  const [editingPageIndex, setEditingPageIndex] = useState(null);
  const [editorReady, setEditorReady] = useState(false);

  const [pageForm] = Form.useForm();
  const [titleForm] = Form.useForm();

  // 加载课程数据
  useEffect(() => {
    if (id) {
      loadLessonData();
    }
  }, [id]);

  const loadLessonData = async () => {
    try {
      const lesson = await fetchLesson(id);
      
      setLessonInfo({
        title: lesson.title,
        description: lesson.description,
        content_type: lesson.content_type,
        status: lesson.status
      });

      if (lesson.content) {
        const content = typeof lesson.content === 'string'
          ? JSON.parse(lesson.content)
          : lesson.content;
        
        if (content.pages && content.pages.length > 0) {
          setPages(content.pages);
          setHtmlContent(content.pages[0].html || '');
        }
      }
    } catch (error) {
      message.error(t('teaching.loadFailed'));
    }
  };

  // 实时预览更新
  useEffect(() => {
    setPreviewContent(htmlContent || '<div style="padding:20px;color:#999;">开始编写内容...</div>');
  }, [htmlContent]);

  // 保存当前页面到pages数组
  const saveCurrentPageContent = () => {
    const newPages = [...pages];
    newPages[currentPageIndex] = {
      ...newPages[currentPageIndex],
      html: htmlContent
    };
    setPages(newPages);
    return newPages;
  };

  // 切换页面
  const handlePageChange = (index) => {
    const newPages = saveCurrentPageContent();
    setCurrentPageIndex(index);
    setHtmlContent(newPages[index].html || '');
  };

  // 添加页面
  const handleAddPage = () => {
    pageForm.setFieldsValue({ title: `Page ${pages.length + 1}` });
    setEditingPageIndex(null);
    setPageModalVisible(true);
  };

  // 编辑页面标题
  const handleEditPage = (index) => {
    pageForm.setFieldsValue({ title: pages[index].title });
    setEditingPageIndex(index);
    setPageModalVisible(true);
  };

  // 确认页面操作
  const handlePageSubmit = async () => {
    try {
      const values = await pageForm.validateFields();
      
      if (editingPageIndex !== null) {
        const newPages = [...pages];
        newPages[editingPageIndex].title = values.title;
        setPages(newPages);
        message.success(t('teaching.updateSuccess'));
      } else {
        const newPage = {
          id: Date.now(),
          title: values.title,
          html: '<h1>新页面</h1>'
        };
        setPages([...pages, newPage]);
        message.success(t('teaching.pageAdded'));
      }
      
      setPageModalVisible(false);
      pageForm.resetFields();
    } catch (error) {
      console.error('页面操作失败:', error);
    }
  };

  // 删除页面
  const handleDeletePage = (index) => {
    if (pages.length === 1) {
      message.warning(t('teaching.lastPageCannotDelete'));
      return;
    }

    const newPages = pages.filter((_, i) => i !== index);
    setPages(newPages);
    
    if (index === currentPageIndex) {
      setCurrentPageIndex(0);
      setHtmlContent(newPages[0].html || '');
    } else if (index < currentPageIndex) {
      setCurrentPageIndex(currentPageIndex - 1);
    }
    
    message.success(t('teaching.deleteSuccess'));
  };

  // 打开标题编辑模态框
  const handleEditTitle = () => {
    titleForm.setFieldsValue({
      title: lessonInfo.title,
      description: lessonInfo.description,
      content_type: lessonInfo.content_type
    });
    setTitleEditModalVisible(true);
  };

  // 确认标题编辑
  const handleTitleSubmit = async () => {
    try {
      const values = await titleForm.validateFields();
      setLessonInfo({
        ...lessonInfo,
        ...values
      });
      setTitleEditModalVisible(false);
      message.success(t('teaching.updateSuccess'));
    } catch (error) {
      console.error('标题编辑失败:', error);
    }
  };

  // 保存课程
  const handleSave = async () => {
    if (!lessonInfo.title.trim()) {
      message.warning(t('teaching.lessonTitleRequired'));
      return;
    }

    setIsSaving(true);
    try {
      const finalPages = saveCurrentPageContent();

      const updateData = {
        title: lessonInfo.title,
        description: lessonInfo.description,
        content_type: lessonInfo.content_type,
        status: lessonInfo.status,
        content: JSON.stringify({ pages: finalPages })
      };

      await updateLesson(id, updateData);
      message.success(t('teaching.saveSuccess'));
    } catch (error) {
      message.error(t('teaching.saveFailed'));
    } finally {
      setIsSaving(false);
    }
  };

  // 返回课程页面列表
  const handleBack = () => {
    navigate(`/teaching/lessons/${id}`);
  };

  // 预览第一页
  const handlePreview = () => {
    navigate(`/teaching/lessons/${id}/pages/1`);
  };

  // Monaco编辑器配置
  const editorOptions = {
    minimap: { enabled: false },
    fontSize: 14,
    fontFamily: 'SF Mono, Monaco, Consolas, monospace',
    formatOnPaste: true,
    formatOnType: true,
    automaticLayout: true,
    tabSize: 2,
    wordWrap: 'on',
    scrollBeyondLastLine: false,
    lineNumbers: 'on',
    renderWhitespace: 'selection',
    folding: true,
    bracketPairColorization: { enabled: true }
  };

  const handleEditorDidMount = (editor, monaco) => {
    setEditorReady(true);
  };

  if (currentLessonLoading || !currentLesson) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh',
        background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
      }}>
        <SyncOutlined spin style={{ fontSize: 48, color: iosColors.textPrimary }} />
      </div>
    );
  }

  return (
    <div style={{ 
      height: '100vh', 
      background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
      overflow: 'hidden',
      display: 'flex',
      flexDirection: 'column'
    }}>
      {/* 顶部操作栏 */}
      <div style={{
        background: iosColors.cardDark,
        backdropFilter: 'blur(16px)',
        WebkitBackdropFilter: 'blur(16px)',
        padding: '16px 24px',
        borderRadius: '0 0 20px 20px',
        margin: '0 16px 16px 16px',
        boxShadow: '0 4px 20px rgba(0, 0, 0, 0.2)',
        border: `1px solid ${iosColors.glassBorder}`,
        flexShrink: 0
      }}>
        {/* 第一行：面包屑 + 操作按钮 */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          marginBottom: 12
        }}>
          <Breadcrumb 
            separator={<span style={{ color: iosColors.textSecondary }}>›</span>}
          >
            <Breadcrumb.Item>
              <a 
                onClick={handleBack}
                style={{ 
                  color: iosColors.textSecondary,
                  fontSize: 13,
                  transition: 'color 0.2s'
                }}
                onMouseEnter={(e) => e.target.style.color = iosColors.textPrimary}
                onMouseLeave={(e) => e.target.style.color = iosColors.textSecondary}
              >
                {currentLesson.module_name}
              </a>
            </Breadcrumb.Item>
            <Breadcrumb.Item style={{ color: iosColors.textPrimary, fontSize: 13 }}>
              {t('teaching.editLesson')}
            </Breadcrumb.Item>
          </Breadcrumb>

          <Space size={12}>
            <Button 
              icon={<ArrowLeftOutlined />} 
              onClick={handleBack}
              style={{
                background: 'rgba(255, 255, 255, 0.2)',
                backdropFilter: 'blur(10px)',
                border: `1px solid ${iosColors.glassBorder}`,
                borderRadius: 10,
                color: iosColors.textPrimary,
                height: 40,
                padding: '0 20px',
                fontWeight: 500
              }}
            >
              {t('common.back')}
            </Button>
            
            <Button 
              icon={<EyeOutlined />} 
              onClick={handlePreview}
              style={{
                background: 'rgba(255, 255, 255, 0.2)',
                backdropFilter: 'blur(10px)',
                border: `1px solid ${iosColors.glassBorder}`,
                borderRadius: 10,
                color: iosColors.textPrimary,
                height: 40,
                padding: '0 20px',
                fontWeight: 500
              }}
            >
              {t('teaching.preview')}
            </Button>
            
            <Button
              type="primary"
              icon={<SaveOutlined />}
              onClick={handleSave}
              loading={isSaving}
              disabled={!lessonInfo.title.trim()}
              style={{
                background: `linear-gradient(135deg, ${iosColors.primary}, #5AC8FA)`,
                border: 'none',
                borderRadius: 10,
                color: iosColors.textPrimary,
                height: 40,
                padding: '0 24px',
                fontWeight: 600,
                boxShadow: `0 4px 12px ${iosColors.selectedGlow}`
              }}
            >
              {t('common.save')}
            </Button>
          </Space>
        </div>

        {/* 第二行：标题显示 + 内容类型 */}
        <div style={{ 
          display: 'flex', 
          alignItems: 'center',
          gap: 16
        }}>
          <div 
            style={{
              flex: 1,
              display: 'flex',
              alignItems: 'center',
              gap: 12,
              background: 'rgba(255, 255, 255, 0.12)',
              backdropFilter: 'blur(10px)',
              padding: '10px 16px',
              borderRadius: 10,
              border: `1px solid ${iosColors.glassBorder}`
            }}
          >
            <FileTextOutlined style={{ 
              fontSize: 18,
              color: iosColors.primary
            }} />
            <h2 style={{ 
              margin: 0,
              fontSize: 16,
              fontWeight: 600,
              color: iosColors.textPrimary,
              flex: 1
            }}>
              {lessonInfo.title || t('teaching.lessonTitle')}
            </h2>
            <Tooltip title={t('teaching.editInfo')}>
              <Button
                type="text"
                size="small"
                icon={<EditOutlined />}
                onClick={handleEditTitle}
                style={{
                  color: iosColors.textSecondary
                }}
              />
            </Tooltip>
          </div>

          <Select
            value={lessonInfo.content_type}
            onChange={(value) => setLessonInfo({ ...lessonInfo, content_type: value })}
            style={{ width: 160 }}
          >
            <Select.Option value="course">{t('teaching.contentTypes.course')}</Select.Option>
            <Select.Option value="experiment">{t('teaching.contentTypes.experiment')}</Select.Option>
            <Select.Option value="exercise">{t('teaching.contentTypes.exercise')}</Select.Option>
            <Select.Option value="reference">{t('teaching.contentTypes.reference')}</Select.Option>
            <Select.Option value="teaching_plan">{t('teaching.contentTypes.teaching_plan')}</Select.Option>
            <Select.Option value="answer">{t('teaching.contentTypes.answer')}</Select.Option>
            <Select.Option value="guide">{t('teaching.contentTypes.guide')}</Select.Option>
            <Select.Option value="assessment">{t('teaching.contentTypes.assessment')}</Select.Option>
          </Select>
        </div>
      </div>

      {/* 主体内容 - 三栏布局 */}
      <div style={{
        flex: 1,
        display: 'flex',
        gap: 2,
        padding: '0 16px 16px 16px',
        overflow: 'hidden'
      }}>
        {/* 左侧 - 页面列表 (300px固定宽度) */}
        <div style={{
          width: 300,
          background: iosColors.cardDark,
          backdropFilter: 'blur(16px)',
          WebkitBackdropFilter: 'blur(16px)',
          borderRadius: '20px 0 0 20px',
          border: `1px solid ${iosColors.glassBorder}`,
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}>
          <div style={{ 
            padding: '20px',
            height: '100%',
            display: 'flex',
            flexDirection: 'column'
          }}>
            <div style={{ 
              display: 'flex', 
              justifyContent: 'space-between', 
              alignItems: 'center',
              marginBottom: 16
            }}>
              <h4 style={{ 
                margin: 0,
                color: iosColors.textPrimary,
                fontSize: 16,
                fontWeight: 600,
                display: 'flex',
                alignItems: 'center',
                gap: 8
              }}>
                <FileTextOutlined style={{ color: iosColors.primary }} />
                {t('teaching.pageManagement')}
              </h4>
              <Badge 
                count={pages.length} 
                showZero 
                style={{ 
                  background: `linear-gradient(135deg, ${iosColors.primary}, #5AC8FA)`,
                  boxShadow: `0 2px 8px ${iosColors.selectedGlow}`
                }}
              />
            </div>

            <Button
              icon={<PlusOutlined />}
              onClick={handleAddPage}
              block
              style={{
                background: 'rgba(255, 255, 255, 0.15)',
                backdropFilter: 'blur(10px)',
                border: `1px dashed ${iosColors.glassBorder}`,
                borderRadius: 12,
                color: iosColors.textPrimary,
                height: 44,
                marginBottom: 16,
                fontWeight: 500
              }}
            >
              {t('teaching.addPage')}
            </Button>

            <div style={{ flex: 1, overflow: 'auto', marginRight: -8, paddingRight: 8 }}>
              <List
                size="small"
                dataSource={pages}
                renderItem={(page, index) => {
                  const isActive = index === currentPageIndex;
                  return (
                    <List.Item
                      key={page.id}
                      style={{
                        background: isActive 
                          ? `linear-gradient(90deg, ${iosColors.primary}, #5AC8FA)`
                          : 'transparent',
                        padding: '12px 16px',
                        borderRadius: 12,
                        marginBottom: 10,
                        cursor: 'pointer',
                        border: isActive ? 'none' : `1px solid transparent`,
                        boxShadow: isActive ? `0 0 20px ${iosColors.selectedGlow}` : 'none'
                      }}
                      onClick={() => handlePageChange(index)}
                    >
                      <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: 10 }}>
                        <FileTextOutlined 
                          style={{ 
                            color: isActive ? iosColors.textPrimary : iosColors.primary,
                            fontSize: 16
                          }} 
                        />
                        <span style={{ 
                          fontWeight: isActive ? 600 : 400,
                          color: isActive ? iosColors.textPrimary : iosColors.textSecondary,
                          flex: 1
                        }}>
                          {page.title}
                        </span>
                      </div>
                      <Space size={4}>
                        <Tooltip title={t('common.edit')}>
                          <Button
                            type="text"
                            size="small"
                            icon={<EditOutlined />}
                            onClick={(e) => {
                              e.stopPropagation();
                              handleEditPage(index);
                            }}
                            style={{
                              color: isActive ? iosColors.textPrimary : iosColors.textSecondary
                            }}
                          />
                        </Tooltip>
                        {pages.length > 1 && (
                          <Popconfirm
                            title={t('teaching.confirmDeletePage')}
                            onConfirm={(e) => {
                              e.stopPropagation();
                              handleDeletePage(index);
                            }}
                            okText={t('common.confirm')}
                            cancelText={t('common.cancel')}
                          >
                            <Tooltip title={t('common.delete')}>
                              <Button
                                type="text"
                                size="small"
                                danger
                                icon={<DeleteOutlined />}
                                onClick={(e) => e.stopPropagation()}
                                style={{
                                  color: isActive ? iosColors.textPrimary : iosColors.danger
                                }}
                              />
                            </Tooltip>
                          </Popconfirm>
                        )}
                      </Space>
                    </List.Item>
                  );
                }}
              />
            </div>
          </div>
        </div>

        {/* 中间 - Monaco编辑器 (flex自动填充) */}
        <div style={{ 
          flex: 1,
          display: 'flex', 
          flexDirection: 'column',
          background: iosColors.cardDark,
          backdropFilter: 'blur(16px)',
          WebkitBackdropFilter: 'blur(16px)',
          border: `1px solid ${iosColors.glassBorder}`,
          overflow: 'hidden'
        }}>
          <div style={{
            padding: '12px 20px',
            background: 'rgba(0, 0, 0, 0.2)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            borderBottom: `1px solid ${iosColors.glassBorder}`,
            flexShrink: 0
          }}>
            <span style={{ 
              fontWeight: 600,
              fontSize: 14,
              color: iosColors.textPrimary
            }}>
              {t('teaching.htmlEditor')}: {pages[currentPageIndex]?.title}
            </span>
            <span style={{ 
              fontSize: 12,
              color: editorReady ? iosColors.success : iosColors.textSecondary,
              display: 'flex',
              alignItems: 'center',
              gap: 6
            }}>
              <span style={{
                width: 6,
                height: 6,
                borderRadius: '50%',
                background: editorReady ? iosColors.success : iosColors.textSecondary,
                boxShadow: editorReady ? `0 0 10px ${iosColors.success}` : 'none'
              }} />
              {editorReady ? t('teaching.editorReady') : t('teaching.editorLoading')}
            </span>
          </div>

          <div style={{ 
            flex: 1,
            background: '#1e1e1e',
            overflow: 'hidden'
          }}>
            <Editor
              height="100%"
              language="html"
              theme="vs-dark"
              value={htmlContent}
              onChange={(value) => setHtmlContent(value || '')}
              options={editorOptions}
              onMount={handleEditorDidMount}
            />
          </div>
        </div>

        {/* 右侧 - 实时预览 (800px固定宽度) */}
        <div style={{
          width: 800,
          background: '#ffffff',
          borderRadius: '0 20px 20px 0',
          border: `1px solid ${iosColors.glassBorder}`,
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}>
          <div style={{
            padding: '12px 20px',
            background: iosColors.cardDark,
            backdropFilter: 'blur(16px)',
            WebkitBackdropFilter: 'blur(16px)',
            borderBottom: `1px solid ${iosColors.glassBorder}`,
            borderRadius: '0 20px 0 0',
            display: 'flex',
            alignItems: 'center',
            gap: 8,
            flexShrink: 0
          }}>
            <EyeOutlined style={{ color: iosColors.primary, fontSize: 16 }} />
            <span style={{ 
              fontWeight: 600,
              fontSize: 14,
              color: iosColors.textPrimary
            }}>
              {t('teaching.realTimePreview')}
            </span>
          </div>

          <div style={{ 
            flex: 1,
            overflow: 'auto',
            background: '#ffffff'
          }}>
            <iframe
              srcDoc={previewContent}
              style={{
                width: '100%',
                height: '100%',
                border: 'none',
                display: 'block'
              }}
              sandbox="allow-scripts allow-forms allow-modals allow-popups allow-same-origin"
              title="Preview"
            />
          </div>
        </div>
      </div>

      {/* 模态框 */}
      <Modal
        title={<span style={{ color: iosColors.textPrimary, fontSize: 18, fontWeight: 600 }}>{editingPageIndex !== null ? t('teaching.editPageTitle') : t('teaching.addPage')}</span>}
        open={pageModalVisible}
        onOk={handlePageSubmit}
        onCancel={() => { setPageModalVisible(false); pageForm.resetFields(); }}
        okText={t('common.confirm')}
        cancelText={t('common.cancel')}
      >
        <Form form={pageForm} layout="vertical">
          <Form.Item name="title" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.pageTitle')}</span>} rules={[{ required: true, message: t('teaching.pageTitleRequired') }]}>
            <Input placeholder={t('teaching.pageTitlePlaceholder')} />
          </Form.Item>
        </Form>
      </Modal>

      <Modal
        title={<span style={{ color: iosColors.textPrimary, fontSize: 18, fontWeight: 600 }}>{t('teaching.editLessonInfo')}</span>}
        open={titleEditModalVisible}
        onOk={handleTitleSubmit}
        onCancel={() => { setTitleEditModalVisible(false); titleForm.resetFields(); }}
        width={600}
      >
        <Form form={titleForm} layout="vertical">
          <Form.Item name="title" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.lessonTitle')}</span>} rules={[{ required: true }]}>
            <Input />
          </Form.Item>
          <Form.Item name="description" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.lessonDescription')}</span>}>
            <Input.TextArea rows={3} />
          </Form.Item>
          <Form.Item name="content_type" label={<span style={{ color: iosColors.textPrimary }}>{t('teaching.contentType')}</span>}>
            <Select>
              <Select.Option value="course">{t('teaching.contentTypes.course')}</Select.Option>
              <Select.Option value="experiment">{t('teaching.contentTypes.experiment')}</Select.Option>
              <Select.Option value="exercise">{t('teaching.contentTypes.exercise')}</Select.Option>
              <Select.Option value="reference">{t('teaching.contentTypes.reference')}</Select.Option>
              <Select.Option value="teaching_plan">{t('teaching.contentTypes.teaching_plan')}</Select.Option>
              <Select.Option value="answer">{t('teaching.contentTypes.answer')}</Select.Option>
              <Select.Option value="guide">{t('teaching.contentTypes.guide')}</Select.Option>
              <Select.Option value="assessment">{t('teaching.contentTypes.assessment')}</Select.Option>
            </Select>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default LessonEditor;
