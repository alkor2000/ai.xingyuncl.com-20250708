/**
 * è¯¾ç¨‹é¡µé¢æŸ¥çœ‹å™¨ï¼ˆiOSé£æ ¼ç‰ˆ + æ•™æ¡ˆæŸ¥çœ‹åŠŸèƒ½ï¼‰
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºå’Œæµè§ˆè¯¾ç¨‹çš„å…·ä½“é¡µé¢å†…å®¹ï¼Œæ”¯æŒæŸ¥çœ‹æ•™æ¡ˆ
 * v1.2.0 - 2025-10-30ï¼šæ–°å¢æ•™æ¡ˆæŸ¥çœ‹æŠ½å±‰
 */

import React, { useEffect, useState, useRef } from 'react';
import {
  Button,
  Progress,
  Tooltip,
  message,
  Dropdown,
  Drawer,
  Spin,
  Empty
} from 'antd';
import {
  ArrowLeftOutlined,
  EditOutlined,
  LeftOutlined,
  RightOutlined,
  FullscreenOutlined,
  FullscreenExitOutlined,
  EllipsisOutlined,
  UnorderedListOutlined,
  AimOutlined,
  BookOutlined
} from '@ant-design/icons';
import { useParams, useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import useTeachingStore from '../../stores/teachingStore';
import useAuthStore from '../../stores/authStore';
import {
  IOSPageContainer,
  IOSNavBar,
  IOSButton,
  IOSEmpty,
  IOSLoading
} from '../../components/teaching/IOSLayout';
import '../../styles/ios-unified-theme.css';

const LessonViewer = () => {
  const { t } = useTranslation();
  const { id, pageNumber } = useParams();
  const navigate = useNavigate();
  const { user } = useAuthStore();

  const {
    currentLesson,
    currentModule,
    currentLessonLoading,
    fetchLesson,
    fetchModule,
    recordView,
    fetchTeachingPlan,
    teachingPlanLoading
  } = useTeachingStore();

  const [currentPage, setCurrentPage] = useState(1);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [viewStartTime, setViewStartTime] = useState(Date.now());
  const [pageViewTime, setPageViewTime] = useState(Date.now());
  const [showControls, setShowControls] = useState(false);
  
  // æ•™æ¡ˆæŸ¥çœ‹çŠ¶æ€
  const [teachingPlanDrawerVisible, setTeachingPlanDrawerVisible] = useState(false);
  const [currentTeachingPlan, setCurrentTeachingPlan] = useState('');
  const [planLoading, setPlanLoading] = useState(false);
  
  const iframeRef = useRef(null);
  const containerRef = useRef(null);
  const hideTimerRef = useRef(null);

  // åŠ è½½è¯¾ç¨‹æ•°æ®
  useEffect(() => {
    if (id) {
      loadLesson();
    }
  }, [id]);

  // URL pageNumber å˜åŒ–æ—¶æ›´æ–°å½“å‰é¡µ
  useEffect(() => {
    if (pageNumber) {
      const page = parseInt(pageNumber);
      if (!isNaN(page) && page > 0) {
        setCurrentPage(page);
        setPageViewTime(Date.now());
      }
    }
  }, [pageNumber]);

  const loadLesson = async () => {
    try {
      const lessonData = await fetchLesson(id);
      if (lessonData?.module_id) {
        await fetchModule(lessonData.module_id);
      }
      setViewStartTime(Date.now());
      setPageViewTime(Date.now());
    } catch (error) {
      message.error(t('teaching.loadFailed'));
    }
  };

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™
  const hasEditPermission = () => {
    if (user?.role === 'super_admin') return true;
    if (currentLesson?.creator_id === user?.id) return true;
    if (currentModule?.user_permission === 'edit') return true;
    if (currentModule?.creator_id === user?.id) return true;
    return false;
  };

  // è®°å½•é¡µé¢æµè§ˆ
  useEffect(() => {
    if (!currentLesson) return;

    const recordPageView = () => {
      const duration = Math.floor((Date.now() - pageViewTime) / 1000);
      const totalPages = getPages().length;
      const isCompleted = currentPage === totalPages;

      recordView({
        module_id: currentLesson.module_id,
        lesson_id: currentLesson.id,
        page_number: currentPage,
        duration,
        is_completed: isCompleted
      });
    };

    return () => {
      recordPageView();
    };
  }, [currentPage, currentLesson]);

  // é¼ æ ‡è¿›å…¥è§¦å‘åŒºåŸŸæ˜¾ç¤ºæ§åˆ¶æ¡
  const handleMouseEnterTrigger = () => {
    if (!isFullscreen) return;
    
    setShowControls(true);
    
    if (hideTimerRef.current) {
      clearTimeout(hideTimerRef.current);
    }
    
    hideTimerRef.current = setTimeout(() => {
      setShowControls(false);
    }, 3000);
  };

  const handleMouseMoveOnControls = () => {
    if (hideTimerRef.current) {
      clearTimeout(hideTimerRef.current);
    }
    
    hideTimerRef.current = setTimeout(() => {
      setShowControls(false);
    }, 3000);
  };

  useEffect(() => {
    return () => {
      if (hideTimerRef.current) {
        clearTimeout(hideTimerRef.current);
      }
    };
  }, []);

  // å…¨å±æ¨¡å¼å¿«æ·é”®
  useEffect(() => {
    if (!isFullscreen) return;

    const handleKeyPress = (e) => {
      switch(e.key) {
        case 'ArrowLeft':
          handlePrevPage();
          break;
        case 'ArrowRight':
          handleNextPage();
          break;
        case 'f':
        case 'F':
          toggleFullscreen();
          break;
        case 'Escape':
          toggleFullscreen();
          break;
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [isFullscreen, currentPage]);

  const getPages = () => {
    if (!currentLesson?.content) return [];
    
    try {
      const content = typeof currentLesson.content === 'string'
        ? JSON.parse(currentLesson.content)
        : currentLesson.content;
      
      return content.pages || [];
    } catch (error) {
      console.error('è§£æè¯¾ç¨‹å†…å®¹å¤±è´¥:', error);
      return [];
    }
  };

  const getCurrentPageContent = () => {
    const pages = getPages();
    if (pages.length === 0) {
      return `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                color: #999;
                background: #F2F2F7;
              }
            </style>
          </head>
          <body>
            <div>${t('teaching.noContent')}</div>
          </body>
        </html>
      `;
    }

    const page = pages[currentPage - 1];
    return page?.html || page?.content || '';
  };

  // è¿”å›è¯¾ç¨‹é¡µé¢åˆ—è¡¨
  const handleBack = () => {
    navigate(`/teaching/lessons/${id}`);
  };

  const handleEdit = () => {
    if (!hasEditPermission()) {
      message.error(t('teaching.noEditPermission'));
      return;
    }
    navigate(`/teaching/lessons/${id}/edit`);
  };

  const handlePageChange = (page) => {
    setCurrentPage(page);
    setPageViewTime(Date.now());
    navigate(`/teaching/lessons/${id}/pages/${page}`, { replace: true });
  };

  const handlePrevPage = () => {
    if (currentPage > 1) {
      handlePageChange(currentPage - 1);
    }
  };

  const handleNextPage = () => {
    const pages = getPages();
    if (currentPage < pages.length) {
      handlePageChange(currentPage + 1);
    }
  };

  const toggleFullscreen = () => {
    if (!isFullscreen) {
      const elem = containerRef.current;
      if (elem?.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem?.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      }
      setIsFullscreen(true);
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
      setIsFullscreen(false);
    }
  };

  useEffect(() => {
    const handleFullscreenChange = () => {
      const fullscreen = !!document.fullscreenElement;
      setIsFullscreen(fullscreen);
      if (!fullscreen) {
        setShowControls(false);
      }
    };

    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

    return () => {
      document.removeEventListener('fullscreenchange', handleFullscreenChange);
      document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
    };
  }, []);

  /**
   * æ‰“å¼€æ•™æ¡ˆæŸ¥çœ‹æŠ½å±‰
   */
  const handleOpenTeachingPlan = async () => {
    console.log('ğŸ“– æ‰“å¼€æ•™æ¡ˆæŸ¥çœ‹', { lessonId: id, currentPage });
    
    setTeachingPlanDrawerVisible(true);
    setPlanLoading(true);
    setCurrentTeachingPlan('');

    try {
      const plan = await fetchTeachingPlan(id, currentPage);
      
      console.log('âœ… æ•™æ¡ˆåŠ è½½ç»“æœ', plan);
      
      if (plan && plan.content) {
        setCurrentTeachingPlan(plan.content);
      } else {
        setCurrentTeachingPlan('');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½æ•™æ¡ˆå¤±è´¥:', error);
      setCurrentTeachingPlan('');
    } finally {
      setPlanLoading(false);
    }
  };

  /**
   * å…³é—­æ•™æ¡ˆæŠ½å±‰
   */
  const handleCloseTeachingPlan = () => {
    setTeachingPlanDrawerVisible(false);
  };

  const buildMoreMenuItems = () => {
    const items = [
      {
        key: 'page_list',
        label: t('teaching.pageList'),
        icon: <UnorderedListOutlined />,
        onClick: () => navigate(`/teaching/lessons/${id}`)
      }
    ];

    return { items };
  };

  if (currentLessonLoading || !currentLesson) {
    return (
      <IOSPageContainer>
        <IOSLoading text={t('common.loading')} />
      </IOSPageContainer>
    );
  }

  const pages = getPages();
  const totalPages = pages.length;
  const progress = totalPages > 0 ? Math.round((currentPage / totalPages) * 100) : 0;
  const canEdit = hasEditPermission();
  const currentPageData = pages[currentPage - 1];

  return (
    <div 
      ref={containerRef}
      style={{ 
        height: '100vh', 
        display: 'flex', 
        flexDirection: 'column',
        background: isFullscreen ? '#000' : '#F2F2F7',
        position: 'relative',
        overflow: 'hidden'
      }}
    >
      {!isFullscreen && (
        <>
          {/* iOSé£æ ¼å¯¼èˆªæ  */}
          <IOSNavBar
            title={`${currentLesson.title} - ${t('teaching.pageInfo', { current: currentPage, total: totalPages })}`}
            onBack={handleBack}
            backText={t('teaching.backToPageList')}
            actions={
              <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                {/* è¿›åº¦æ˜¾ç¤º */}
                <div style={{ 
                  display: 'flex', 
                  alignItems: 'center',
                  gap: 8,
                  padding: '6px 12px',
                  background: 'rgba(0, 122, 255, 0.08)',
                  borderRadius: 20
                }}>
                  <AimOutlined style={{ color: '#007AFF', fontSize: 14 }} />
                  <span style={{ fontSize: 13, color: '#007AFF', fontWeight: 500 }}>
                    {progress}%
                  </span>
                </div>

                {canEdit && (
                  <IOSButton variant="secondary" size="small" icon={<EditOutlined />} onClick={handleEdit}>
                    {t('common.edit')}
                  </IOSButton>
                )}

                <IOSButton
                  variant="primary"
                  size="small"
                  icon={<FullscreenOutlined />}
                  onClick={toggleFullscreen}
                >
                  {t('teaching.fullscreen')}
                </IOSButton>
              </div>
            }
          />

          {/* é¡µé¢æ§åˆ¶æ  */}
          <div style={{
            background: 'white',
            padding: '12px 24px',
            borderBottom: '1px solid #E5E5EA',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            gap: 20
          }}>
            <IOSButton
              variant="secondary"
              icon={<LeftOutlined />}
              disabled={currentPage === 1}
              onClick={handlePrevPage}
            >
              {t('teaching.prevPage')}
            </IOSButton>

            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              padding: '8px 16px',
              background: '#F2F2F7',
              borderRadius: 20,
              minWidth: 140,
              justifyContent: 'center'
            }}>
              <span style={{ 
                fontSize: 18, 
                fontWeight: 600,
                color: '#007AFF'
              }}>
                {currentPage < 10 ? `0${currentPage}` : currentPage}
              </span>
              <span style={{ color: '#999', fontSize: 14 }}>/</span>
              <span style={{ 
                fontSize: 14, 
                color: '#666'
              }}>
                {totalPages}
              </span>
            </div>

            <IOSButton
              variant="primary"
              icon={<RightOutlined />}
              iconPosition="right"
              disabled={currentPage === totalPages}
              onClick={handleNextPage}
            >
              {t('teaching.nextPage')}
            </IOSButton>

            {/* æŸ¥çœ‹æ•™æ¡ˆæŒ‰é’® */}
            <IOSButton
              variant="secondary"
              icon={<BookOutlined />}
              onClick={handleOpenTeachingPlan}
              style={{
                marginLeft: 8,
                borderColor: '#FF9500',
                color: '#FF9500'
              }}
            >
              {t('teaching.viewTeachingPlan')}
            </IOSButton>
          </div>
        </>
      )}

      {/* å†…å®¹åŒºåŸŸ */}
      <div style={{ 
        flex: 1,
        background: '#fff',
        overflow: 'hidden',
        position: 'relative',
        margin: isFullscreen ? 0 : '0 24px 24px',
        borderRadius: isFullscreen ? 0 : 12,
        boxShadow: isFullscreen ? 'none' : '0 2px 8px rgba(0, 0, 0, 0.06)'
      }}>
        {totalPages > 0 ? (
          <iframe
            ref={iframeRef}
            srcDoc={getCurrentPageContent()}
            style={{
              width: '100%',
              height: '100%',
              border: 'none',
              display: 'block'
            }}
            sandbox="allow-scripts allow-forms allow-modals allow-popups allow-same-origin"
            title={`Page ${currentPage}`}
          />
        ) : (
          <IOSEmpty
            text={t('teaching.noContent')}
            action={
              canEdit && (
                <IOSButton
                  variant="primary"
                  icon={<EditOutlined />}
                  onClick={handleEdit}
                  style={{ marginTop: 20 }}
                >
                  {t('teaching.editContent')}
                </IOSButton>
              )
            }
          />
        )}
      </div>

      {/* å…¨å±æ¨¡å¼æ§åˆ¶æ¡ */}
      {isFullscreen && (
        <>
          <div
            onMouseEnter={handleMouseEnterTrigger}
            style={{
              position: 'fixed',
              bottom: 0,
              left: 0,
              right: 0,
              height: 200,
              pointerEvents: 'auto',
              zIndex: 998
            }}
          />

          <div
            onMouseMove={handleMouseMoveOnControls}
            style={{
              position: 'fixed',
              bottom: 30,
              left: '50%',
              transform: 'translateX(-50%)',
              background: 'rgba(0, 0, 0, 0.75)',
              backdropFilter: 'blur(20px)',
              WebkitBackdropFilter: 'blur(20px)',
              borderRadius: 40,
              padding: '12px 24px',
              display: 'flex',
              alignItems: 'center',
              gap: 16,
              transition: 'opacity 0.3s ease',
              opacity: showControls ? 1 : 0,
              pointerEvents: showControls ? 'auto' : 'none',
              zIndex: 999,
              boxShadow: '0 8px 32px rgba(0, 0, 0, 0.4)'
            }}
          >
            {/* ä¸Šä¸€é¡µæŒ‰é’® */}
            <Tooltip title={t('teaching.prevPage')} placement="top">
              <Button
                type="text"
                icon={<LeftOutlined />}
                disabled={currentPage === 1}
                onClick={handlePrevPage}
                style={{
                  color: 'white',
                  borderRadius: '50%',
                  width: 36,
                  height: 36,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  opacity: currentPage === 1 ? 0.3 : 1,
                  background: 'rgba(255, 255, 255, 0.1)',
                  transition: 'all 0.3s'
                }}
                onMouseEnter={(e) => {
                  if (currentPage > 1) {
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                  }
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                }}
              />
            </Tooltip>

            {/* é¡µç æ˜¾ç¤º */}
            <div style={{ 
              color: 'white', 
              fontSize: 16,
              fontWeight: 600,
              minWidth: 100,
              textAlign: 'center',
              userSelect: 'none',
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              justifyContent: 'center'
            }}>
              <span style={{ fontSize: 20, color: '#007AFF' }}>{currentPage}</span>
              <span style={{ opacity: 0.6 }}>/</span>
              <span>{totalPages}</span>
            </div>

            {/* ä¸‹ä¸€é¡µæŒ‰é’® */}
            <Tooltip title={t('teaching.nextPage')} placement="top">
              <Button
                type="text"
                icon={<RightOutlined />}
                disabled={currentPage === totalPages}
                onClick={handleNextPage}
                style={{
                  color: 'white',
                  borderRadius: '50%',
                  width: 36,
                  height: 36,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  opacity: currentPage === totalPages ? 0.3 : 1,
                  background: 'rgba(255, 255, 255, 0.1)',
                  transition: 'all 0.3s'
                }}
                onMouseEnter={(e) => {
                  if (currentPage < totalPages) {
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                  }
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                }}
              />
            </Tooltip>

            {/* åˆ†éš”çº¿ */}
            <div style={{ 
              width: 1, 
              height: 24,
              background: 'rgba(255, 255, 255, 0.2)'
            }} />

            {/* è¿›åº¦æ˜¾ç¤º */}
            <Tooltip title={`${t('teaching.progress')}: ${progress}%`} placement="top">
              <div style={{ 
                width: 120,
                height: 4,
                background: 'rgba(255, 255, 255, 0.2)',
                borderRadius: 2,
                overflow: 'hidden'
              }}>
                <div style={{
                  width: `${progress}%`,
                  height: '100%',
                  background: 'linear-gradient(90deg, #007AFF, #5856D6)',
                  borderRadius: 2,
                  transition: 'width 0.3s'
                }} />
              </div>
            </Tooltip>

            {/* æŸ¥çœ‹æ•™æ¡ˆæŒ‰é’®ï¼ˆå…¨å±æ¨¡å¼ï¼‰*/}
            <Tooltip title={t('teaching.viewTeachingPlan')} placement="top">
              <Button
                type="text"
                icon={<BookOutlined />}
                onClick={handleOpenTeachingPlan}
                style={{
                  color: '#FF9500',
                  borderRadius: '50%',
                  width: 36,
                  height: 36,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  background: 'rgba(255, 149, 0, 0.15)',
                  transition: 'all 0.3s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 149, 0, 0.25)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 149, 0, 0.15)';
                }}
              />
            </Tooltip>

            {/* é¡µé¢åˆ—è¡¨æŒ‰é’® */}
            <Tooltip title={t('teaching.pageList')} placement="top">
              <Button
                type="text"
                icon={<UnorderedListOutlined />}
                onClick={handleBack}
                style={{
                  color: 'white',
                  borderRadius: '50%',
                  width: 36,
                  height: 36,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  background: 'rgba(255, 255, 255, 0.1)',
                  transition: 'all 0.3s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                }}
              />
            </Tooltip>

            {/* ç¼–è¾‘æŒ‰é’® */}
            {canEdit && (
              <Tooltip title={t('common.edit')} placement="top">
                <Button
                  type="text"
                  icon={<EditOutlined />}
                  onClick={handleEdit}
                  style={{
                    color: 'white',
                    borderRadius: '50%',
                    width: 36,
                    height: 36,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'rgba(255, 255, 255, 0.1)',
                    transition: 'all 0.3s'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                  }}
                />
              </Tooltip>
            )}

            {/* é€€å‡ºå…¨å±æŒ‰é’® */}
            <Tooltip title={t('teaching.exitFullscreen')} placement="top">
              <Button
                type="text"
                icon={<FullscreenExitOutlined />}
                onClick={toggleFullscreen}
                style={{
                  color: 'white',
                  borderRadius: '50%',
                  width: 36,
                  height: 36,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  background: 'rgba(255, 255, 255, 0.1)',
                  transition: 'all 0.3s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                }}
              />
            </Tooltip>

            {/* æ›´å¤šèœå• */}
            <Dropdown 
              menu={buildMoreMenuItems()} 
              trigger={['click']}
              placement="topRight"
            >
              <Button
                type="text"
                icon={<EllipsisOutlined />}
                style={{
                  color: 'white',
                  borderRadius: '50%',
                  width: 36,
                  height: 36,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  background: 'rgba(255, 255, 255, 0.1)',
                  transition: 'all 0.3s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                }}
              />
            </Dropdown>
          </div>
        </>
      )}

      {/* æ•™æ¡ˆæŸ¥çœ‹æŠ½å±‰ */}
      <Drawer
        title={
          <div style={{ 
            display: 'flex', 
            alignItems: 'center', 
            gap: 12,
            fontSize: 18,
            fontWeight: 600,
            color: '#1a1a1a'
          }}>
            <BookOutlined style={{ color: '#FF9500', fontSize: 20 }} />
            <span>{t('teaching.teachingPlan')} - {currentPageData?.title || `${t('teaching.page')} ${currentPage}`}</span>
          </div>
        }
        placement="right"
        width={800}
        onClose={handleCloseTeachingPlan}
        open={teachingPlanDrawerVisible}
        styles={{
          header: {
            background: '#F2F2F7',
            borderBottom: '1px solid #E5E5EA',
            padding: '20px 24px'
          },
          body: {
            padding: 0,
            background: '#fff'
          }
        }}
      >
        <Spin spinning={planLoading} tip={t('teaching.loadingTeachingPlan')}>
          <div style={{ 
            minHeight: 'calc(100vh - 120px)',
            padding: '24px'
          }}>
            {currentTeachingPlan ? (
              <div 
                className="teaching-plan-content"
                style={{
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                  fontSize: 14,
                  lineHeight: 1.6,
                  color: '#1a1a1a'
                }}
                dangerouslySetInnerHTML={{ __html: currentTeachingPlan }}
              />
            ) : (
              !planLoading && (
                <Empty
                  image={Empty.PRESENTED_IMAGE_SIMPLE}
                  description={
                    <div style={{ marginTop: 20 }}>
                      <div style={{ fontSize: 16, color: '#666', marginBottom: 8 }}>
                        {t('teaching.noTeachingPlan')}
                      </div>
                      {canEdit && (
                        <div style={{ fontSize: 14, color: '#999' }}>
                          {t('teaching.pleaseAddTeachingPlanInEditor')}
                        </div>
                      )}
                    </div>
                  }
                  style={{ marginTop: 60 }}
                >
                  {canEdit && (
                    <Button
                      type="primary"
                      icon={<EditOutlined />}
                      onClick={() => {
                        handleCloseTeachingPlan();
                        handleEdit();
                      }}
                      style={{
                        marginTop: 16,
                        borderRadius: 8,
                        height: 40,
                        background: 'linear-gradient(135deg, #007AFF, #5856D6)',
                        border: 'none'
                      }}
                    >
                      {t('teaching.goToEdit')}
                    </Button>
                  )}
                </Empty>
              )
            )}
          </div>
        </Spin>
      </Drawer>
    </div>
  );
};

export default LessonViewer;
