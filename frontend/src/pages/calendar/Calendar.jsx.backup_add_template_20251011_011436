/**
 * 智能日历 - 4x4网格视图重构版
 * 显示16天视图：前2天 + 今天 + 后13天
 */

import React, { useState, useEffect, useMemo } from 'react';
import { 
  Button, 
  Modal, 
  Form, 
  Input, 
  InputNumber, 
  Select, 
  DatePicker, 
  Slider, 
  message,
  Spin,
  Tag,
  Popconfirm,
  Row,
  Col
} from 'antd';
import {
  PlusOutlined,
  SettingOutlined,
  ScanOutlined,
  CalendarOutlined,
  CheckCircleOutlined,
  ClockCircleOutlined,
  ExclamationCircleOutlined,
  EditOutlined,
  DeleteOutlined,
  BarChartOutlined,
  ThunderboltOutlined,
  FileTextOutlined,
  LeftOutlined,
  RightOutlined
} from '@ant-design/icons';
import { useTranslation } from 'react-i18next';
import dayjs from 'dayjs';
import ReactMarkdown from 'react-markdown';
import useCalendarStore from '../../stores/calendarStore';
import useAuthStore from '../../stores/authStore';
import './Calendar.less';

const { TextArea } = Input;
const { Option } = Select;

// 重要度颜色映射
const IMPORTANCE_COLORS = {
  1: '#C7C7CC', 2: '#C7C7CC', 3: '#8E8E93', 4: '#8E8E93',
  5: '#007AFF', 6: '#007AFF', 7: '#FF9500', 8: '#FF9500',
  9: '#FF3B30', 10: '#FF3B30'
};

const CalendarPage = () => {
  const { t } = useTranslation();
  const { user } = useAuthStore();
  
  const {
    events,
    categories,
    overview,
    eventsLoading,
    analysisLoading,
    overviewLoading,
    aiModels,
    aiModelsLoading,
    fetchEvents,
    fetchCategories,
    fetchOverview,
    fetchAvailableModels,
    createEvent,
    updateEvent,
    deleteEvent,
    markEventComplete,
    performAnalysis
  } = useCalendarStore();
  
  const [form] = Form.useForm();
  const [aiForm] = Form.useForm();
  
  // 日历状态：基准日期（默认今天）
  const [baseDate, setBaseDate] = useState(dayjs());
  const [selectedDate, setSelectedDate] = useState(dayjs());
  
  // 模态框状态
  const [eventModalVisible, setEventModalVisible] = useState(false);
  const [editingEvent, setEditingEvent] = useState(null);
  const [settingsModalVisible, setSettingsModalVisible] = useState(false);
  const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
  
  // 计算16天日期范围（前2天 + 今天 + 后13天）
  const dateRange = useMemo(() => {
    const dates = [];
    for (let i = -2; i <= 13; i++) {
      dates.push(baseDate.add(i, 'day'));
    }
    return dates;
  }, [baseDate]);
  
  // 转换为4x4网格
  const gridDates = useMemo(() => {
    const grid = [];
    for (let i = 0; i < 4; i++) {
      grid.push(dateRange.slice(i * 4, (i + 1) * 4));
    }
    return grid;
  }, [dateRange]);
  
  // 获取日期范围的事项数据
  const dateEvents = useMemo(() => {
    const eventMap = {};
    events.forEach(event => {
      const dateKey = dayjs(event.event_date).format('YYYY-MM-DD');
      if (!eventMap[dateKey]) {
        eventMap[dateKey] = [];
      }
      eventMap[dateKey].push(event);
    });
    return eventMap;
  }, [events]);
  
  // 选中日期的事项
  const selectedDateEvents = useMemo(() => {
    const dateKey = selectedDate.format('YYYY-MM-DD');
    return dateEvents[dateKey] || [];
  }, [dateEvents, selectedDate]);
  
  // 初始化数据
  useEffect(() => {
    loadInitialData();
  }, []);
  
  // 当基准日期变化时重新加载事项
  useEffect(() => {
    loadDateRangeEvents();
  }, [baseDate]);
  
  const loadInitialData = async () => {
    try {
      await Promise.all([
        fetchCategories(),
        fetchOverview(),
        fetchAvailableModels(),
        loadDateRangeEvents()
      ]);
    } catch (error) {
      console.error('加载数据失败:', error);
    }
  };
  
  const loadDateRangeEvents = async () => {
    const startDate = baseDate.add(-2, 'day').format('YYYY-MM-DD');
    const endDate = baseDate.add(13, 'day').format('YYYY-MM-DD');
    await fetchEvents(startDate, endDate);
  };
  
  // 切换到上一个16天周期
  const handlePrevPeriod = () => {
    setBaseDate(prev => prev.add(-16, 'day'));
  };
  
  // 切换到下一个16天周期
  const handleNextPeriod = () => {
    setBaseDate(prev => prev.add(16, 'day'));
  };
  
  // 回到今天
  const handleToday = () => {
    setBaseDate(dayjs());
    setSelectedDate(dayjs());
  };
  
  // 选择日期
  const handleSelectDate = (date) => {
    setSelectedDate(date);
  };
  
  // 创建事项
  const handleCreateEvent = () => {
    setEditingEvent(null);
    form.resetFields();
    form.setFieldsValue({
      event_date: selectedDate,
      importance: 5,
      status: 'not_started',
      recurrence_type: 'none',
      category: categories.length > 0 ? categories[0].name : '其他'
    });
    setEventModalVisible(true);
  };
  
  // 编辑事项
  const handleEditEvent = (event) => {
    setEditingEvent(event);
    form.setFieldsValue({
      ...event,
      event_date: dayjs(event.event_date)
    });
    setEventModalVisible(true);
  };
  
  // 提交事项
  const handleEventSubmit = async () => {
    try {
      const values = await form.validateFields();
      const eventData = {
        ...values,
        event_date: values.event_date.format('YYYY-MM-DD'),
        recurrence_end_date: values.recurrence_end_date ? 
          values.recurrence_end_date.format('YYYY-MM-DD') : null
      };
      
      if (editingEvent) {
        await updateEvent(editingEvent.id, eventData);
      } else {
        await createEvent(eventData);
      }
      
      setEventModalVisible(false);
      await loadDateRangeEvents();
      await fetchOverview();
    } catch (error) {
      console.error('提交失败:', error);
    }
  };
  
  // 删除事项
  const handleDeleteEvent = async (eventId) => {
    try {
      await deleteEvent(eventId);
      await loadDateRangeEvents();
      await fetchOverview();
    } catch (error) {
      console.error('删除失败:', error);
    }
  };
  
  // 标记完成
  const handleMarkComplete = async (eventId) => {
    try {
      await markEventComplete(eventId);
      await loadDateRangeEvents();
      await fetchOverview();
    } catch (error) {
      console.error('标记失败:', error);
    }
  };
  
  // 打开设置（原AI分析配置）
  const handleOpenSettings = () => {
    setSettingsModalVisible(true);
    setAiAnalysisResult(null);
    aiForm.setFieldsValue({ scan_days: 15 });
  };
  
  // 一键扫描（直接执行AI分析）
  const handleQuickScan = async () => {
    // 使用默认配置快速分析
    if (aiModels.length === 0) {
      message.warning('暂无可用AI模型');
      return;
    }
    
    const defaultModel = aiModels.find(m => m.is_active);
    if (!defaultModel) {
      message.warning('暂无激活的AI模型');
      return;
    }
    
    try {
      const result = await performAnalysis({
        model_id: defaultModel.id,
        scan_days: 15
      });
      
      if (result && result.analysis && result.analysis.analysis_result) {
        setAiAnalysisResult(result.analysis.analysis_result.raw_text);
        setSettingsModalVisible(true);
        message.success('AI分析完成');
      }
    } catch (error) {
      console.error('快速扫描失败:', error);
      message.error(error.message || '分析失败');
    }
  };
  
  // 执行AI分析（从设置界面）
  const handleAIAnalysis = async () => {
    try {
      const values = await aiForm.validateFields();
      const result = await performAnalysis(values);
      
      if (result && result.analysis && result.analysis.analysis_result) {
        setAiAnalysisResult(result.analysis.analysis_result.raw_text);
        message.success('AI分析完成');
      } else {
        throw new Error('分析结果格式错误');
      }
    } catch (error) {
      console.error('AI分析失败:', error);
      message.error(error.message || 'AI分析失败');
    }
  };
  
  // 获取日期的事项统计
  const getDateStats = (date) => {
    const dateKey = date.format('YYYY-MM-DD');
    const dayEvents = dateEvents[dateKey] || [];
    return {
      count: dayEvents.length,
      highPriority: dayEvents.filter(e => e.importance >= 8).length
    };
  };
  
  // 获取状态图标
  const getStatusIcon = (status) => {
    switch (status) {
      case 'completed':
        return <CheckCircleOutlined style={{ color: '#34C759' }} />;
      case 'in_progress':
        return <ClockCircleOutlined style={{ color: '#FF9500' }} />;
      default:
        return <ExclamationCircleOutlined style={{ color: '#8E8E93' }} />;
    }
  };
  
  // 获取重要度徽章
  const getImportanceBadge = (importance) => {
    if (importance >= 8) return { text: t('calendar.importance.high'), class: 'high' };
    if (importance >= 5) return { text: t('calendar.importance.medium'), class: 'medium' };
    return { text: t('calendar.importance.low'), class: 'low' };
  };

  return (
    <div className="calendar-page calendar-grid-view">
      {/* 主内容区域 */}
      <div className="calendar-content">
        {/* 左侧统计面板 */}
        <div className="calendar-left-panel">
          <Spin spinning={overviewLoading}>
            <div className="overview-section">
              <div className="section-title">
                <CalendarOutlined /> 今日事项
              </div>
              
              {overview && (
                <div className="stats-grid">
                  <div className="stat-card">
                    <div className="stat-value">{overview.today?.total || 0}</div>
                    <div className="stat-label">总计</div>
                  </div>
                  <div className="stat-card completed">
                    <div className="stat-value">{overview.today?.completed || 0}</div>
                    <div className="stat-label">已完成</div>
                  </div>
                  <div className="stat-card in-progress">
                    <div className="stat-value">{overview.today?.in_progress || 0}</div>
                    <div className="stat-label">进行中</div>
                  </div>
                  <div className="stat-card high-priority">
                    <div className="stat-value">{overview.today?.high_priority || 0}</div>
                    <div className="stat-label">高优先级</div>
                  </div>
                </div>
              )}
            </div>
            
            <div className="overview-section">
              <div className="section-title">
                <BarChartOutlined /> 按分类
              </div>
              
              {overview?.upcoming?.by_category && (
                <div className="category-list">
                  {Object.entries(overview.upcoming.by_category).map(([category, count]) => {
                    const categoryObj = categories.find(c => c.name === category);
                    return (
                      <div key={category} className="category-item">
                        <div className="category-info">
                          <div 
                            className="category-color" 
                            style={{ backgroundColor: categoryObj?.color || '#007AFF' }}
                          />
                          <span className="category-name">{category}</span>
                        </div>
                        <span className="category-count">{count}</span>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </Spin>
        </div>
        
        {/* 中间日历面板 - 4x4网格 */}
        <div className="calendar-main-panel calendar-grid-panel">
          {/* 日历头部控制栏 */}
          <div className="calendar-controls">
            <div className="controls-left">
              <Button 
                icon={<SettingOutlined />}
                onClick={handleOpenSettings}
              >
                设置
              </Button>
              <Button 
                icon={<ScanOutlined />}
                type="primary"
                onClick={handleQuickScan}
                loading={analysisLoading}
              >
                一键扫描
              </Button>
            </div>
            
            <div className="controls-center">
              <Button 
                icon={<LeftOutlined />} 
                onClick={handlePrevPeriod}
                size="small"
              />
              <Button 
                onClick={handleToday}
                size="small"
              >
                今天
              </Button>
              <Button 
                icon={<RightOutlined />} 
                onClick={handleNextPeriod}
                size="small"
              />
            </div>
            
            <div className="controls-right">
              <span className="date-range-display">
                {dateRange[0].format('MM/DD')} - {dateRange[15].format('MM/DD')}
              </span>
            </div>
          </div>
          
          {/* 4x4日历网格 */}
          <Spin spinning={eventsLoading}>
            <div className="calendar-grid">
              {gridDates.map((row, rowIndex) => (
                <div key={rowIndex} className="calendar-grid-row">
                  {row.map((date, colIndex) => {
                    const stats = getDateStats(date);
                    const isToday = date.isSame(dayjs(), 'day');
                    const isSelected = date.isSame(selectedDate, 'day');
                    
                    return (
                      <div
                        key={colIndex}
                        className={`calendar-grid-cell ${isToday ? 'is-today' : ''} ${isSelected ? 'is-selected' : ''}`}
                        onClick={() => handleSelectDate(date)}
                      >
                        <div className="cell-header">
                          <span className="cell-weekday">{date.format('ddd')}</span>
                          <span className="cell-date">{date.format('DD')}</span>
                        </div>
                        
                        {isToday && <div className="today-badge">今日</div>}
                        
                        {stats.count > 0 && (
                          <div className="cell-events">
                            {stats.count > 3 ? (
                              <div className="event-count-badge">{stats.count}</div>
                            ) : (
                              <div className="event-dots">
                                {Array.from({ length: stats.count }).map((_, i) => (
                                  <div 
                                    key={i} 
                                    className={`event-dot ${stats.highPriority > 0 ? 'high-priority' : ''}`}
                                  />
                                ))}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </Spin>
        </div>
        
        {/* 右侧事项列表 */}
        <div className="calendar-right-panel">
          <div className="panel-header">
            <h3>事项详情</h3>
            <span className="date-display">
              {selectedDate.format('YYYY年MM月DD日')}
            </span>
          </div>
          
          {/* 创建事项按钮 */}
          <Button 
            type="primary" 
            icon={<PlusOutlined />}
            block
            onClick={handleCreateEvent}
            style={{ marginBottom: 16 }}
          >
            创建事项
          </Button>
          
          <div className="events-list">
            {selectedDateEvents.length === 0 ? (
              <div className="empty-events">
                <CalendarOutlined />
                <p>当前无事项</p>
              </div>
            ) : (
              selectedDateEvents.map(event => {
                const badge = getImportanceBadge(event.importance);
                return (
                  <div 
                    key={event.id} 
                    className={`event-card status-${event.status}`}
                    style={{ borderLeftColor: IMPORTANCE_COLORS[event.importance] }}
                  >
                    <div className="event-header">
                      <div className="event-title">{event.content}</div>
                      <span className={`importance-badge ${badge.class}`}>
                        {badge.text}
                      </span>
                    </div>
                    
                    <div className="event-meta">
                      <div className="meta-item">
                        {getStatusIcon(event.status)}
                        <span>{t(`calendar.event.status.${event.status}`)}</span>
                      </div>
                      <div className="meta-item">
                        <Tag color={event.color || '#007AFF'}>{event.category}</Tag>
                      </div>
                    </div>
                    
                    <div className="event-actions">
                      {event.status !== 'completed' && (
                        <Button 
                          className="btn-complete"
                          size="small"
                          icon={<CheckCircleOutlined />}
                          onClick={() => handleMarkComplete(event.id)}
                        >
                          完成
                        </Button>
                      )}
                      <Button 
                        className="btn-edit"
                        size="small"
                        icon={<EditOutlined />}
                        onClick={() => handleEditEvent(event)}
                      >
                        编辑
                      </Button>
                      <Popconfirm
                        title="确认删除此事项？"
                        onConfirm={() => handleDeleteEvent(event.id)}
                        okText="确认"
                        cancelText="取消"
                      >
                        <Button 
                          className="btn-delete"
                          size="small"
                          icon={<DeleteOutlined />}
                        >
                          删除
                        </Button>
                      </Popconfirm>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>
      
      {/* 事项表单模态框 */}
      <Modal
        title={editingEvent ? '编辑事项' : '创建事项'}
        open={eventModalVisible}
        onOk={handleEventSubmit}
        onCancel={() => setEventModalVisible(false)}
        width={600}
        okText="确认"
        cancelText="取消"
        className="event-form-modal"
      >
        <Form form={form} layout="vertical">
          <Form.Item
            name="content"
            label="事项内容"
            rules={[{ required: true, message: '请输入事项内容' }]}
          >
            <TextArea rows={4} placeholder="请输入事项内容" />
          </Form.Item>
          
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="event_date"
                label="日期"
                rules={[{ required: true, message: '请选择日期' }]}
              >
                <DatePicker style={{ width: '100%' }} />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="category"
                label="分类"
                rules={[{ required: true, message: '请选择分类' }]}
              >
                <Select placeholder="请选择分类">
                  {categories.map(cat => (
                    <Option key={cat.id} value={cat.name}>{cat.name}</Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
          </Row>
          
          <Form.Item name="importance" label="重要度">
            <Slider 
              min={1} 
              max={10} 
              marks={{ 1: '1', 5: '5', 10: '10' }}
              className="importance-slider"
            />
          </Form.Item>
          
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item name="status" label="状态">
                <Select>
                  <Option value="not_started">未开始</Option>
                  <Option value="in_progress">进行中</Option>
                  <Option value="completed">已完成</Option>
                  <Option value="daily">日常</Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="recurrence_type" label="重复">
                <Select>
                  <Option value="none">不重复</Option>
                  <Option value="daily">每天</Option>
                  <Option value="weekly">每周</Option>
                  <Option value="monthly">每月</Option>
                </Select>
              </Form.Item>
            </Col>
          </Row>
          
          <Form.Item name="file_link" label="文件链接">
            <Input placeholder="可选：相关文件链接" />
          </Form.Item>
        </Form>
      </Modal>
      
      {/* 设置/AI分析模态框 */}
      <Modal
        title={<><SettingOutlined /> AI分析设置</>}
        open={settingsModalVisible}
        onCancel={() => {
          setSettingsModalVisible(false);
          setAiAnalysisResult(null);
        }}
        footer={null}
        width={800}
        className="ai-analysis-modal"
      >
        <div className="ai-analysis-panel">
          {!aiAnalysisResult ? (
            <div className="analysis-form">
              <Spin spinning={aiModelsLoading}>
                <Form form={aiForm} layout="vertical">
                  <Row gutter={16}>
                    <Col span={12}>
                      <Form.Item
                        name="model_id"
                        label="选择AI模型"
                        rules={[{ required: true, message: '请选择AI模型' }]}
                      >
                        <Select placeholder="请选择AI模型">
                          {aiModels.filter(m => m.is_active).map(model => (
                            <Option key={model.id} value={model.id}>
                              {model.display_name} ({model.credits_per_chat} 积分)
                            </Option>
                          ))}
                        </Select>
                      </Form.Item>
                    </Col>
                    
                    <Col span={12}>
                      <Form.Item
                        name="scan_days"
                        label="扫描范围"
                        rules={[{ required: true }]}
                      >
                        <InputNumber 
                          min={1} 
                          max={180} 
                          style={{ width: '100%' }}
                          addonAfter="天"
                        />
                      </Form.Item>
                    </Col>
                  </Row>
                  
                  <div className="info-box">
                    <div className="info-item">
                      <span className="label">积分余额</span>
                      <span className="value credits">{user?.credits || 0}</span>
                    </div>
                  </div>
                  
                  <Button
                    type="primary"
                    block
                    size="large"
                    icon={<ThunderboltOutlined />}
                    onClick={handleAIAnalysis}
                    loading={analysisLoading}
                  >
                    开始分析
                  </Button>
                </Form>
              </Spin>
            </div>
          ) : (
            <div className="analysis-result">
              <div className="result-content">
                <ReactMarkdown>{aiAnalysisResult}</ReactMarkdown>
              </div>
              
              <div className="result-actions">
                <Button onClick={() => setAiAnalysisResult(null)}>
                  返回
                </Button>
                <Button 
                  type="primary" 
                  icon={<FileTextOutlined />}
                >
                  导出结果
                </Button>
              </div>
            </div>
          )}
          
          {analysisLoading && (
            <div className="analysis-loading">
              <Spin size="large" />
              <p>AI正在分析中...</p>
            </div>
          )}
        </div>
      </Modal>
    </div>
  );
};

export default CalendarPage;
