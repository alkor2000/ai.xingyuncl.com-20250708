/**
 * 智能日历 - 4x4网格视图（左侧智能分析面板）
 * 显示16天视图：前2天 + 今天 + 后13天
 */

import React, { useState, useEffect, useMemo } from 'react';
import { 
  Button, 
  Modal, 
  Form, 
  Input, 
  InputNumber, 
  Select, 
  DatePicker, 
  Slider, 
  message,
  Spin,
  Tag,
  Popconfirm,
  Row,
  Col,
  Empty
} from 'antd';
import {
  PlusOutlined,
  SettingOutlined,
  ScanOutlined,
  CalendarOutlined,
  CheckCircleOutlined,
  ClockCircleOutlined,
  ExclamationCircleOutlined,
  EditOutlined,
  DeleteOutlined,
  ThunderboltOutlined,
  FileTextOutlined,
  LeftOutlined,
  RightOutlined,
  RobotOutlined,
  HistoryOutlined,
  ReloadOutlined,
  SaveOutlined,
  DownOutlined,
  RightOutlined as RightExpandOutlined
} from '@ant-design/icons';
import { useTranslation } from 'react-i18next';
import dayjs from 'dayjs';
import relativeTime from 'dayjs/plugin/relativeTime';
import 'dayjs/locale/zh-cn';
import ReactMarkdown from 'react-markdown';
import useCalendarStore from '../../stores/calendarStore';
import useAuthStore from '../../stores/authStore';
import './Calendar.less';

dayjs.extend(relativeTime);
dayjs.locale('zh-cn');

const { TextArea } = Input;
const { Option } = Select;

// 重要度颜色映射
const IMPORTANCE_COLORS = {
  1: '#C7C7CC', 2: '#C7C7CC', 3: '#8E8E93', 4: '#8E8E93',
  5: '#007AFF', 6: '#007AFF', 7: '#FF9500', 8: '#FF9500',
  9: '#FF3B30', 10: '#FF3B30'
};

const CalendarPage = () => {
  const { t } = useTranslation();
  const { user } = useAuthStore();
  
  const {
    events,
    categories,
    latestAnalysis,
    eventsLoading,
    analysisLoading,
    aiModels,
    aiModelsLoading,
    promptTemplates,
    configLoading,
    fetchEvents,
    fetchCategories,
    fetchAvailableModels,
    fetchCalendarConfig,
    fetchLatestAnalysis,
    autoPerformAnalysis,
    createEvent,
    updateEvent,
    deleteEvent,
    markEventComplete,
    performAnalysis,
    fetchAnalysisHistory
  } = useCalendarStore();
  
  const [form] = Form.useForm();
  const [settingsForm] = Form.useForm();
  
  // 日历状态：基准日期（默认今天）
  const [baseDate, setBaseDate] = useState(dayjs());
  const [selectedDate, setSelectedDate] = useState(dayjs());
  
  // 模态框状态
  const [eventModalVisible, setEventModalVisible] = useState(false);
  const [editingEvent, setEditingEvent] = useState(null);
  const [settingsModalVisible, setSettingsModalVisible] = useState(false);
  const [historyModalVisible, setHistoryModalVisible] = useState(false);
  const [analysisHistory, setAnalysisHistory] = useState([]);
  
  // 历史记录展开状态
  const [expandedHistoryId, setExpandedHistoryId] = useState(null);
  
  // 计算16天日期范围（前2天 + 今天 + 后13天）
  const dateRange = useMemo(() => {
    const dates = [];
    for (let i = -2; i <= 13; i++) {
      dates.push(baseDate.add(i, 'day'));
    }
    return dates;
  }, [baseDate]);
  
  // 转换为4x4网格
  const gridDates = useMemo(() => {
    const grid = [];
    for (let i = 0; i < 4; i++) {
      grid.push(dateRange.slice(i * 4, (i + 1) * 4));
    }
    return grid;
  }, [dateRange]);
  
  // 获取日期范围的事项数据
  const dateEvents = useMemo(() => {
    const eventMap = {};
    events.forEach(event => {
      const dateKey = dayjs(event.event_date).format('YYYY-MM-DD');
      if (!eventMap[dateKey]) {
        eventMap[dateKey] = [];
      }
      eventMap[dateKey].push(event);
    });
    return eventMap;
  }, [events]);
  
  // 选中日期的事项
  const selectedDateEvents = useMemo(() => {
    const dateKey = selectedDate.format('YYYY-MM-DD');
    return dateEvents[dateKey] || [];
  }, [dateEvents, selectedDate]);
  
  // 初始化数据
  useEffect(() => {
    loadInitialData();
  }, []);
  
  // 当基准日期变化时重新加载事项
  useEffect(() => {
    loadDateRangeEvents();
  }, [baseDate]);
  
  const loadInitialData = async () => {
    try {
      await Promise.all([
        fetchCategories(),
        fetchAvailableModels(),
        fetchCalendarConfig(),
        loadDateRangeEvents()
      ]);
      
      // 加载最新分析，如果没有则自动执行
      const latest = await fetchLatestAnalysis();
      if (!latest) {
        // 延迟2秒执行自动分析，避免阻塞页面加载
        setTimeout(() => {
          autoPerformAnalysis();
        }, 2000);
      }
    } catch (error) {
      console.error('加载数据失败:', error);
    }
  };
  
  const loadDateRangeEvents = async () => {
    const startDate = baseDate.add(-2, 'day').format('YYYY-MM-DD');
    const endDate = baseDate.add(13, 'day').format('YYYY-MM-DD');
    await fetchEvents(startDate, endDate);
  };
  
  // ==================== 配置持久化 ====================
  
  /**
   * 获取默认配置
   */
  const getDefaultSettings = () => {
    const defaultModel = aiModels.find(m => m.is_active) || aiModels[0];
    return {
      model_id: defaultModel?.id || null,
      template_id: null,
      scan_days_before: 15,
      scan_days_after: 15
    };
  };
  
  /**
   * 从 LocalStorage 加载配置
   */
  const loadSettings = () => {
    const key = `calendar_ai_settings_${user?.id || 'default'}`;
    const saved = localStorage.getItem(key);
    
    if (saved) {
      try {
        return JSON.parse(saved);
      } catch (e) {
        console.error('解析配置失败:', e);
      }
    }
    
    return getDefaultSettings();
  };
  
  /**
   * 保存配置到 LocalStorage
   */
  const saveSettings = (settings) => {
    const key = `calendar_ai_settings_${user?.id || 'default'}`;
    localStorage.setItem(key, JSON.stringify(settings));
  };
  
  // ==================== 日历操作 ====================
  
  // 切换到上一个16天周期
  const handlePrevPeriod = () => {
    setBaseDate(prev => prev.add(-16, 'day'));
  };
  
  // 切换到下一个16天周期
  const handleNextPeriod = () => {
    setBaseDate(prev => prev.add(16, 'day'));
  };
  
  // 回到今天
  const handleToday = () => {
    setBaseDate(dayjs());
    setSelectedDate(dayjs());
  };
  
  // 选择日期
  const handleSelectDate = (date) => {
    setSelectedDate(date);
  };
  
  // ==================== 事项操作 ====================
  
  // 创建事项
  const handleCreateEvent = () => {
    setEditingEvent(null);
    form.resetFields();
    form.setFieldsValue({
      event_date: selectedDate,
      importance: 5,
      status: 'not_started',
      recurrence_type: 'none',
      category: categories.length > 0 ? categories[0].name : '其他'
    });
    setEventModalVisible(true);
  };
  
  // 编辑事项
  const handleEditEvent = (event) => {
    setEditingEvent(event);
    form.setFieldsValue({
      ...event,
      event_date: dayjs(event.event_date)
    });
    setEventModalVisible(true);
  };
  
  // 提交事项
  const handleEventSubmit = async () => {
    try {
      const values = await form.validateFields();
      const eventData = {
        ...values,
        event_date: values.event_date.format('YYYY-MM-DD'),
        recurrence_end_date: values.recurrence_end_date ? 
          values.recurrence_end_date.format('YYYY-MM-DD') : null
      };
      
      if (editingEvent) {
        await updateEvent(editingEvent.id, eventData);
      } else {
        await createEvent(eventData);
      }
      
      setEventModalVisible(false);
      await loadDateRangeEvents();
    } catch (error) {
      console.error('提交失败:', error);
    }
  };
  
  // 删除事项
  const handleDeleteEvent = async (eventId) => {
    try {
      await deleteEvent(eventId);
      await loadDateRangeEvents();
    } catch (error) {
      console.error('删除失败:', error);
    }
  };
  
  // 标记完成
  const handleMarkComplete = async (eventId) => {
    try {
      await markEventComplete(eventId);
      await loadDateRangeEvents();
    } catch (error) {
      console.error('标记失败:', error);
    }
  };
  
  // ==================== AI分析操作 ====================
  
  /**
   * 打开设置模态框
   */
  const handleOpenSettings = () => {
    const settings = loadSettings();
    settingsForm.setFieldsValue(settings);
    setSettingsModalVisible(true);
  };
  
  /**
   * 保存设置
   */
  const handleSaveSettings = async () => {
    try {
      const values = await settingsForm.validateFields();
      saveSettings(values);
      message.success('设置已保存');
      setSettingsModalVisible(false);
    } catch (error) {
      console.error('保存设置失败:', error);
    }
  };
  
  /**
   * 执行新分析（使用保存的配置）
   */
  const handleNewAnalysis = async () => {
    const settings = loadSettings();
    
    if (!settings.model_id) {
      message.warning('请先设置AI模型');
      handleOpenSettings();
      return;
    }
    
    try {
      const totalDays = settings.scan_days_before + settings.scan_days_after;
      
      await performAnalysis({
        model_id: settings.model_id,
        template_id: settings.template_id,
        scan_days: totalDays
      });
    } catch (error) {
      console.error('分析失败:', error);
    }
  };
  
  /**
   * 查看历史
   */
  const handleViewHistory = async () => {
    try {
      const history = await fetchAnalysisHistory();
      setAnalysisHistory(history);
      setExpandedHistoryId(null); // 重置展开状态
      setHistoryModalVisible(true);
    } catch (error) {
      console.error('获取历史失败:', error);
    }
  };
  
  /**
   * 切换历史记录展开/收起
   */
  const handleToggleHistory = (itemId) => {
    setExpandedHistoryId(expandedHistoryId === itemId ? null : itemId);
  };
  
  // ==================== 工具方法 ====================
  
  // 获取日期的事项统计
  const getDateStats = (date) => {
    const dateKey = date.format('YYYY-MM-DD');
    const dayEvents = dateEvents[dateKey] || [];
    return {
      count: dayEvents.length,
      highPriority: dayEvents.filter(e => e.importance >= 8).length
    };
  };
  
  // 获取状态图标
  const getStatusIcon = (status) => {
    switch (status) {
      case 'completed':
        return <CheckCircleOutlined style={{ color: '#34C759' }} />;
      case 'in_progress':
        return <ClockCircleOutlined style={{ color: '#FF9500' }} />;
      default:
        return <ExclamationCircleOutlined style={{ color: '#8E8E93' }} />;
    }
  };
  
  // 获取重要度徽章
  const getImportanceBadge = (importance) => {
    if (importance >= 8) return { text: t('calendar.importance.high'), class: 'high' };
    if (importance >= 5) return { text: t('calendar.importance.medium'), class: 'medium' };
    return { text: t('calendar.importance.low'), class: 'low' };
  };

  return (
    <div className="calendar-page calendar-grid-view">
      {/* 主内容区域 */}
      <div className="calendar-content">
        {/* 左侧智能分析面板 */}
        <div className="calendar-left-panel ai-analysis-panel">
          <div className="panel-header">
            <div className="header-title">
              <RobotOutlined /> 智能分析
            </div>
          </div>
          
          <Spin spinning={analysisLoading}>
            {latestAnalysis ? (
              <div className="analysis-content">
                <div className="analysis-meta">
                  <div className="meta-item">
                    <CalendarOutlined />
                    <span>{dayjs(latestAnalysis.created_at).fromNow()}</span>
                  </div>
                  <div className="meta-item">
                    <ThunderboltOutlined />
                    <span>{latestAnalysis.model_name}</span>
                  </div>
                  <div className="meta-item">
                    <FileTextOutlined />
                    <span>分析了{latestAnalysis.events_count}个事项</span>
                  </div>
                </div>
                
                <div className="analysis-result">
                  <ReactMarkdown>
                    {latestAnalysis.analysis_result?.raw_text || '暂无分析内容'}
                  </ReactMarkdown>
                </div>
                
                <div className="analysis-actions">
                  <Button 
                    icon={<ReloadOutlined />}
                    onClick={handleNewAnalysis}
                    loading={analysisLoading}
                    block
                  >
                    一键分析
                  </Button>
                  <Button 
                    icon={<HistoryOutlined />}
                    onClick={handleViewHistory}
                    block
                  >
                    查看历史
                  </Button>
                </div>
              </div>
            ) : (
              <div className="analysis-empty">
                <Empty
                  image={<RobotOutlined style={{ fontSize: 64, color: '#d9d9d9' }} />}
                  description="暂无分析记录"
                >
                  <p className="empty-tip">让AI帮你分析时间管理，发现优化空间！</p>
                  <Button 
                    type="primary" 
                    icon={<ThunderboltOutlined />}
                    onClick={handleNewAnalysis}
                    loading={analysisLoading}
                  >
                    立即分析
                  </Button>
                </Empty>
              </div>
            )}
          </Spin>
        </div>
        
        {/* 中间日历面板 - 4x4网格 */}
        <div className="calendar-main-panel calendar-grid-panel">
          {/* 日历头部控制栏 */}
          <div className="calendar-controls">
            <div className="controls-left">
              <Button 
                icon={<SettingOutlined />}
                onClick={handleOpenSettings}
              >
                设置
              </Button>
            </div>
            
            <div className="controls-center">
              <Button 
                icon={<LeftOutlined />} 
                onClick={handlePrevPeriod}
                size="small"
              />
              <Button 
                onClick={handleToday}
                size="small"
              >
                今天
              </Button>
              <Button 
                icon={<RightOutlined />} 
                onClick={handleNextPeriod}
                size="small"
              />
            </div>
            
            <div className="controls-right">
              <span className="date-range-display">
                {dateRange[0].format('MM/DD')} - {dateRange[15].format('MM/DD')}
              </span>
            </div>
          </div>
          
          {/* 4x4日历网格 */}
          <Spin spinning={eventsLoading}>
            <div className="calendar-grid">
              {gridDates.map((row, rowIndex) => (
                <div key={rowIndex} className="calendar-grid-row">
                  {row.map((date, colIndex) => {
                    const stats = getDateStats(date);
                    const isToday = date.isSame(dayjs(), 'day');
                    const isSelected = date.isSame(selectedDate, 'day');
                    
                    return (
                      <div
                        key={colIndex}
                        className={`calendar-grid-cell ${isToday ? 'is-today' : ''} ${isSelected ? 'is-selected' : ''}`}
                        onClick={() => handleSelectDate(date)}
                      >
                        <div className="cell-header">
                          <span className="cell-weekday">{date.format('ddd')}</span>
                          <span className="cell-date">{date.format('DD')}</span>
                        </div>
                        
                        {isToday && <div className="today-badge">今日</div>}
                        
                        {stats.count > 0 && (
                          <div className="cell-events">
                            {stats.count > 3 ? (
                              <div className="event-count-badge">{stats.count}</div>
                            ) : (
                              <div className="event-dots">
                                {Array.from({ length: stats.count }).map((_, i) => (
                                  <div 
                                    key={i} 
                                    className={`event-dot ${stats.highPriority > 0 ? 'high-priority' : ''}`}
                                  />
                                ))}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </Spin>
        </div>
        
        {/* 右侧事项列表 */}
        <div className="calendar-right-panel">
          <div className="panel-header">
            <h3>事项详情</h3>
            <span className="date-display">
              {selectedDate.format('YYYY年MM月DD日')}
            </span>
          </div>
          
          {/* 创建事项按钮 */}
          <Button 
            type="primary" 
            icon={<PlusOutlined />}
            block
            onClick={handleCreateEvent}
            style={{ marginBottom: 16 }}
          >
            创建事项
          </Button>
          
          <div className="events-list">
            {selectedDateEvents.length === 0 ? (
              <div className="empty-events">
                <CalendarOutlined />
                <p>当前无事项</p>
              </div>
            ) : (
              selectedDateEvents.map(event => {
                const badge = getImportanceBadge(event.importance);
                return (
                  <div 
                    key={event.id} 
                    className={`event-card status-${event.status}`}
                    style={{ borderLeftColor: IMPORTANCE_COLORS[event.importance] }}
                  >
                    <div className="event-header">
                      <div className="event-title">{event.content}</div>
                      <span className={`importance-badge ${badge.class}`}>
                        {badge.text}
                      </span>
                    </div>
                    
                    <div className="event-meta">
                      <div className="meta-item">
                        {getStatusIcon(event.status)}
                        <span>{t(`calendar.event.status.${event.status}`)}</span>
                      </div>
                      <div className="meta-item">
                        <Tag color={event.color || '#007AFF'}>{event.category}</Tag>
                      </div>
                    </div>
                    
                    <div className="event-actions">
                      <Button 
                        className="btn-edit"
                        size="small"
                        icon={<EditOutlined />}
                        onClick={() => handleEditEvent(event)}
                      >
                        编辑
                      </Button>
                      <Popconfirm
                        title="确认删除此事项？"
                        onConfirm={() => handleDeleteEvent(event.id)}
                        okText="确认"
                        cancelText="取消"
                      >
                        <Button 
                          className="btn-delete"
                          size="small"
                          icon={<DeleteOutlined />}
                        >
                          删除
                        </Button>
                      </Popconfirm>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>
      
      {/* 事项表单模态框 */}
      <Modal
        title={editingEvent ? '编辑事项' : '创建事项'}
        open={eventModalVisible}
        onOk={handleEventSubmit}
        onCancel={() => setEventModalVisible(false)}
        width={600}
        okText="确认"
        cancelText="取消"
        className="event-form-modal"
      >
        <Form form={form} layout="vertical">
          <Form.Item
            name="content"
            label="事项内容"
            rules={[{ required: true, message: '请输入事项内容' }]}
          >
            <TextArea rows={4} placeholder="请输入事项内容" />
          </Form.Item>
          
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="event_date"
                label="日期"
                rules={[{ required: true, message: '请选择日期' }]}
              >
                <DatePicker style={{ width: '100%' }} />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="category"
                label="分类"
                rules={[{ required: true, message: '请选择分类' }]}
              >
                <Select placeholder="请选择分类">
                  {categories.map(cat => (
                    <Option key={cat.id} value={cat.name}>{cat.name}</Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
          </Row>
          
          <Form.Item name="importance" label="重要度">
            <Slider 
              min={1} 
              max={10} 
              marks={{ 1: '1', 5: '5', 10: '10' }}
              className="importance-slider"
            />
          </Form.Item>
          
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item name="status" label="状态">
                <Select>
                  <Option value="not_started">未开始</Option>
                  <Option value="in_progress">进行中</Option>
                  <Option value="completed">已完成</Option>
                  <Option value="daily">日常</Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="recurrence_type" label="重复">
                <Select>
                  <Option value="none">不重复</Option>
                  <Option value="daily">每天</Option>
                  <Option value="weekly">每周</Option>
                  <Option value="monthly">每月</Option>
                </Select>
              </Form.Item>
            </Col>
          </Row>
          
          <Form.Item name="file_link" label="文件链接">
            <Input placeholder="可选：相关文件链接" />
          </Form.Item>
        </Form>
      </Modal>
      
      {/* AI分析设置模态框 */}
      <Modal
        title={<><SettingOutlined /> AI分析设置</>}
        open={settingsModalVisible}
        onOk={handleSaveSettings}
        onCancel={() => setSettingsModalVisible(false)}
        width={600}
        okText="保存设置"
        cancelText="取消"
        className="ai-analysis-modal"
      >
        <Spin spinning={aiModelsLoading || configLoading}>
          <Form form={settingsForm} layout="vertical">
            <Form.Item
              name="model_id"
              label="选择AI模型"
              rules={[{ required: true, message: '请选择AI模型' }]}
            >
              <Select placeholder="请选择AI模型">
                {aiModels.filter(m => m.is_active).map(model => (
                  <Option key={model.id} value={model.id}>
                    {model.display_name} ({model.credits_per_chat} 积分/次)
                  </Option>
                ))}
              </Select>
            </Form.Item>
            
            <Form.Item
              name="template_id"
              label="分析模板"
              tooltip="选择分析模板，不选则使用默认模板"
            >
              <Select placeholder="请选择模板（可选）" allowClear>
                {promptTemplates.map(template => (
                  <Option key={template.id} value={template.id}>
                    {template.name}
                    {template.is_default && ' (默认)'}
                  </Option>
                ))}
              </Select>
            </Form.Item>
            
            <Row gutter={16}>
              <Col span={12}>
                <Form.Item
                  name="scan_days_before"
                  label="今日前"
                  rules={[
                    { required: true, message: '请输入天数' },
                    { type: 'number', min: 1, max: 365, message: '范围1-365天' }
                  ]}
                >
                  <InputNumber 
                    min={1} 
                    max={365} 
                    style={{ width: '100%' }}
                    addonAfter="天"
                  />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item
                  name="scan_days_after"
                  label="今日后"
                  rules={[
                    { required: true, message: '请输入天数' },
                    { type: 'number', min: 1, max: 365, message: '范围1-365天' }
                  ]}
                >
                  <InputNumber 
                    min={1} 
                    max={365} 
                    style={{ width: '100%' }}
                    addonAfter="天"
                  />
                </Form.Item>
              </Col>
            </Row>
          </Form>
        </Spin>
      </Modal>
      
      {/* 历史记录模态框 - 支持展开详情 */}
      <Modal
        title={<><HistoryOutlined /> 分析历史</>}
        open={historyModalVisible}
        onCancel={() => {
          setHistoryModalVisible(false);
          setExpandedHistoryId(null);
        }}
        footer={null}
        width={900}
        className="history-modal"
      >
        <div className="history-list">
          {analysisHistory.length === 0 ? (
            <Empty description="暂无历史记录" />
          ) : (
            analysisHistory.map(item => (
              <div 
                key={item.id} 
                className={`history-item ${expandedHistoryId === item.id ? 'expanded' : ''}`}
              >
                {/* 头部：可点击展开/收起 */}
                <div 
                  className="item-header clickable"
                  onClick={() => handleToggleHistory(item.id)}
                >
                  <div className="header-left">
                    <span className="item-time">
                      {dayjs(item.created_at).format('YYYY-MM-DD HH:mm')}
                    </span>
                    <Tag color="blue">{item.model_name}</Tag>
                  </div>
                  <div className="header-right">
                    {expandedHistoryId === item.id ? 
                      <DownOutlined style={{ color: '#667eea' }} /> : 
                      <RightExpandOutlined style={{ color: '#8e8e93' }} />
                    }
                  </div>
                </div>
                
                {/* 基本信息 */}
                <div className="item-info">
                  分析了 {item.events_count} 个事项 | 消耗 {item.credits_consumed} 积分
                </div>
                
                {/* 展开详情：完整分析内容 */}
                {expandedHistoryId === item.id && (
                  <div className="item-detail">
                    <ReactMarkdown>
                      {item.analysis_result?.raw_text || '暂无分析内容'}
                    </ReactMarkdown>
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </Modal>
    </div>
  );
};

export default CalendarPage;
