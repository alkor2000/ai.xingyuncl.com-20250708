/**
 * 智能日历主页面
 * iOS科技风格设计
 */

import React, { useState, useEffect } from 'react';
import { 
  Calendar as AntCalendar, 
  Badge, 
  Button, 
  Modal, 
  Form, 
  Input, 
  InputNumber, 
  Select, 
  DatePicker, 
  Slider, 
  message,
  Spin,
  Empty,
  Tooltip,
  Space,
  Tag,
  Popconfirm
} from 'antd';
import {
  PlusOutlined,
  ThunderboltOutlined,
  SettingOutlined,
  CalendarOutlined,
  CheckCircleOutlined,
  ClockCircleOutlined,
  ExclamationCircleOutlined,
  EditOutlined,
  DeleteOutlined,
  RobotOutlined,
  HistoryOutlined,
  BarChartOutlined
} from '@ant-design/icons';
import { useTranslation } from 'react-i18next';
import dayjs from 'dayjs';
import ReactMarkdown from 'react-markdown';
import useCalendarStore from '../../stores/calendarStore';
import useAuthStore from '../../stores/authStore';
import './Calendar.less';

const { TextArea } = Input;
const { Option } = Select;

// 重要度颜色映射
const IMPORTANCE_COLORS = {
  1: '#C7C7CC', 2: '#C7C7CC',  // 很低
  3: '#8E8E93', 4: '#8E8E93',  // 低
  5: '#007AFF', 6: '#007AFF',  // 中等
  7: '#FF9500', 8: '#FF9500',  // 高
  9: '#FF3B30', 10: '#FF3B30'  // 很高/紧急
};

// 分类预设颜色
const CATEGORY_COLORS = [
  '#007AFF', '#5AC8FA', '#34C759', '#FF9500',
  '#FF3B30', '#FF2D55', '#AF52DE', '#5856D6'
];

const CalendarPage = () => {
  const { t } = useTranslation();
  const { user } = useAuthStore();
  
  // Store状态
  const {
    events,
    categories,
    overview,
    currentMonthStats,
    eventsLoading,
    categoriesLoading,
    overviewLoading,
    selectedDate,
    setSelectedDate,
    fetchEvents,
    fetchCategories,
    fetchOverview,
    fetchMonthStats,
    createEvent,
    updateEvent,
    deleteEvent,
    markEventComplete
  } = useCalendarStore();
  
  // 本地状态
  const [form] = Form.useForm();
  const [selectedValue, setSelectedValue] = useState(dayjs());
  const [eventModalVisible, setEventModalVisible] = useState(false);
  const [editingEvent, setEditingEvent] = useState(null);
  const [aiModalVisible, setAiModalVisible] = useState(false);
  
  // 获取选中日期的事项
  const selectedDateEvents = events.filter(event => 
    dayjs(event.event_date).isSame(selectedValue, 'day')
  );
  
  // 初始化数据
  useEffect(() => {
    loadInitialData();
  }, []);
  
  const loadInitialData = async () => {
    try {
      await Promise.all([
        fetchCategories(),
        fetchOverview(),
        loadCurrentMonthEvents()
      ]);
    } catch (error) {
      console.error('加载数据失败:', error);
    }
  };
  
  // 加载当前月的事项
  const loadCurrentMonthEvents = async () => {
    const year = selectedValue.year();
    const month = selectedValue.month() + 1;
    const startDate = selectedValue.startOf('month').format('YYYY-MM-DD');
    const endDate = selectedValue.endOf('month').format('YYYY-MM-DD');
    
    await Promise.all([
      fetchEvents(startDate, endDate),
      fetchMonthStats(year, month)
    ]);
  };
  
  // 日期选择变化
  const onPanelChange = (value) => {
    setSelectedValue(value);
    loadCurrentMonthEvents();
  };
  
  // 日期点击
  const onSelect = (value) => {
    setSelectedValue(value);
    setSelectedDate(value.toDate());
  };
  
  // 打开创建事项模态框
  const handleCreateEvent = () => {
    setEditingEvent(null);
    form.resetFields();
    form.setFieldsValue({
      event_date: selectedValue,
      importance: 5,
      status: 'not_started',
      recurrence_type: 'none'
    });
    setEventModalVisible(true);
  };
  
  // 打开编辑事项模态框
  const handleEditEvent = (event) => {
    setEditingEvent(event);
    form.setFieldsValue({
      ...event,
      event_date: dayjs(event.event_date)
    });
    setEventModalVisible(true);
  };
  
  // 提交事项表单
  const handleEventSubmit = async () => {
    try {
      const values = await form.validateFields();
      const eventData = {
        ...values,
        event_date: values.event_date.format('YYYY-MM-DD'),
        recurrence_end_date: values.recurrence_end_date ? 
          values.recurrence_end_date.format('YYYY-MM-DD') : null
      };
      
      if (editingEvent) {
        await updateEvent(editingEvent.id, eventData);
      } else {
        await createEvent(eventData);
      }
      
      setEventModalVisible(false);
      loadCurrentMonthEvents();
    } catch (error) {
      console.error('提交失败:', error);
    }
  };
  
  // 删除事项
  const handleDeleteEvent = async (eventId) => {
    try {
      await deleteEvent(eventId);
      loadCurrentMonthEvents();
    } catch (error) {
      console.error('删除失败:', error);
    }
  };
  
  // 快速标记完成
  const handleMarkComplete = async (eventId) => {
    try {
      await markEventComplete(eventId);
      loadCurrentMonthEvents();
    } catch (error) {
      console.error('标记失败:', error);
    }
  };
  
  // 渲染日历单元格内容
  const dateCellRender = (value) => {
    const dateStr = value.format('YYYY-MM-DD');
    const dayEvents = currentMonthStats.find(stat => stat.date === dateStr);
    
    if (!dayEvents || dayEvents.count === 0) {
      return null;
    }
    
    return (
      <div className="event-dots">
        {dayEvents.count > 3 ? (
          <div className="event-count">{dayEvents.count}</div>
        ) : (
          Array.from({ length: Math.min(dayEvents.count, 3) }).map((_, i) => (
            <div 
              key={i} 
              className={`event-dot ${dayEvents.high_priority > 0 ? 'high-priority' : ''}`}
            />
          ))
        )}
      </div>
    );
  };
  
  // 获取状态图标
  const getStatusIcon = (status) => {
    switch (status) {
      case 'completed':
        return <CheckCircleOutlined style={{ color: '#34C759' }} />;
      case 'in_progress':
        return <ClockCircleOutlined style={{ color: '#FF9500' }} />;
      case 'not_started':
        return <ExclamationCircleOutlined style={{ color: '#8E8E93' }} />;
      default:
        return <CalendarOutlined />;
    }
  };
  
  // 获取重要度标签
  const getImportanceBadge = (importance) => {
    if (importance >= 8) return { text: t('calendar.importance.high'), class: 'high' };
    if (importance >= 5) return { text: t('calendar.importance.medium'), class: 'medium' };
    return { text: t('calendar.importance.low'), class: 'low' };
  };

  return (
    <div className="calendar-page">
      {/* 顶部工具栏 */}
      <div className="calendar-header">
        <div className="header-title">
          <h1>
            <CalendarOutlined /> {t('calendar.title')}
          </h1>
          <p>{t('calendar.subtitle')}</p>
        </div>
        
        <div className="header-actions">
          <Button 
            type="primary" 
            icon={<PlusOutlined />}
            onClick={handleCreateEvent}
          >
            {t('calendar.event.create')}
          </Button>
          
          <Button 
            icon={<RobotOutlined />}
            onClick={() => setAiModalVisible(true)}
          >
            {t('calendar.ai.analysis')}
          </Button>
          
          <Button 
            icon={<SettingOutlined />}
          >
            {t('calendar.settings.title')}
          </Button>
        </div>
      </div>
      
      {/* 主内容区域 */}
      <div className="calendar-content">
        {/* 左侧统计面板 */}
        <div className="calendar-left-panel">
          <Spin spinning={overviewLoading}>
            {/* 今日概览 */}
            <div className="overview-section">
              <div className="section-title">
                <CalendarOutlined />
                {t('calendar.overview.today')}
              </div>
              
              {overview && (
                <div className="stats-grid">
                  <div className="stat-card">
                    <div className="stat-value">{overview.today?.total || 0}</div>
                    <div className="stat-label">{t('calendar.overview.total')}</div>
                  </div>
                  
                  <div className="stat-card completed">
                    <div className="stat-value">{overview.today?.completed || 0}</div>
                    <div className="stat-label">{t('calendar.overview.completed')}</div>
                  </div>
                  
                  <div className="stat-card in-progress">
                    <div className="stat-value">{overview.today?.in_progress || 0}</div>
                    <div className="stat-label">{t('calendar.overview.inProgress')}</div>
                  </div>
                  
                  <div className="stat-card high-priority">
                    <div className="stat-value">{overview.today?.high_priority || 0}</div>
                    <div className="stat-label">{t('calendar.overview.highPriority')}</div>
                  </div>
                </div>
              )}
            </div>
            
            {/* 分类统计 */}
            <div className="overview-section">
              <div className="section-title">
                <BarChartOutlined />
                {t('calendar.overview.byCategory')}
              </div>
              
              {overview?.upcoming?.by_category && (
                <div className="category-list">
                  {Object.entries(overview.upcoming.by_category).map(([category, count]) => {
                    const categoryObj = categories.find(c => c.name === category);
                    return (
                      <div key={category} className="category-item">
                        <div className="category-info">
                          <div 
                            className="category-color" 
                            style={{ backgroundColor: categoryObj?.color || '#007AFF' }}
                          />
                          <span className="category-name">{category}</span>
                        </div>
                        <span className="category-count">{count}</span>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </Spin>
        </div>
        
        {/* 中间日历面板 */}
        <div className="calendar-main-panel">
          <Spin spinning={eventsLoading}>
            <AntCalendar
              value={selectedValue}
              onPanelChange={onPanelChange}
              onSelect={onSelect}
              dateCellRender={dateCellRender}
            />
          </Spin>
        </div>
        
        {/* 右侧事项列表 */}
        <div className="calendar-right-panel">
          <div className="panel-header">
            <h3>{t('calendar.event.detail')}</h3>
            <span className="date-display">
              {selectedValue.format('YYYY年MM月DD日')}
            </span>
          </div>
          
          <div className="events-list">
            {selectedDateEvents.length === 0 ? (
              <div className="empty-events">
                <CalendarOutlined />
                <p>{t('calendar.event.noEvents')}</p>
              </div>
            ) : (
              selectedDateEvents.map(event => {
                const importanceBadge = getImportanceBadge(event.importance);
                return (
                  <div 
                    key={event.id} 
                    className={`event-card status-${event.status}`}
                    style={{ borderLeftColor: IMPORTANCE_COLORS[event.importance] }}
                  >
                    <div className="event-header">
                      <div className="event-title">{event.content}</div>
                      <span className={`importance-badge ${importanceBadge.class}`}>
                        {importanceBadge.text}
                      </span>
                    </div>
                    
                    <div className="event-meta">
                      <div className="meta-item">
                        {getStatusIcon(event.status)}
                        <span>{t(`calendar.event.status.${event.status}`)}</span>
                      </div>
                      
                      <div className="meta-item">
                        <Tag color={event.color || '#007AFF'}>{event.category}</Tag>
                      </div>
                    </div>
                    
                    <div className="event-actions">
                      {event.status !== 'completed' && (
                        <Button 
                          className="btn-complete"
                          size="small"
                          icon={<CheckCircleOutlined />}
                          onClick={() => handleMarkComplete(event.id)}
                        >
                          {t('calendar.action.markComplete')}
                        </Button>
                      )}
                      
                      <Button 
                        className="btn-edit"
                        size="small"
                        icon={<EditOutlined />}
                        onClick={() => handleEditEvent(event)}
                      >
                        {t('calendar.event.edit')}
                      </Button>
                      
                      <Popconfirm
                        title={t('calendar.message.confirmDelete')}
                        onConfirm={() => handleDeleteEvent(event.id)}
                        okText={t('common.confirm')}
                        cancelText={t('common.cancel')}
                      >
                        <Button 
                          className="btn-delete"
                          size="small"
                          icon={<DeleteOutlined />}
                          danger
                        >
                          {t('calendar.event.delete')}
                        </Button>
                      </Popconfirm>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>
      
      {/* 事项表单模态框 - 下一部分继续 */}
    </div>
  );
};

export default CalendarPage;
