/**
 * 智能教学授权管理组件（三级权限版 v2.1.0 - 修复继承开关）
 * 
 * 版本更新 (2025-10-31):
 * ✅ 修复"取消继承权限消失"问题
 *    - 取消继承时自动复制上级权限到当前级别
 *    - 保持权限连续性，用户体验平滑过渡
 * ✅ 三级权限体系实施：
 *    - view_lesson（查看课程）- Level 1: 学生权限
 *    - view_plan（查看教案）- Level 2: 教师权限
 *    - edit（编辑）- Level 3: 完全控制
 * ✅ 级联逻辑：
 *    - 授予高级权限自动授予下级（edit→view_plan→view_lesson）
 *    - 撤销低级权限自动撤销上级（view_lesson←view_plan←edit）
 * ✅ 数据兼容性：自动迁移旧的view字段为view_lesson
 * 
 * 位置：系统设置 → 教学管理 → 智能教学授权管理（第一个子标签）
 */

import React, { useState, useEffect } from 'react';
import {
  Card,
  Button,
  Space,
  Empty,
  Modal,
  Checkbox,
  Input,
  message,
  Spin,
  Alert,
  Tag,
  Collapse,
  Switch,
  Badge,
  Divider,
  Pagination,
  Tooltip
} from 'antd';
import {
  PlusOutlined,
  SaveOutlined,
  ReloadOutlined,
  TeamOutlined,
  TagOutlined,
  UserOutlined,
  BookOutlined,
  FileTextOutlined,
  DeleteOutlined,
  DownOutlined,
  UpOutlined,
  RightOutlined,
  CheckCircleOutlined,
  ExclamationCircleOutlined,
  CaretRightOutlined,
  CaretDownOutlined,
  MinusOutlined,
  ReadOutlined,
  EditOutlined
} from '@ant-design/icons';
import { useTranslation } from 'react-i18next';
import api from '../../../utils/api';

const { Panel } = Collapse;
const { Search } = Input;

const ModuleAuthorizationManagement = () => {
  const { t } = useTranslation();

  // ==================== 状态管理 ====================
  const [loading, setLoading] = useState(false);
  const [authorizedGroups, setAuthorizedGroups] = useState([]);
  const [allGroups, setAllGroups] = useState([]);
  const [allModules, setAllModules] = useState([]);
  const [groupSelectModalVisible, setGroupSelectModalVisible] = useState(false);
  const [selectedGroups, setSelectedGroups] = useState([]);
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  
  const [loadingLessons, setLoadingLessons] = useState({});
  const [moduleLessons, setModuleLessons] = useState({});
  
  const [loadingUsers, setLoadingUsers] = useState({});
  const [tagUsers, setTagUsers] = useState({});
  const [userPagination, setUserPagination] = useState({});

  // ==================== 数据加载 ====================

  useEffect(() => {
    loadInitialData();
  }, []);

  const loadInitialData = async () => {
    setLoading(true);
    try {
      const [groupsRes, modulesRes] = await Promise.all([
        api.get('/admin/user-groups'),
        api.get('/teaching/admin/modules', { params: { limit: 1000 } })
      ]);

      const groups = groupsRes.data.data || [];
      const modules = (modulesRes.data.data?.modules || modulesRes.data.data || [])
        .filter(m => m.status === 'published');

      setAllGroups(groups);
      setAllModules(modules);

      await loadAuthorizedGroups();
    } catch (error) {
      console.error('加载数据失败:', error);
      message.error('加载数据失败');
    } finally {
      setLoading(false);
    }
  };

  /**
   * 数据迁移函数：将旧的view字段转为view_lesson
   */
  const migratePermissionData = (perm) => {
    const migrated = { ...perm };
    
    if (migrated.view !== undefined && migrated.view_lesson === undefined) {
      migrated.view_lesson = migrated.view;
      delete migrated.view;
    }
    
    if (migrated.lessons && Array.isArray(migrated.lessons)) {
      migrated.lessons = migrated.lessons.map(lesson => {
        const migratedLesson = { ...lesson };
        if (migratedLesson.view !== undefined && migratedLesson.view_lesson === undefined) {
          migratedLesson.view_lesson = migratedLesson.view;
          delete migratedLesson.view;
        }
        return migratedLesson;
      });
    }
    
    return migrated;
  };

  const loadAuthorizedGroups = async () => {
    try {
      const res = await api.get('/teaching/authorization');
      const authorizations = res.data.data || [];
      
      const formattedGroups = authorizations.map(auth => ({
        groupId: auth.groupId,
        groupName: auth.groupName,
        userCount: auth.userCount,
        expanded: false,
        showTags: false,
        modulePermissions: (auth.config?.modulePermissions || []).map(migratePermissionData),
        tags: (auth.config?.tags || []).map(tag => ({
          ...tag,
          showUsers: false,
          expanded: false,
          modulePermissions: (tag.modulePermissions || []).map(migratePermissionData),
          users: (tag.users || []).map(user => ({
            ...user,
            modulePermissions: (user.modulePermissions || []).map(migratePermissionData)
          }))
        }))
      }));
      
      setAuthorizedGroups(formattedGroups);
      setHasUnsavedChanges(false);
    } catch (error) {
      console.error('加载授权配置失败:', error);
      setAuthorizedGroups([]);
    }
  };

  // ==================== 课程加载 ====================

  const handleLoadLessons = async (moduleId) => {
    if (moduleLessons[moduleId]) {
      return;
    }

    setLoadingLessons(prev => ({ ...prev, [moduleId]: true }));
    try {
      const res = await api.get(`/teaching/modules/${moduleId}/lessons-for-auth`);
      const lessons = res.data.data || [];
      
      setModuleLessons(prev => ({
        ...prev,
        [moduleId]: lessons
      }));
    } catch (error) {
      console.error('加载课程列表失败:', error);
      message.error('加载课程列表失败');
    } finally {
      setLoadingLessons(prev => ({ ...prev, [moduleId]: false }));
    }
  };

  // ==================== 用户加载（分页）====================

  const handleLoadUsers = async (groupId, tagId, page = 1) => {
    const key = `${groupId}-${tagId}`;
    setLoadingUsers(prev => ({ ...prev, [key]: true }));
    
    try {
      const res = await api.get(`/teaching/tags/${tagId}/users`, {
        params: { page, limit: 20 }
      });
      
      const { users, pagination } = res.data.data;
      
      setTagUsers(prev => ({
        ...prev,
        [key]: {
          ...(prev[key] || {}),
          [page]: users
        }
      }));
      
      setUserPagination(prev => ({
        ...prev,
        [key]: pagination
      }));

      setAuthorizedGroups(prevGroups =>
        prevGroups.map(group => {
          if (group.groupId !== groupId) return group;
          
          return {
            ...group,
            tags: group.tags.map(tag => {
              if (tag.tagId !== tagId) return tag;
              
              const existingUsers = tag.users || [];
              
              const newUsers = users.map(u => {
                const existingUser = existingUsers.find(eu => eu.userId === u.id);
                
                if (existingUser) {
                  return {
                    ...existingUser,
                    username: u.username,
                    email: u.email,
                    remark: u.remark
                  };
                } else {
                  return {
                    userId: u.id,
                    username: u.username,
                    email: u.email,
                    remark: u.remark,
                    inheritFromTag: true,
                    modulePermissions: []
                  };
                }
              });
              
              return {
                ...tag,
                users: newUsers,
                showUsers: true,
                currentPage: page
              };
            })
          };
        })
      );
    } catch (error) {
      console.error('加载用户列表失败:', error);
      message.error('加载用户列表失败');
    } finally {
      setLoadingUsers(prev => ({ ...prev, [key]: false }));
    }
  };

  // ==================== 组管理 ====================

  const handleOpenGroupSelectModal = () => {
    setSelectedGroups([]);
    setGroupSelectModalVisible(true);
  };

  const handleAddGroups = () => {
    if (selectedGroups.length === 0) {
      message.warning('请选择至少一个用户组');
      return;
    }

    const newGroups = selectedGroups
      .filter(gid => !authorizedGroups.find(ag => ag.groupId === gid))
      .map(gid => {
        const group = allGroups.find(g => g.id === gid);
        return {
          groupId: gid,
          groupName: group?.name || '',
          userCount: group?.user_count || 0,
          expanded: true,
          showTags: false,
          modulePermissions: [],
          tags: []
        };
      });

    setAuthorizedGroups([...authorizedGroups, ...newGroups]);
    setGroupSelectModalVisible(false);
    setHasUnsavedChanges(true);
    message.success(`已添加 ${newGroups.length} 个用户组`);
  };

  const handleRemoveGroup = (groupId) => {
    Modal.confirm({
      title: '确认移除授权',
      content: '移除此用户组将删除其所有授权配置，确定继续吗？',
      okText: '确认',
      cancelText: '取消',
      okButtonProps: { danger: true },
      onOk: () => {
        setAuthorizedGroups(authorizedGroups.filter(g => g.groupId !== groupId));
        setHasUnsavedChanges(true);
        message.success('已移除用户组授权');
      }
    });
  };

  const handleToggleTags = (groupId) => {
    setAuthorizedGroups(prev =>
      prev.map(group => {
        if (group.groupId === groupId) {
          if (!group.showTags) {
            handleLoadTags(groupId);
            return group;
          } else {
            return { ...group, showTags: false };
          }
        }
        return group;
      })
    );
  };

  const handleToggleUsers = (groupId, tagId) => {
    setAuthorizedGroups(prev =>
      prev.map(group => {
        if (group.groupId === groupId) {
          return {
            ...group,
            tags: group.tags.map(tag => {
              if (tag.tagId === tagId) {
                if (!tag.showUsers) {
                  handleLoadUsers(groupId, tagId, 1);
                  return tag;
                } else {
                  return { ...tag, showUsers: false };
                }
              }
              return tag;
            })
          };
        }
        return group;
      })
    );
  };

  // ==================== 核心权限管理逻辑（三级权限 + 级联）====================

  /**
   * 三级权限切换处理（核心函数）
   */
  const handleToggleModulePermission = (groupId, tagId, userId, moduleId, lessonId, permType, currentValue) => {
    setAuthorizedGroups(prev => {
      const newGroups = prev.map(group => {
        if (group.groupId !== groupId) return group;

        // ==================== 组级权限 ====================
        if (!tagId && !userId) {
          const modulePerms = group.modulePermissions || [];
          const existingIndex = modulePerms.findIndex(mp => mp.moduleId === moduleId);
          
          if (!lessonId) {
            if (currentValue) {
              if (existingIndex >= 0) {
                const updated = [...modulePerms];
                
                if (permType === 'view_lesson') {
                  delete updated[existingIndex].view_lesson;
                  delete updated[existingIndex].view_plan;
                  delete updated[existingIndex].edit;
                  
                  if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                    updated.splice(existingIndex, 1);
                  }
                } else if (permType === 'view_plan') {
                  delete updated[existingIndex].view_plan;
                  delete updated[existingIndex].edit;
                  
                  if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                    updated.splice(existingIndex, 1);
                  }
                } else if (permType === 'edit') {
                  delete updated[existingIndex].edit;
                  
                  if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                    updated.splice(existingIndex, 1);
                  }
                }
                
                return { ...group, modulePermissions: updated };
              }
            } else {
              if (existingIndex >= 0) {
                const updated = [...modulePerms];
                
                if (permType === 'edit') {
                  updated[existingIndex] = {
                    ...updated[existingIndex],
                    view_lesson: true,
                    view_plan: true,
                    edit: true
                  };
                } else if (permType === 'view_plan') {
                  updated[existingIndex] = {
                    ...updated[existingIndex],
                    view_lesson: true,
                    view_plan: true
                  };
                } else {
                  updated[existingIndex] = {
                    ...updated[existingIndex],
                    view_lesson: true
                  };
                }
                
                return { ...group, modulePermissions: updated };
              } else {
                const newPerm = {
                  moduleId,
                  moduleName: allModules.find(m => m.id === moduleId)?.name || '',
                  expanded: false,
                  lessons: []
                };
                
                if (permType === 'edit') {
                  newPerm.view_lesson = true;
                  newPerm.view_plan = true;
                  newPerm.edit = true;
                } else if (permType === 'view_plan') {
                  newPerm.view_lesson = true;
                  newPerm.view_plan = true;
                } else {
                  newPerm.view_lesson = true;
                }
                
                return {
                  ...group,
                  modulePermissions: [...modulePerms, newPerm]
                };
              }
            }
          } else {
            if (existingIndex >= 0) {
              const modulePerm = modulePerms[existingIndex];
              const lessons = modulePerm.lessons || [];
              const lessonIndex = lessons.findIndex(l => l.lessonId === lessonId);
              
              const updated = [...modulePerms];
              
              if (currentValue) {
                if (lessonIndex >= 0) {
                  const updatedLessons = [...lessons];
                  
                  if (permType === 'view_lesson') {
                    updatedLessons[lessonIndex] = {
                      ...updatedLessons[lessonIndex],
                      view_lesson: false,
                      view_plan: false,
                      edit: false,
                      inheritFromModule: false
                    };
                  } else if (permType === 'view_plan') {
                    updatedLessons[lessonIndex] = {
                      ...updatedLessons[lessonIndex],
                      view_plan: false,
                      edit: false,
                      inheritFromModule: false
                    };
                  } else if (permType === 'edit') {
                    updatedLessons[lessonIndex] = {
                      ...updatedLessons[lessonIndex],
                      edit: false,
                      inheritFromModule: false
                    };
                  }
                  
                  updated[existingIndex] = {
                    ...modulePerm,
                    lessons: updatedLessons
                  };
                } else {
                  const newLesson = {
                    lessonId,
                    lessonTitle: moduleLessons[moduleId]?.find(l => l.id === lessonId)?.title || '',
                    inheritFromModule: false
                  };
                  
                  if (permType === 'view_lesson') {
                    newLesson.view_lesson = false;
                    newLesson.view_plan = false;
                    newLesson.edit = false;
                  } else if (permType === 'view_plan') {
                    newLesson.view_lesson = true;
                    newLesson.view_plan = false;
                    newLesson.edit = false;
                  } else {
                    newLesson.view_lesson = true;
                    newLesson.view_plan = true;
                    newLesson.edit = false;
                  }
                  
                  updated[existingIndex] = {
                    ...modulePerm,
                    lessons: [...lessons, newLesson]
                  };
                }
              } else {
                if (lessonIndex >= 0) {
                  const updatedLessons = [...lessons];
                  
                  if (permType === 'edit') {
                    updatedLessons[lessonIndex] = {
                      ...updatedLessons[lessonIndex],
                      view_lesson: true,
                      view_plan: true,
                      edit: true,
                      inheritFromModule: false
                    };
                  } else if (permType === 'view_plan') {
                    updatedLessons[lessonIndex] = {
                      ...updatedLessons[lessonIndex],
                      view_lesson: true,
                      view_plan: true,
                      inheritFromModule: false
                    };
                  } else {
                    updatedLessons[lessonIndex] = {
                      ...updatedLessons[lessonIndex],
                      view_lesson: true,
                      inheritFromModule: false
                    };
                  }
                  
                  updated[existingIndex] = {
                    ...modulePerm,
                    lessons: updatedLessons
                  };
                } else {
                  const newLesson = {
                    lessonId,
                    lessonTitle: moduleLessons[moduleId]?.find(l => l.id === lessonId)?.title || '',
                    inheritFromModule: false
                  };
                  
                  if (permType === 'edit') {
                    newLesson.view_lesson = true;
                    newLesson.view_plan = true;
                    newLesson.edit = true;
                  } else if (permType === 'view_plan') {
                    newLesson.view_lesson = true;
                    newLesson.view_plan = true;
                  } else {
                    newLesson.view_lesson = true;
                  }
                  
                  updated[existingIndex] = {
                    ...modulePerm,
                    lessons: [...lessons, newLesson]
                  };
                }
              }
              return { ...group, modulePermissions: updated };
            }
          }
        }

        // ==================== 标签级权限 ====================
        if (tagId && !userId) {
          const tags = group.tags || [];
          const tagIndex = tags.findIndex(t => t.tagId === tagId);
          
          if (tagIndex >= 0) {
            const tag = tags[tagIndex];
            const modulePerms = tag.modulePermissions || [];
            const existingIndex = modulePerms.findIndex(mp => mp.moduleId === moduleId);
            
            const updatedTags = [...tags];
            
            if (!lessonId) {
              if (currentValue) {
                if (existingIndex >= 0) {
                  const updated = [...modulePerms];
                  
                  if (permType === 'view_lesson') {
                    delete updated[existingIndex].view_lesson;
                    delete updated[existingIndex].view_plan;
                    delete updated[existingIndex].edit;
                    
                    if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                      updated.splice(existingIndex, 1);
                    }
                  } else if (permType === 'view_plan') {
                    delete updated[existingIndex].view_plan;
                    delete updated[existingIndex].edit;
                    
                    if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                      updated.splice(existingIndex, 1);
                    }
                  } else if (permType === 'edit') {
                    delete updated[existingIndex].edit;
                    
                    if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                      updated.splice(existingIndex, 1);
                    }
                  }
                  
                  updatedTags[tagIndex] = { ...tag, modulePermissions: updated };
                }
              } else {
                if (existingIndex >= 0) {
                  const updated = [...modulePerms];
                  
                  if (permType === 'edit') {
                    updated[existingIndex] = {
                      ...updated[existingIndex],
                      view_lesson: true,
                      view_plan: true,
                      edit: true
                    };
                  } else if (permType === 'view_plan') {
                    updated[existingIndex] = {
                      ...updated[existingIndex],
                      view_lesson: true,
                      view_plan: true
                    };
                  } else {
                    updated[existingIndex] = {
                      ...updated[existingIndex],
                      view_lesson: true
                    };
                  }
                  
                  updatedTags[tagIndex] = { ...tag, modulePermissions: updated };
                } else {
                  const newPerm = {
                    moduleId,
                    moduleName: allModules.find(m => m.id === moduleId)?.name || '',
                    expanded: false,
                    lessons: []
                  };
                  
                  if (permType === 'edit') {
                    newPerm.view_lesson = true;
                    newPerm.view_plan = true;
                    newPerm.edit = true;
                  } else if (permType === 'view_plan') {
                    newPerm.view_lesson = true;
                    newPerm.view_plan = true;
                  } else {
                    newPerm.view_lesson = true;
                  }
                  
                  updatedTags[tagIndex] = {
                    ...tag,
                    modulePermissions: [...modulePerms, newPerm]
                  };
                }
              }
            } else {
              if (existingIndex >= 0) {
                const modulePerm = modulePerms[existingIndex];
                const lessons = modulePerm.lessons || [];
                const lessonIndex = lessons.findIndex(l => l.lessonId === lessonId);
                
                const updated = [...modulePerms];
                
                if (currentValue) {
                  if (lessonIndex >= 0) {
                    const updatedLessons = [...lessons];
                    
                    if (permType === 'view_lesson') {
                      updatedLessons[lessonIndex] = {
                        ...updatedLessons[lessonIndex],
                        view_lesson: false,
                        view_plan: false,
                        edit: false,
                        inheritFromModule: false
                      };
                    } else if (permType === 'view_plan') {
                      updatedLessons[lessonIndex] = {
                        ...updatedLessons[lessonIndex],
                        view_plan: false,
                        edit: false,
                        inheritFromModule: false
                      };
                    } else if (permType === 'edit') {
                      updatedLessons[lessonIndex] = {
                        ...updatedLessons[lessonIndex],
                        edit: false,
                        inheritFromModule: false
                      };
                    }
                    
                    updated[existingIndex] = {
                      ...modulePerm,
                      lessons: updatedLessons
                    };
                  } else {
                    const newLesson = {
                      lessonId,
                      lessonTitle: moduleLessons[moduleId]?.find(l => l.id === lessonId)?.title || '',
                      inheritFromModule: false
                    };
                    
                    if (permType === 'view_lesson') {
                      newLesson.view_lesson = false;
                      newLesson.view_plan = false;
                      newLesson.edit = false;
                    } else if (permType === 'view_plan') {
                      newLesson.view_lesson = true;
                      newLesson.view_plan = false;
                      newLesson.edit = false;
                    } else {
                      newLesson.view_lesson = true;
                      newLesson.view_plan = true;
                      newLesson.edit = false;
                    }
                    
                    updated[existingIndex] = {
                      ...modulePerm,
                      lessons: [...lessons, newLesson]
                    };
                  }
                } else {
                  if (lessonIndex >= 0) {
                    const updatedLessons = [...lessons];
                    
                    if (permType === 'edit') {
                      updatedLessons[lessonIndex] = {
                        ...updatedLessons[lessonIndex],
                        view_lesson: true,
                        view_plan: true,
                        edit: true,
                        inheritFromModule: false
                      };
                    } else if (permType === 'view_plan') {
                      updatedLessons[lessonIndex] = {
                        ...updatedLessons[lessonIndex],
                        view_lesson: true,
                        view_plan: true,
                        inheritFromModule: false
                      };
                    } else {
                      updatedLessons[lessonIndex] = {
                        ...updatedLessons[lessonIndex],
                        view_lesson: true,
                        inheritFromModule: false
                      };
                    }
                    
                    updated[existingIndex] = {
                      ...modulePerm,
                      lessons: updatedLessons
                    };
                  } else {
                    const newLesson = {
                      lessonId,
                      lessonTitle: moduleLessons[moduleId]?.find(l => l.id === lessonId)?.title || '',
                      inheritFromModule: false
                    };
                    
                    if (permType === 'edit') {
                      newLesson.view_lesson = true;
                      newLesson.view_plan = true;
                      newLesson.edit = true;
                    } else if (permType === 'view_plan') {
                      newLesson.view_lesson = true;
                      newLesson.view_plan = true;
                    } else {
                      newLesson.view_lesson = true;
                    }
                    
                    updated[existingIndex] = {
                      ...modulePerm,
                      lessons: [...lessons, newLesson]
                    };
                  }
                }
                updatedTags[tagIndex] = { ...tag, modulePermissions: updated };
              }
            }
            
            return { ...group, tags: updatedTags };
          }
        }

        // ==================== 用户级权限 ====================
        if (userId) {
          const tags = group.tags || [];
          const tagIndex = tags.findIndex(t => t.tagId === tagId);
          
          if (tagIndex >= 0) {
            const tag = tags[tagIndex];
            const users = tag.users || [];
            const userIndex = users.findIndex(u => u.userId === userId);
            
            if (userIndex >= 0) {
              const user = users[userIndex];
              const modulePerms = user.modulePermissions || [];
              const existingIndex = modulePerms.findIndex(mp => mp.moduleId === moduleId);
              
              const updatedUsers = [...users];
              
              if (!lessonId) {
                if (currentValue) {
                  if (existingIndex >= 0) {
                    const updated = [...modulePerms];
                    
                    if (permType === 'view_lesson') {
                      delete updated[existingIndex].view_lesson;
                      delete updated[existingIndex].view_plan;
                      delete updated[existingIndex].edit;
                      
                      if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                        updated.splice(existingIndex, 1);
                      }
                    } else if (permType === 'view_plan') {
                      delete updated[existingIndex].view_plan;
                      delete updated[existingIndex].edit;
                      
                      if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                        updated.splice(existingIndex, 1);
                      }
                    } else if (permType === 'edit') {
                      delete updated[existingIndex].edit;
                      
                      if (!updated[existingIndex].view_lesson && !updated[existingIndex].view_plan && !updated[existingIndex].edit) {
                        updated.splice(existingIndex, 1);
                      }
                    }
                    
                    updatedUsers[userIndex] = { ...user, modulePermissions: updated };
                  }
                } else {
                  if (existingIndex >= 0) {
                    const updated = [...modulePerms];
                    
                    if (permType === 'edit') {
                      updated[existingIndex] = {
                        ...updated[existingIndex],
                        view_lesson: true,
                        view_plan: true,
                        edit: true
                      };
                    } else if (permType === 'view_plan') {
                      updated[existingIndex] = {
                        ...updated[existingIndex],
                        view_lesson: true,
                        view_plan: true
                      };
                    } else {
                      updated[existingIndex] = {
                        ...updated[existingIndex],
                        view_lesson: true
                      };
                    }
                    
                    updatedUsers[userIndex] = { ...user, modulePermissions: updated };
                  } else {
                    const newPerm = {
                      moduleId,
                      moduleName: allModules.find(m => m.id === moduleId)?.name || '',
                      expanded: false,
                      lessons: []
                    };
                    
                    if (permType === 'edit') {
                      newPerm.view_lesson = true;
                      newPerm.view_plan = true;
                      newPerm.edit = true;
                    } else if (permType === 'view_plan') {
                      newPerm.view_lesson = true;
                      newPerm.view_plan = true;
                    } else {
                      newPerm.view_lesson = true;
                    }
                    
                    updatedUsers[userIndex] = {
                      ...user,
                      modulePermissions: [...modulePerms, newPerm]
                    };
                  }
                }
              } else {
                if (existingIndex >= 0) {
                  const modulePerm = modulePerms[existingIndex];
                  const lessons = modulePerm.lessons || [];
                  const lessonIndex = lessons.findIndex(l => l.lessonId === lessonId);
                  
                  const updated = [...modulePerms];
                  
                  if (currentValue) {
                    if (lessonIndex >= 0) {
                      const updatedLessons = [...lessons];
                      
                      if (permType === 'view_lesson') {
                        updatedLessons[lessonIndex] = {
                          ...updatedLessons[lessonIndex],
                          view_lesson: false,
                          view_plan: false,
                          edit: false,
                          inheritFromModule: false
                        };
                      } else if (permType === 'view_plan') {
                        updatedLessons[lessonIndex] = {
                          ...updatedLessons[lessonIndex],
                          view_plan: false,
                          edit: false,
                          inheritFromModule: false
                        };
                      } else if (permType === 'edit') {
                        updatedLessons[lessonIndex] = {
                          ...updatedLessons[lessonIndex],
                          edit: false,
                          inheritFromModule: false
                        };
                      }
                      
                      updated[existingIndex] = {
                        ...modulePerm,
                        lessons: updatedLessons
                      };
                    } else {
                      const newLesson = {
                        lessonId,
                        lessonTitle: moduleLessons[moduleId]?.find(l => l.id === lessonId)?.title || '',
                        inheritFromModule: false
                      };
                      
                      if (permType === 'view_lesson') {
                        newLesson.view_lesson = false;
                        newLesson.view_plan = false;
                        newLesson.edit = false;
                      } else if (permType === 'view_plan') {
                        newLesson.view_lesson = true;
                        newLesson.view_plan = false;
                        newLesson.edit = false;
                      } else {
                        newLesson.view_lesson = true;
                        newLesson.view_plan = true;
                        newLesson.edit = false;
                      }
                      
                      updated[existingIndex] = {
                        ...modulePerm,
                        lessons: [...lessons, newLesson]
                      };
                    }
                  } else {
                    if (lessonIndex >= 0) {
                      const updatedLessons = [...lessons];
                      
                      if (permType === 'edit') {
                        updatedLessons[lessonIndex] = {
                          ...updatedLessons[lessonIndex],
                          view_lesson: true,
                          view_plan: true,
                          edit: true,
                          inheritFromModule: false
                        };
                      } else if (permType === 'view_plan') {
                        updatedLessons[lessonIndex] = {
                          ...updatedLessons[lessonIndex],
                          view_lesson: true,
                          view_plan: true,
                          inheritFromModule: false
                        };
                      } else {
                        updatedLessons[lessonIndex] = {
                          ...updatedLessons[lessonIndex],
                          view_lesson: true,
                          inheritFromModule: false
                        };
                      }
                      
                      updated[existingIndex] = {
                        ...modulePerm,
                        lessons: updatedLessons
                      };
                    } else {
                      const newLesson = {
                        lessonId,
                        lessonTitle: moduleLessons[moduleId]?.find(l => l.id === lessonId)?.title || '',
                        inheritFromModule: false
                      };
                      
                      if (permType === 'edit') {
                        newLesson.view_lesson = true;
                        newLesson.view_plan = true;
                        newLesson.edit = true;
                      } else if (permType === 'view_plan') {
                        newLesson.view_lesson = true;
                        newLesson.view_plan = true;
                      } else {
                        newLesson.view_lesson = true;
                      }
                      
                      updated[existingIndex] = {
                        ...modulePerm,
                        lessons: [...lessons, newLesson]
                      };
                    }
                  }
                  updatedUsers[userIndex] = { ...user, modulePermissions: updated };
                }
              }
              
              const updatedTags = [...tags];
              updatedTags[tagIndex] = { ...tag, users: updatedUsers };
              return { ...group, tags: updatedTags };
            }
          }
        }

        return group;
      });
      
      setHasUnsavedChanges(true);
      return newGroups;
    });
  };

  // ==================== 标签管理 ====================

  const handleLoadTags = async (groupId) => {
    try {
      const tagsRes = await api.get(`/admin/user-tags/group/${groupId}`);
      const apiTags = (tagsRes.data.data || []).filter(t => t.is_active);

      setAuthorizedGroups(prev =>
        prev.map(g => {
          if (g.groupId !== groupId) return g;
          
          const existingTags = g.tags || [];
          
          const mergedTags = apiTags.map(apiTag => {
            const existingTag = existingTags.find(et => et.tagId === apiTag.id);
            
            if (existingTag) {
              return {
                ...existingTag,
                tagName: apiTag.name,
                tagColor: apiTag.color,
                userCount: apiTag.user_count || 0
              };
            } else {
              return {
                tagId: apiTag.id,
                tagName: apiTag.name,
                tagColor: apiTag.color,
                userCount: apiTag.user_count || 0,
                expanded: false,
                showUsers: false,
                inheritFromGroup: true,
                modulePermissions: [],
                users: []
              };
            }
          });
          
          return { ...g, tags: mergedTags, showTags: true };
        })
      );
    } catch (error) {
      console.error('加载标签失败:', error);
      message.error('加载标签失败');
    }
  };

  // ==================== 保存配置 ====================

  const handleSaveAll = async () => {
    setLoading(true);
    try {
      const configData = authorizedGroups.map(group => ({
        groupId: group.groupId,
        modulePermissions: group.modulePermissions || [],
        tags: group.tags.map(tag => ({
          tagId: tag.tagId,
          inheritFromGroup: tag.inheritFromGroup,
          modulePermissions: tag.modulePermissions || [],
          users: tag.users.map(user => ({
            userId: user.userId,
            inheritFromTag: user.inheritFromTag,
            modulePermissions: user.modulePermissions || []
          }))
        }))
      }));

      await api.post('/teaching/authorization/save', { authorizations: configData });
      
      message.success('授权配置保存成功');
      setHasUnsavedChanges(false);
      await loadAuthorizedGroups();
    } catch (error) {
      console.error('保存失败:', error);
      message.error(error.response?.data?.message || '保存授权配置失败');
    } finally {
      setLoading(false);
    }
  };

  const handleReset = () => {
    Modal.confirm({
      title: '确认重置',
      content: '重置将放弃所有未保存的更改，确定继续吗？',
      okText: '确认',
      cancelText: '取消',
      okButtonProps: { danger: true },
      onOk: () => {
        loadAuthorizedGroups();
        setHasUnsavedChanges(false);
        message.info('已重置为上次保存的状态');
      }
    });
  };

  // ==================== 渲染函数（三级权限UI）====================

  /**
   * 深拷贝权限配置（用于复制上级权限）
   */
  const deepCopyPermissions = (permissions) => {
    return permissions.map(perm => ({
      ...perm,
      lessons: (perm.lessons || []).map(lesson => ({ ...lesson }))
    }));
  };

  const renderModulePermissionSelector = (groupId, tagId, userId, permissions, inheritedPermissions) => {
    return (
      <Card size="small" style={{ marginTop: 12, background: '#fafafa' }}>
        <div style={{ marginBottom: 12 }}>
          <strong>模块与课程权限配置：</strong>
          <Space style={{ marginLeft: 8 }} size={4} wrap>
            <Tag color="cyan" style={{ fontSize: 11 }}>
              <ReadOutlined /> 查看课程
            </Tag>
            <Tag color="blue" style={{ fontSize: 11 }}>
              <FileTextOutlined /> 查看教案
            </Tag>
            <Tag color="purple" style={{ fontSize: 11 }}>
              <EditOutlined /> 编辑权限
            </Tag>
          </Space>
        </div>
        
        {allModules.length === 0 ? (
          <Empty description="暂无可授权的模块" image={Empty.PRESENTED_IMAGE_SIMPLE} />
        ) : (
          <Space direction="vertical" style={{ width: '100%' }} size="small">
            {allModules.map(module => {
              const perm = permissions.find(p => p.moduleId === module.id);
              const inherited = inheritedPermissions?.find(p => p.moduleId === module.id);
              
              const hasViewLesson = perm?.view_lesson || inherited?.view_lesson || false;
              const hasViewPlan = perm?.view_plan || inherited?.view_plan || false;
              const hasEdit = perm?.edit || inherited?.edit || false;
              const isInherited = !perm && inherited;
              const isExpanded = perm?.expanded || false;
              const lessons = moduleLessons[module.id] || [];
              const hasLessons = (module.lesson_count || 0) > 0;

              return (
                <div
                  key={module.id}
                  style={{
                    padding: '8px 12px',
                    background: 'white',
                    border: '1px solid #e8e8e8',
                    borderRadius: 4
                  }}
                >
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    width: '100%' 
                  }}>
                    <Space size="small">
                      {hasLessons && (
                        <Button
                          type="text"
                          size="small"
                          icon={isExpanded ? <CaretDownOutlined /> : <CaretRightOutlined />}
                          onClick={() => {
                            if (!isExpanded) {
                              handleLoadLessons(module.id);
                            }
                            handleToggleModuleExpand(groupId, tagId, userId, module.id);
                          }}
                          loading={loadingLessons[module.id]}
                        />
                      )}
                      <BookOutlined style={{ color: '#1890ff' }} />
                      <span>{module.name}</span>
                      {hasLessons && (
                        <Tag color="geekblue" style={{ fontSize: 11 }}>
                          {module.lesson_count}课
                        </Tag>
                      )}
                      {isInherited && (
                        <Tag color="blue" style={{ fontSize: 11 }}>
                          继承
                        </Tag>
                      )}
                    </Space>
                    <Space size="small">
                      <Tooltip title="学生权限 - 查看课程">
                        <Checkbox
                          checked={hasViewLesson}
                          disabled={isInherited || hasViewPlan || hasEdit}
                          onChange={() => handleToggleModulePermission(groupId, tagId, userId, module.id, null, 'view_lesson', hasViewLesson)}
                        >
                          <ReadOutlined /> 查看课程
                        </Checkbox>
                      </Tooltip>
                      <Tooltip title="教师权限 - 查看课程+教案">
                        <Checkbox
                          checked={hasViewPlan}
                          disabled={isInherited || hasEdit}
                          onChange={() => handleToggleModulePermission(groupId, tagId, userId, module.id, null, 'view_plan', hasViewPlan)}
                        >
                          <FileTextOutlined /> 查看教案
                        </Checkbox>
                      </Tooltip>
                      <Tooltip title="完全控制 - 查看课程+教案+编辑">
                        <Checkbox
                          checked={hasEdit}
                          disabled={isInherited}
                          onChange={() => handleToggleModulePermission(groupId, tagId, userId, module.id, null, 'edit', hasEdit)}
                        >
                          <EditOutlined /> 编辑
                        </Checkbox>
                      </Tooltip>
                    </Space>
                  </div>

                  {isExpanded && lessons.length > 0 && (
                    <div style={{ marginLeft: 32, marginTop: 8, paddingLeft: 12, borderLeft: '2px solid #e8e8e8' }}>
                      {lessons.map(lesson => {
                        const lessonPerm = perm?.lessons?.find(l => l.lessonId === lesson.id);
                        
                        let lessonHasViewLesson = false;
                        let lessonHasViewPlan = false;
                        let lessonHasEdit = false;
                        let lessonExplicitlyDenied = false;
                        
                        if (lessonPerm) {
                          if (lessonPerm.view_lesson === false) {
                            lessonHasViewLesson = false;
                            lessonExplicitlyDenied = true;
                          } else if (lessonPerm.view_lesson === true) {
                            lessonHasViewLesson = true;
                          }
                          
                          lessonHasViewPlan = lessonPerm.view_plan === true;
                          lessonHasEdit = lessonPerm.edit === true;
                        } else {
                          lessonHasViewLesson = perm?.view_lesson || inherited?.view_lesson || false;
                          lessonHasViewPlan = perm?.view_plan || inherited?.view_plan || false;
                          lessonHasEdit = perm?.edit || inherited?.edit || false;
                        }

                        return (
                          <div
                            key={lesson.id}
                            style={{
                              padding: '6px 10px',
                              background: lessonExplicitlyDenied ? '#fff2f0' : '#f9f9f9',
                              marginBottom: 6,
                              borderRadius: 3,
                              border: lessonExplicitlyDenied ? '1px solid #ffccc7' : '1px solid transparent'
                            }}
                          >
                            <div style={{ 
                              display: 'flex', 
                              justifyContent: 'space-between', 
                              alignItems: 'center',
                              width: '100%' 
                            }}>
                              <Space size="small">
                                <FileTextOutlined style={{ color: '#8c8c8c', fontSize: 12 }} />
                                <span style={{ fontSize: 13 }}>{lesson.title}</span>
                                {lessonPerm && !lessonExplicitlyDenied && (
                                  <Tag color="cyan" style={{ fontSize: 10 }}>
                                    独立配置
                                  </Tag>
                                )}
                                {lessonExplicitlyDenied && (
                                  <Tag color="red" style={{ fontSize: 10 }}>
                                    无权限
                                  </Tag>
                                )}
                                {!lessonPerm && (
                                  <Tag color="blue" style={{ fontSize: 10 }}>
                                    继承自模块
                                  </Tag>
                                )}
                              </Space>
                              <Space size="small">
                                <Checkbox
                                  checked={lessonHasViewLesson}
                                  disabled={lessonHasViewPlan || lessonHasEdit}
                                  onChange={() => handleToggleModulePermission(groupId, tagId, userId, module.id, lesson.id, 'view_lesson', lessonHasViewLesson)}
                                  style={{ fontSize: 12 }}
                                >
                                  <ReadOutlined style={{ fontSize: 11 }} /> 课程
                                </Checkbox>
                                <Checkbox
                                  checked={lessonHasViewPlan}
                                  disabled={lessonHasEdit}
                                  onChange={() => handleToggleModulePermission(groupId, tagId, userId, module.id, lesson.id, 'view_plan', lessonHasViewPlan)}
                                  style={{ fontSize: 12 }}
                                >
                                  <FileTextOutlined style={{ fontSize: 11 }} /> 教案
                                </Checkbox>
                                <Checkbox
                                  checked={lessonHasEdit}
                                  onChange={() => handleToggleModulePermission(groupId, tagId, userId, module.id, lesson.id, 'edit', lessonHasEdit)}
                                  style={{ fontSize: 12 }}
                                >
                                  <EditOutlined style={{ fontSize: 11 }} /> 编辑
                                </Checkbox>
                              </Space>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}
          </Space>
        )}
      </Card>
    );
  };

  const handleToggleModuleExpand = (groupId, tagId, userId, moduleId) => {
    setAuthorizedGroups(prev =>
      prev.map(group => {
        if (group.groupId !== groupId) return group;

        if (!tagId && !userId) {
          return {
            ...group,
            modulePermissions: group.modulePermissions.map(mp =>
              mp.moduleId === moduleId ? { ...mp, expanded: !mp.expanded } : mp
            )
          };
        }

        if (tagId && !userId) {
          return {
            ...group,
            tags: group.tags.map(tag =>
              tag.tagId === tagId
                ? {
                    ...tag,
                    modulePermissions: tag.modulePermissions.map(mp =>
                      mp.moduleId === moduleId ? { ...mp, expanded: !mp.expanded } : mp
                    )
                  }
                : tag
            )
          };
        }

        if (userId) {
          return {
            ...group,
            tags: group.tags.map(tag =>
              tag.tagId === tagId
                ? {
                    ...tag,
                    users: tag.users.map(user =>
                      user.userId === userId
                        ? {
                            ...user,
                            modulePermissions: user.modulePermissions.map(mp =>
                              mp.moduleId === moduleId ? { ...mp, expanded: !mp.expanded } : mp
                            )
                          }
                        : user
                    )
                  }
                : tag
            )
          };
        }

        return group;
      })
    );
  };

  const renderUserItem = (groupId, tagId, user, groupPermissions, tagPermissions) => {
    const userKey = `user-${groupId}-${tagId}-${user.userId}`;
    const inheritedPerms = user.inheritFromTag ? tagPermissions : null;

    return (
      <Card
        key={userKey}
        size="small"
        style={{ marginLeft: 60, marginBottom: 12, background: '#f0f0f0' }}
        title={
          <Space>
            <UserOutlined style={{ color: '#52c41a' }} />
            <span>{user.username}</span>
            {user.remark && <span style={{ color: '#999', fontSize: 12 }}>({user.remark})</span>}
          </Space>
        }
      >
        <div>
          <Space style={{ marginBottom: 12 }}>
            <Switch
              checked={user.inheritFromTag}
              onChange={(checked) => {
                setAuthorizedGroups(prev =>
                  prev.map(g =>
                    g.groupId === groupId
                      ? {
                          ...g,
                          tags: g.tags.map(t =>
                            t.tagId === tagId
                              ? {
                                  ...t,
                                  users: t.users.map(u =>
                                    u.userId === user.userId
                                      ? { 
                                          ...u, 
                                          inheritFromTag: checked,
                                          // 【核心修复】取消继承时复制标签权限
                                          modulePermissions: checked 
                                            ? [] 
                                            : deepCopyPermissions(t.inheritFromGroup ? groupPermissions : t.modulePermissions)
                                        }
                                      : u
                                  )
                                }
                              : t
                          )
                        }
                      : g
                  )
                );
                setHasUnsavedChanges(true);
                
                if (!checked) {
                  message.success('已将上级权限复制到用户配置，您现在可以独立修改');
                }
              }}
            />
            <span>继承上级权限</span>
            {!user.inheritFromTag && (
              <Tag color="orange" style={{ fontSize: 11 }}>
                独立配置
              </Tag>
            )}
          </Space>

          {!user.inheritFromTag && renderModulePermissionSelector(
            groupId,
            tagId,
            user.userId,
            user.modulePermissions || [],
            inheritedPerms
          )}
        </div>
      </Card>
    );
  };

  const renderGroupItem = (group) => {
    const header = (
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', width: '100%' }}>
        <Space>
          <TeamOutlined style={{ fontSize: 18, color: '#1890ff' }} />
          <strong style={{ fontSize: 15 }}>{group.groupName}</strong>
          <Badge count={group.userCount} showZero style={{ backgroundColor: '#52c41a' }} />
        </Space>
        <Button
          danger
          size="small"
          icon={<DeleteOutlined />}
          onClick={(e) => {
            e.stopPropagation();
            handleRemoveGroup(group.groupId);
          }}
        >
          移除授权
        </Button>
      </div>
    );

    return (
      <Panel
        header={header}
        key={`group-${group.groupId}`}
        style={{
          marginBottom: 16,
          background: 'white',
          borderRadius: 8,
          border: '1px solid #e8e8e8',
          boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
        }}
      >
        <div style={{ padding: '8px 0' }}>
          {renderModulePermissionSelector(
            group.groupId,
            null,
            null,
            group.modulePermissions || [],
            null
          )}

          <div style={{ marginTop: 16 }}>
            <Button
              type="dashed"
              icon={group.showTags ? <MinusOutlined /> : <PlusOutlined />}
              onClick={() => handleToggleTags(group.groupId)}
              block
            >
              {group.showTags ? '收起标签列表' : '展开标签列表'}
            </Button>
            
            {group.showTags && (
              <div>
                <Divider orientation="left">标签列表</Divider>
                {group.tags.length === 0 ? (
                  <Empty description="该组织暂无标签" image={Empty.PRESENTED_IMAGE_SIMPLE} />
                ) : (
                  <Space direction="vertical" style={{ width: '100%' }} size="middle">
                    {group.tags.map(tag => {
                      const tagUserKey = `${group.groupId}-${tag.tagId}`;
                      const pagination = userPagination[tagUserKey];

                      return (
                        <Card
                          key={tag.tagId}
                          size="small"
                          style={{ marginLeft: 40, background: '#f5f5f5' }}
                          title={
                            <Space>
                              <Tag color={tag.tagColor}>
                                <TagOutlined /> {tag.tagName}
                              </Tag>
                              <Badge count={tag.userCount} showZero />
                            </Space>
                          }
                        >
                          <div>
                            <Space style={{ marginBottom: 12 }}>
                              <Switch
                                checked={tag.inheritFromGroup}
                                onChange={(checked) => {
                                  setAuthorizedGroups(prev =>
                                    prev.map(g =>
                                      g.groupId === group.groupId
                                        ? {
                                            ...g,
                                            tags: g.tags.map(t =>
                                              t.tagId === tag.tagId
                                                ? { 
                                                    ...t, 
                                                    inheritFromGroup: checked,
                                                    // 【核心修复】取消继承时复制组权限
                                                    modulePermissions: checked 
                                                      ? [] 
                                                      : deepCopyPermissions(g.modulePermissions)
                                                  }
                                                : t
                                            )
                                          }
                                        : g
                                    )
                                  );
                                  setHasUnsavedChanges(true);
                                  
                                  if (!checked) {
                                    message.success('已将组权限复制到标签配置，您现在可以独立修改');
                                  }
                                }}
                              />
                              <span>继承"{group.groupName}"的权限</span>
                              {!tag.inheritFromGroup && (
                                <Tag color="orange" style={{ fontSize: 11 }}>
                                  独立配置
                                </Tag>
                              )}
                            </Space>

                            {!tag.inheritFromGroup && renderModulePermissionSelector(
                              group.groupId,
                              tag.tagId,
                              null,
                              tag.modulePermissions || [],
                              tag.inheritFromGroup ? group.modulePermissions : null
                            )}

                            <div style={{ marginTop: 16 }}>
                              <Button
                                type="dashed"
                                icon={tag.showUsers ? <MinusOutlined /> : <PlusOutlined />}
                                onClick={() => handleToggleUsers(group.groupId, tag.tagId)}
                                loading={loadingUsers[tagUserKey]}
                                block
                                size="small"
                              >
                                {tag.showUsers ? `收起用户列表 (${tag.userCount}人)` : `展开用户列表 (${tag.userCount}人)`}
                              </Button>
                              
                              {tag.showUsers && (
                                <div>
                                  <Divider orientation="left" style={{ fontSize: 13 }}>
                                    用户列表
                                  </Divider>
                                  
                                  {tag.users.length === 0 ? (
                                    <Empty description="该标签暂无用户" image={Empty.PRESENTED_IMAGE_SIMPLE} />
                                  ) : (
                                    <>
                                      {tag.users.map(user =>
                                        renderUserItem(
                                          group.groupId,
                                          tag.tagId,
                                          user,
                                          group.modulePermissions,
                                          tag.modulePermissions
                                        )
                                      )}

                                      {pagination && pagination.pages > 1 && (
                                        <div style={{ textAlign: 'center', marginTop: 16 }}>
                                          <Pagination
                                            current={pagination.page}
                                            total={pagination.total}
                                            pageSize={pagination.limit}
                                            onChange={(page) => handleLoadUsers(group.groupId, tag.tagId, page)}
                                            showSizeChanger={false}
                                            showTotal={(total) => `共 ${total} 位用户`}
                                            size="small"
                                          />
                                        </div>
                                      )}
                                    </>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        </Card>
                      );
                    })}
                  </Space>
                )}
              </div>
            )}
          </div>
        </div>
      </Panel>
    );
  };

  // ==================== 主渲染 ====================

  if (loading && authorizedGroups.length === 0) {
    return (
      <div style={{ textAlign: 'center', padding: 60 }}>
        <Spin size="large" tip="加载授权配置..." />
      </div>
    );
  }

  return (
    <div style={{ maxWidth: 1400, margin: '0 auto' }}>
      <Alert
        message="三级权限体系说明"
        description={
          <div>
            <Space direction="vertical" size={4}>
              <div>
                <Tag color="cyan"><ReadOutlined /> Level 1 - 查看课程</Tag>
                学生权限，仅能查看课程内容
              </div>
              <div>
                <Tag color="blue"><FileTextOutlined /> Level 2 - 查看教案</Tag>
                教师权限，可查看课程+教案
              </div>
              <div>
                <Tag color="purple"><EditOutlined /> Level 3 - 编辑权限</Tag>
                完全控制，可查看课程+教案+编辑
              </div>
              <Divider style={{ margin: '8px 0' }} />
              <div style={{ fontSize: 12, color: '#666' }}>
                💡 级联规则：授予高级权限自动授予下级，撤销低级权限自动撤销上级
              </div>
              <div style={{ fontSize: 12, color: '#666' }}>
                🔄 继承逻辑：取消继承时自动复制上级权限，保持权限连续性
              </div>
            </Space>
          </div>
        }
        type="info"
        showIcon
        closable
        style={{ marginBottom: 16 }}
      />

      <Card style={{ marginBottom: 16 }}>
        <Space style={{ width: '100%', justifyContent: 'space-between' }} wrap>
          <Space>
            <Button
              type="primary"
              icon={<PlusOutlined />}
              onClick={handleOpenGroupSelectModal}
            >
              新建授权
            </Button>
            <Button icon={<ReloadOutlined />} onClick={loadInitialData} loading={loading}>
              刷新
            </Button>
          </Space>
          <Space>
            {hasUnsavedChanges && (
              <Tag color="warning" icon={<ExclamationCircleOutlined />}>
                有未保存的更改
              </Tag>
            )}
            <Button onClick={handleReset} disabled={!hasUnsavedChanges}>
              重置
            </Button>
            <Button
              type="primary"
              icon={<SaveOutlined />}
              onClick={handleSaveAll}
              loading={loading}
              disabled={!hasUnsavedChanges}
            >
              保存所有更改
            </Button>
          </Space>
        </Space>
      </Card>

      {authorizedGroups.length === 0 ? (
        <Card>
          <Empty
            description={
              <div>
                <p>当前还未配置任何授权</p>
                <p style={{ color: '#999' }}>点击上方"新建授权"按钮开始添加授权</p>
              </div>
            }
          >
            <Button
              type="primary"
              icon={<PlusOutlined />}
              onClick={handleOpenGroupSelectModal}
            >
              新建授权
            </Button>
          </Empty>
        </Card>
      ) : (
        <Collapse
          expandIconPosition="right"
          style={{ background: 'transparent', border: 'none' }}
        >
          {authorizedGroups.map(group => renderGroupItem(group))}
        </Collapse>
      )}

      <Modal
        title="选择要授权的用户组"
        open={groupSelectModalVisible}
        onOk={handleAddGroups}
        onCancel={() => setGroupSelectModalVisible(false)}
        width={600}
        okText={`确认添加 (${selectedGroups.length})`}
        cancelText="取消"
      >
        <Search
          placeholder="搜索用户组..."
          style={{ marginBottom: 16 }}
          allowClear
        />
        
        <Checkbox.Group
          value={selectedGroups}
          onChange={setSelectedGroups}
          style={{ width: '100%' }}
        >
          <Space direction="vertical" style={{ width: '100%' }} size="middle">
            {allGroups.map(group => (
              <Card
                key={group.id}
                size="small"
                hoverable
                style={{ cursor: 'pointer' }}
              >
                <Checkbox value={group.id} style={{ width: '100%' }}>
                  <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                    <Space>
                      <TeamOutlined style={{ color: '#1890ff' }} />
                      <strong>{group.name}</strong>
                    </Space>
                    <Space>
                      <Tag>{group.user_count || 0} 人</Tag>
                    </Space>
                  </Space>
                </Checkbox>
              </Card>
            ))}
          </Space>
        </Checkbox.Group>

        {allGroups.length === 0 && (
          <Empty description="暂无用户组" image={Empty.PRESENTED_IMAGE_SIMPLE} />
        )}
      </Modal>
    </div>
  );
};

export default ModuleAuthorizationManagement;
