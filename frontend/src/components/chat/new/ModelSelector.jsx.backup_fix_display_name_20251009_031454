/**
 * 模型选择器组件（移动端优化版 - 修复弹出位置）
 * 用于在对话中快速切换AI模型
 */

import React, { useState, useRef, useEffect } from 'react'
import { Popover, Button, List, Typography } from 'antd'
import {
  ThunderboltOutlined,
  FileImageOutlined,
  CheckOutlined
} from '@ant-design/icons'
import './ModelSelector.less'

const { Text } = Typography

const ModelSelector = ({
  currentModel,
  availableModels = [],
  onModelChange,
  disabled = false,
  isMobile = false
}) => {
  const [visible, setVisible] = useState(false)
  const popoverRef = useRef(null)

  // 点击外部关闭
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (popoverRef.current && !popoverRef.current.contains(event.target)) {
        setVisible(false)
      }
    }

    if (visible) {
      document.addEventListener('mousedown', handleClickOutside)
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [visible])

  // 处理模型选择
  const handleModelSelect = (model) => {
    if (model.name !== currentModel?.name) {
      onModelChange(model)
    }
    setVisible(false)
  }

  // 获取简短的模型名称（移动端使用）
  const getShortModelName = (modelName) => {
    if (!modelName) return '选择模型'
    // 移除常见前缀和简化名称
    return modelName
      .replace('claude-', '')
      .replace('gpt-', '')
      .replace('gemini-', '')
      .split('-')[0] // 只取第一段
  }

  // 模型列表内容
  const modelListContent = (
    <div className="model-selector-list" ref={popoverRef}>
      <List
        dataSource={availableModels}
        renderItem={(model) => {
          const isSelected = model.name === currentModel?.name
          return (
            <List.Item
              className={`model-item ${isSelected ? 'selected' : ''}`}
              onClick={() => handleModelSelect(model)}
            >
              <div className="model-info">
                <div className="model-name-row">
                  <Text strong={isSelected}>
                    {model.display_name || model.name}
                  </Text>
                  {isSelected && <CheckOutlined className="selected-icon" />}
                </div>
                <div className="model-features">
                  <span className="credits-info">
                    <ThunderboltOutlined className="credits-icon" />
                    <span className="credits-number">{model.credits_per_chat}</span>
                  </span>
                  {model.image_upload_enabled && (
                    <FileImageOutlined className="image-icon" />
                  )}
                </div>
              </div>
            </List.Item>
          )
        }}
      />
    </div>
  )

  return (
    <Popover
      content={modelListContent}
      trigger="click"
      visible={visible}
      onVisibleChange={setVisible}
      // 移动端向上居中弹出，PC端向左上弹出
      placement={isMobile ? 'top' : 'topLeft'}
      // 移动端挂载到body，避免被父容器裁剪
      getPopupContainer={isMobile ? undefined : (trigger) => trigger.parentElement}
      overlayClassName={`model-selector-popover ${isMobile ? 'mobile' : ''}`}
      // 允许自动调整位置，避免超出视口
      autoAdjustOverflow={true}
      // 移动端增加偏移，避免遮挡按钮
      align={isMobile ? { offset: [0, -8] } : undefined}
    >
      <Button
        className={`model-selector-button ${isMobile ? 'mobile' : ''}`}
        disabled={disabled}
      >
        <span className="model-name">
          {isMobile 
            ? getShortModelName(currentModel?.name)
            : (currentModel?.display_name || currentModel?.name || '选择模型')
          }
        </span>
        <span className="credits-display">
          <ThunderboltOutlined className="credits-icon" />
          <span className="credits-number">{currentModel?.credits_per_chat || 0}</span>
        </span>
      </Button>
    </Popover>
  )
}

export default ModelSelector
