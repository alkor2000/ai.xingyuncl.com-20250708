/**
 * 系统配置Store
 * 管理站点名称、Logo等全局配置
 */

import { create } from 'zustand'
import apiClient from '../utils/api'

const useSystemConfigStore = create((set, get) => ({
  // 系统配置
  systemConfig: {
    site: {
      name: 'AI Platform',
      description: '企业级AI应用聚合平台',
      logo: '',
      favicon: ''
    },
    user: {
      allow_register: true,
      default_token_quota: 10000,
      default_group_id: 1,
      default_credits_quota: 1000
    },
    ai: {
      default_model: 'gpt-4.1-mini-op',
      temperature: 0.0
    },
    credits: {
      default_credits: 1000,
      max_credits: 100000,
      min_credits_for_chat: 1
    }
  },
  
  loading: false,
  initialized: false,
  
  // 初始化系统配置
  initSystemConfig: async () => {
    const state = get()
    if (state.initialized) return
    
    try {
      set({ loading: true })
      const response = await apiClient.get('/admin/settings')
      
      if (response.data.success && response.data.data) {
        set({ 
          systemConfig: response.data.data,
          initialized: true,
          loading: false
        })
      }
    } catch (error) {
      console.error('初始化系统配置失败:', error)
      set({ loading: false })
    }
  },
  
  // 更新系统配置
  updateSystemConfig: async (config) => {
    try {
      const response = await apiClient.put('/admin/settings', config)
      
      if (response.data.success) {
        set({ systemConfig: config })
        return { success: true }
      }
      
      return { success: false, error: response.data.message }
    } catch (error) {
      console.error('更新系统配置失败:', error)
      return { success: false, error: error.message }
    }
  },
  
  // 上传站点Logo
  uploadSiteLogo: async (file) => {
    try {
      const formData = new FormData()
      formData.append('logo', file)
      
      const response = await apiClient.post('/admin/settings/upload-logo', formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      })
      
      if (response.data.success) {
        // 更新本地配置
        const state = get()
        const newConfig = {
          ...state.systemConfig,
          site: {
            ...state.systemConfig.site,
            logo: response.data.data.url
          }
        }
        set({ systemConfig: newConfig })
        
        return { success: true, url: response.data.data.url }
      }
      
      return { success: false, error: response.data.message }
    } catch (error) {
      console.error('上传Logo失败:', error)
      return { success: false, error: error.message }
    }
  },
  
  // 获取站点名称
  getSiteName: () => {
    const state = get()
    return state.systemConfig?.site?.name || 'AI Platform'
  },
  
  // 获取站点Logo
  getSiteLogo: () => {
    const state = get()
    return state.systemConfig?.site?.logo || ''
  },
  
  // 获取站点描述
  getSiteDescription: () => {
    const state = get()
    return state.systemConfig?.site?.description || '企业级AI应用聚合平台'
  },
  
  // 获取默认AI模型
  getDefaultAIModel: () => {
    const state = get()
    return state.systemConfig?.ai?.default_model || 'gpt-4.1-mini-op'
  },
  
  // 获取默认Temperature
  getDefaultTemperature: () => {
    const state = get()
    const temperature = state.systemConfig?.ai?.temperature
    // 确保返回数字类型
    if (temperature !== undefined && temperature !== null) {
      return parseFloat(temperature)
    }
    return 0.0
  },
  
  // 获取默认Token配额
  getDefaultTokenQuota: () => {
    const state = get()
    return state.systemConfig?.user?.default_token_quota || 10000
  },
  
  // 获取默认积分配额
  getDefaultCreditsQuota: () => {
    const state = get()
    // 优先使用credits配置中的default_credits
    if (state.systemConfig?.credits?.default_credits) {
      return state.systemConfig.credits.default_credits
    }
    return state.systemConfig?.user?.default_credits_quota || 1000
  },
  
  // 获取AI相关配置
  getAIConfig: () => {
    const state = get()
    return {
      defaultModel: state.systemConfig?.ai?.default_model || 'gpt-4.1-mini-op',
      defaultTemperature: parseFloat(state.systemConfig?.ai?.temperature) || 0.0
    }
  }
}))

export default useSystemConfigStore
