/**
 * AI模型管理控制器 - 支持基于角色的数据过滤
 */

const AIModel = require('../../models/AIModel');
const dbConnection = require('../../database/connection');
const ResponseHelper = require('../../utils/response');
const logger = require('../../utils/logger');
const { ROLES } = require('../../middleware/permissions');

class AIModelController {
  /**
   * 获取AI模型列表 - 根据用户角色过滤敏感信息
   */
  static async getAIModels(req, res) {
    try {
      const userRole = req.user.role;
      
      const sql = `
        SELECT *, 
        (SELECT COUNT(*) FROM conversations WHERE model_name = ai_models.name) as usage_count
        FROM ai_models 
        ORDER BY sort_order ASC, created_at ASC
      `;
      
      const { rows } = await dbConnection.query(sql);
      
      const models = rows.map(row => {
        const model = new AIModel(row);
        if (typeof model.model_config === 'string') {
          try {
            model.model_config = JSON.parse(model.model_config);
          } catch (e) {
            model.model_config = {};
          }
        }
        
        // 根据用户角色过滤敏感信息
        if (userRole === ROLES.ADMIN) {
          // 组管理员：隐藏敏感信息
          const filteredModel = {
            id: model.id,
            name: '******', // 隐藏真实模型名
            display_name: model.display_name,
            provider: model.provider,
            api_key: null, // 不返回API密钥
            api_endpoint: null, // 不返回API端点
            model_config: {}, // 不返回配置
            credits_per_chat: model.credits_per_chat,
            stream_enabled: model.stream_enabled,
            image_upload_enabled: model.image_upload_enabled,
            is_active: model.is_active,
            sort_order: model.sort_order,
            test_status: model.test_status,
            last_tested_at: model.last_tested_at,
            usage_count: model.usage_count,
            created_at: model.created_at,
            updated_at: model.updated_at
          };
          return filteredModel;
        }
        
        // 超级管理员：返回完整信息
        return model;
      });

      logger.info('获取AI模型列表成功', { 
        adminId: req.user.id,
        userRole: userRole,
        modelCount: models.length
      });

      return ResponseHelper.success(res, models, '获取AI模型列表成功');
    } catch (error) {
      logger.error('获取AI模型列表失败', { 
        adminId: req.user?.id, 
        error: error.message 
      });
      return ResponseHelper.error(res, '获取AI模型列表失败');
    }
  }

  /**
   * 创建AI模型 - 只有超级管理员可以操作
   */
  static async createAIModel(req, res) {
    try {
      const modelData = req.body;
      const model = await AIModel.create(modelData);

      logger.info('创建AI模型成功', { 
        adminId: req.user.id,
        modelId: model.id,
        modelName: model.name
      });

      return ResponseHelper.success(res, model.toJSON(), 'AI模型创建成功', 201);
    } catch (error) {
      logger.error('创建AI模型失败', { 
        adminId: req.user?.id, 
        error: error.message 
      });
      return ResponseHelper.error(res, '创建AI模型失败');
    }
  }

  /**
   * 更新AI模型 - 只有超级管理员可以操作
   */
  static async updateAIModel(req, res) {
    try {
      const { id } = req.params;
      const updateData = req.body;

      const model = await AIModel.findById(id);
      if (!model) {
        return ResponseHelper.notFound(res, 'AI模型不存在');
      }

      await model.update(updateData);
      
      const updatedModel = await AIModel.findById(id);
      if (!updatedModel) {
        logger.error('更新后重新获取模型失败', { modelId: id });
        return ResponseHelper.error(res, '更新后获取模型数据失败');
      }

      logger.info('更新AI模型成功', { 
        adminId: req.user.id,
        modelId: id,
        updateFields: Object.keys(updateData),
        streamEnabled: updatedModel.stream_enabled
      });

      return ResponseHelper.success(res, updatedModel.toJSON(), 'AI模型更新成功');
    } catch (error) {
      logger.error('更新AI模型失败', { 
        adminId: req.user?.id, 
        modelId: req.params.id,
        error: error.message 
      });
      return ResponseHelper.error(res, '更新AI模型失败');
    }
  }

  /**
   * 删除AI模型 - 只有超级管理员可以操作
   */
  static async deleteAIModel(req, res) {
    try {
      const { id } = req.params;

      const model = await AIModel.findById(id);
      if (!model) {
        return ResponseHelper.notFound(res, 'AI模型不存在');
      }

      await model.delete();

      logger.info('删除AI模型成功', { 
        adminId: req.user.id,
        deletedModelId: id,
        deletedModelName: model.name
      });

      return ResponseHelper.success(res, null, 'AI模型删除成功');
    } catch (error) {
      logger.error('删除AI模型失败', { 
        adminId: req.user?.id, 
        modelId: req.params.id,
        error: error.message 
      });
      return ResponseHelper.error(res, '删除AI模型失败');
    }
  }

  /**
   * 测试AI模型连通性 - 超级管理员和组管理员都可以操作
   */
  static async testAIModel(req, res) {
    try {
      const { id } = req.params;
      const userRole = req.user.role;

      const model = await AIModel.findById(id);
      if (!model) {
        return ResponseHelper.notFound(res, 'AI模型不存在');
      }

      // 组管理员不能测试连通性（因为看不到API密钥）
      if (userRole === ROLES.ADMIN) {
        return ResponseHelper.success(res, {
          success: true,
          message: '组管理员无法执行连通性测试'
        }, '操作完成');
      }

      const testResult = await model.testConnection();

      logger.info('AI模型连通性测试完成', { 
        adminId: req.user.id,
        modelId: id,
        testSuccess: testResult.success
      });

      return ResponseHelper.success(res, testResult, '连通性测试完成');
    } catch (error) {
      logger.error('AI模型连通性测试失败', { 
        adminId: req.user?.id, 
        modelId: req.params.id,
        error: error.message 
      });
      return ResponseHelper.error(res, '连通性测试失败');
    }
  }
}

module.exports = AIModelController;
