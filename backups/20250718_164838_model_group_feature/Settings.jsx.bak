/**
 * ç³»ç»Ÿè®¾ç½®ä¸»é¡µé¢ - æ”¯æŒç»„ç®¡ç†å‘˜æƒé™æ§åˆ¶
 */

import React, { useEffect, useState } from 'react'
import { Card, Button, Tabs, Form, message, Space, Tag, Alert } from 'antd'
import {
  BarChartOutlined,
  RobotOutlined,
  SettingOutlined,
  PlusOutlined,
  AppstoreOutlined,
  ThunderboltOutlined,
  FileImageOutlined,
  LockOutlined
} from '@ant-design/icons'
import { useTranslation } from 'react-i18next'
import useAdminStore from '../../stores/adminStore'
import useAuthStore from '../../stores/authStore'
import { ROLES, hasPermission } from '../../utils/permissions'

// å¯¼å…¥å­ç»„ä»¶
import {
  SystemStats,
  AIModelTable,
  AIModelFormModal,
  SystemModuleTable,
  SystemModuleFormModal,
  BasicSettings
} from '../../components/admin/settings'

const { TabPane } = Tabs

const Settings = () => {
  const { t } = useTranslation()
  const { user, hasRole } = useAuthStore()
  const {
    aiModels,
    modules,
    systemStats,
    systemSettings,
    loading,
    getAIModels,
    createAIModel,
    updateAIModel,
    deleteAIModel,
    testAIModel,
    getModules,
    createModule,
    updateModule,
    deleteModule,
    checkModuleHealth,
    getSystemStats,
    getSystemSettings,
    updateSystemSettings
  } = useAdminStore()

  // è¡¨å•å®ä¾‹
  const [settingsForm] = Form.useForm()
  const [modelForm] = Form.useForm()
  const [moduleForm] = Form.useForm()
  
  // çŠ¶æ€ç®¡ç†
  const [isModelModalVisible, setIsModelModalVisible] = useState(false)
  const [isModuleModalVisible, setIsModuleModalVisible] = useState(false)
  const [editingModel, setEditingModel] = useState(null)
  const [editingModule, setEditingModule] = useState(null)
  const [testingModelId, setTestingModelId] = useState(null)
  const [checkingModuleId, setCheckingModuleId] = useState(null)

  const userRole = user?.role || ROLES.USER
  const isSuperAdmin = userRole === ROLES.SUPER_ADMIN
  const isGroupAdmin = userRole === ROLES.ADMIN
  const canViewSettings = isSuperAdmin || isGroupAdmin

  // åˆå§‹åŒ–åŠ è½½æ•°æ®
  useEffect(() => {
    if (canViewSettings) {
      getSystemStats()
      getAIModels()
      if (isSuperAdmin) {
        getModules()
      }
      getSystemSettings()
    }
  }, [canViewSettings, isSuperAdmin])

  // è®¾ç½®è¡¨å•åˆå§‹å€¼
  useEffect(() => {
    if (systemSettings && Object.keys(systemSettings).length > 0) {
      settingsForm.setFieldsValue(systemSettings)
    }
  }, [systemSettings, settingsForm])

  // è®¾ç½®é»˜è®¤æ¨¡å‹
  useEffect(() => {
    if (aiModels.length > 0 && systemSettings?.ai && !systemSettings.ai.default_model) {
      const firstActiveModel = aiModels.find(m => m.is_active)
      if (firstActiveModel) {
        settingsForm.setFieldValue(['ai', 'default_model'], firstActiveModel.name)
      }
    }
  }, [aiModels, systemSettings, settingsForm])

  // ä¿å­˜ç³»ç»Ÿè®¾ç½®ï¼ˆåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ï¼‰
  const handleSaveSettings = async (values) => {
    if (!isSuperAdmin) {
      message.warning(t('admin.noPermission'))
      return
    }
    
    try {
      await updateSystemSettings(values)
      message.success(t('admin.settings.save.success'))
    } catch (error) {
      message.error(t('admin.settings.save.failed'))
    }
  }

  // AIæ¨¡å‹ç›¸å…³æ–¹æ³•ï¼ˆåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ›å»º/æ›´æ–°/åˆ é™¤ï¼‰
  const handleCreateModel = async (values) => {
    if (!isSuperAdmin) {
      message.warning(t('admin.noPermission'))
      return
    }
    
    try {
      await createAIModel(values)
      setIsModelModalVisible(false)
      modelForm.resetFields()
      message.success(t('admin.models.create.success'))
    } catch (error) {
      message.error(error.response?.data?.message || t('admin.models.create.failed'))
    }
  }

  const handleUpdateModel = async (values) => {
    if (!isSuperAdmin) {
      message.warning(t('admin.noPermission'))
      return
    }
    
    try {
      await updateAIModel(editingModel.id, values)
      setIsModelModalVisible(false)
      setEditingModel(null)
      modelForm.resetFields()
      message.success(t('admin.models.update.success'))
    } catch (error) {
      message.error(error.response?.data?.message || t('admin.models.update.failed'))
    }
  }

  const handleDeleteModel = async (modelId) => {
    if (!isSuperAdmin) {
      message.warning(t('admin.noPermission'))
      return
    }
    
    try {
      await deleteAIModel(modelId)
      message.success(t('admin.models.delete.success'))
    } catch (error) {
      message.error(error.response?.data?.message || t('admin.models.delete.failed'))
    }
  }

  const handleTestModel = async (modelId) => {
    setTestingModelId(modelId)
    try {
      const result = await testAIModel(modelId)
      if (result.success && result.data) {
        if (result.data.success) {
          message.success(t('admin.models.test.success'))
        } else {
          message.warning(t('admin.models.test.failed', { message: result.data.message }))
        }
        await getAIModels()
      } else {
        message.error(result.message || t('admin.models.test.error'))
      }
    } catch (error) {
      console.error('æµ‹è¯•å¤±è´¥:', error)
      message.error(error.message || t('admin.models.test.error'))
    } finally {
      setTestingModelId(null)
    }
  }

  const handleEditModel = (model) => {
    if (!isSuperAdmin) {
      message.warning(t('admin.noPermission'))
      return
    }
    
    setEditingModel(model)
    modelForm.setFieldsValue({
      name: model.name,
      display_name: model.display_name,
      api_key: '',
      api_endpoint: '',
      stream_enabled: model.stream_enabled !== undefined ? model.stream_enabled : true,
      image_upload_enabled: model.image_upload_enabled !== undefined ? model.image_upload_enabled : false,
      credits_per_chat: model.credits_per_chat,
      is_active: model.is_active,
      sort_order: model.sort_order
    })
    setIsModelModalVisible(true)
  }

  const handleToggleStreamEnabled = async (modelId, streamEnabled) => {
    if (!isSuperAdmin) {
      message.warning(t('admin.noPermission'))
      return
    }
    
    try {
      await updateAIModel(modelId, { stream_enabled: streamEnabled })
      message.success(streamEnabled ? 'æµå¼è¾“å‡ºå·²å¯ç”¨' : 'æµå¼è¾“å‡ºå·²ç¦ç”¨')
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥')
    }
  }

  const handleToggleImageUploadEnabled = async (modelId, imageUploadEnabled) => {
    if (!isSuperAdmin) {
      message.warning(t('admin.noPermission'))
      return
    }
    
    try {
      await updateAIModel(modelId, { image_upload_enabled: imageUploadEnabled })
      message.success(imageUploadEnabled ? 'å›¾ç‰‡ä¸Šä¼ å·²å¯ç”¨' : 'å›¾ç‰‡ä¸Šä¼ å·²ç¦ç”¨')
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥')
    }
  }

  // ç³»ç»Ÿæ¨¡å—ç›¸å…³æ–¹æ³•ï¼ˆåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ï¼‰
  const handleCreateModule = async (values) => {
    try {
      await createModule(values)
      setIsModuleModalVisible(false)
      moduleForm.resetFields()
      message.success('ç³»ç»Ÿæ¨¡å—åˆ›å»ºæˆåŠŸ')
    } catch (error) {
      message.error(error.response?.data?.message || 'ç³»ç»Ÿæ¨¡å—åˆ›å»ºå¤±è´¥')
    }
  }

  const handleUpdateModule = async (values) => {
    try {
      await updateModule(editingModule.id, values)
      setIsModuleModalVisible(false)
      setEditingModule(null)
      moduleForm.resetFields()
      message.success('ç³»ç»Ÿæ¨¡å—æ›´æ–°æˆåŠŸ')
    } catch (error) {
      message.error(error.response?.data?.message || 'ç³»ç»Ÿæ¨¡å—æ›´æ–°å¤±è´¥')
    }
  }

  const handleDeleteModule = async (moduleId) => {
    try {
      await deleteModule(moduleId)
      message.success('ç³»ç»Ÿæ¨¡å—åˆ é™¤æˆåŠŸ')
    } catch (error) {
      message.error(error.response?.data?.message || 'ç³»ç»Ÿæ¨¡å—åˆ é™¤å¤±è´¥')
    }
  }

  const handleEditModule = (module) => {
    setEditingModule(module)
    moduleForm.setFieldsValue({
      name: module.name,
      display_name: module.display_name,
      description: module.description,
      module_type: module.module_type,
      api_endpoint: module.api_endpoint,
      frontend_url: module.frontend_url,
      proxy_path: module.proxy_path,
      auth_mode: module.auth_mode,
      is_active: module.is_active,
      permissions: module.permissions || [],
      config: module.config || {},
      health_check_url: module.health_check_url
    })
    setIsModuleModalVisible(true)
  }

  const handleCheckModuleHealth = async (moduleId) => {
    setCheckingModuleId(moduleId)
    try {
      const result = await checkModuleHealth(moduleId)
      if (result.success) {
        message.success(`å¥åº·æ£€æŸ¥å®Œæˆï¼š${result.data.message}`)
      } else {
        message.warning('å¥åº·æ£€æŸ¥å¤±è´¥')
      }
    } catch (error) {
      message.error('å¥åº·æ£€æŸ¥å‡ºé”™')
    } finally {
      setCheckingModuleId(null)
    }
  }

  const handleToggleModuleStatus = async (moduleId, isActive) => {
    try {
      await updateModule(moduleId, { is_active: isActive })
      message.success(isActive ? 'æ¨¡å—å·²å¯ç”¨' : 'æ¨¡å—å·²ç¦ç”¨')
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥')
    }
  }

  // æƒé™æ£€æŸ¥ - ä½¿ç”¨è§’è‰²åˆ¤æ–­è€Œä¸æ˜¯æƒé™
  if (!canViewSettings) {
    return (
      <div className="page-container">
        <Card>
          <div style={{ textAlign: 'center', padding: '50px 0' }}>
            <p>{t('admin.noPermission')}</p>
          </div>
        </Card>
      </div>
    )
  }
  
  return (
    <div className="page-container">
      {/* ç»„ç®¡ç†å‘˜æç¤º */}
      {isGroupAdmin && (
        <Alert
          message={t('admin.groupAdminTip')}
          description={t('admin.groupAdminDescription')}
          type="info"
          showIcon
          icon={<LockOutlined />}
          style={{ marginBottom: 16 }}
        />
      )}
      
      <Tabs defaultActiveKey="statistics" type="card">
        {/* ç³»ç»Ÿç»Ÿè®¡ */}
        <TabPane 
          tab={
            <span>
              <BarChartOutlined />
              {t('admin.settings.tabs.statistics')}
            </span>
          } 
          key="statistics"
        >
          <SystemStats systemStats={systemStats} />
        </TabPane>

        {/* AIæ¨¡å‹ç®¡ç† */}
        <TabPane 
          tab={
            <span>
              <RobotOutlined />
              {t('admin.settings.tabs.models')}
            </span>
          } 
          key="models"
        >
          <Card 
            title={
              <Space>
                <RobotOutlined />
                <span>{t('admin.models.config')}</span>
                <Tag color="blue">ğŸ’° {t('admin.models.creditsSystem')}</Tag>
                <Tag color="processing" icon={<ThunderboltOutlined />}>
                  ğŸš€ {t('admin.models.streamOutput')}
                </Tag>
                <Tag color="success" icon={<FileImageOutlined />}>
                  ğŸ–¼ï¸ {t('admin.models.imageUpload')}
                </Tag>
                <Tag color="green">ğŸ”“ {t('admin.models.noOutputLimit')}</Tag>
              </Space>
            }
            extra={
              isSuperAdmin && (
                <Button 
                  type="primary" 
                  icon={<PlusOutlined />}
                  onClick={() => {
                    setEditingModel(null)
                    modelForm.resetFields()
                    setIsModelModalVisible(true)
                  }}
                >
                  {t('admin.models.addModel')}
                </Button>
              )
            }
          >
            <AIModelTable
              models={aiModels}
              loading={loading}
              testingModelId={testingModelId}
              onTest={handleTestModel}
              onEdit={handleEditModel}
              onDelete={handleDeleteModel}
              onToggleStreamEnabled={handleToggleStreamEnabled}
              onToggleImageUploadEnabled={handleToggleImageUploadEnabled}
            />
          </Card>
        </TabPane>

        {/* æ¨¡å—æ¥å…¥ï¼ˆåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰ */}
        {isSuperAdmin && (
          <TabPane 
            tab={
              <span>
                <AppstoreOutlined />
                {t('admin.settings.tabs.modules')}
              </span>
            } 
            key="modules"
          >
            <Card
              title={t('admin.modules.title')}
              extra={
                <Button
                  type="primary"
                  icon={<PlusOutlined />}
                  onClick={() => {
                    setEditingModule(null)
                    moduleForm.resetFields()
                    setIsModuleModalVisible(true)
                  }}
                >
                  {t('admin.modules.addModule')}
                </Button>
              }
            >
              <SystemModuleTable
                modules={modules}
                loading={loading}
                checkingModuleId={checkingModuleId}
                onCheckHealth={handleCheckModuleHealth}
                onToggleStatus={handleToggleModuleStatus}
                onEdit={handleEditModule}
                onDelete={handleDeleteModule}
              />
            </Card>
          </TabPane>
        )}

        {/* åŸºç¡€è®¾ç½® */}
        <TabPane 
          tab={
            <span>
              <SettingOutlined />
              {t('admin.settings.tabs.basic')}
            </span>
          } 
          key="settings"
        >
          <BasicSettings
            form={settingsForm}
            aiModels={aiModels}
            loading={loading}
            onSubmit={handleSaveSettings}
            disabled={!isSuperAdmin}
          />
        </TabPane>
      </Tabs>

      {/* AIæ¨¡å‹å¼¹çª—ï¼ˆåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨ï¼‰ */}
      {isSuperAdmin && (
        <AIModelFormModal
          visible={isModelModalVisible}
          editingModel={editingModel}
          form={modelForm}
          loading={loading}
          onSubmit={editingModel ? handleUpdateModel : handleCreateModel}
          onCancel={() => {
            setIsModelModalVisible(false)
            setEditingModel(null)
            modelForm.resetFields()
          }}
        />
      )}

      {/* ç³»ç»Ÿæ¨¡å—å¼¹çª—ï¼ˆåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨ï¼‰ */}
      {isSuperAdmin && (
        <SystemModuleFormModal
          visible={isModuleModalVisible}
          editingModule={editingModule}
          form={moduleForm}
          loading={loading}
          onSubmit={editingModule ? handleUpdateModule : handleCreateModule}
          onCancel={() => {
            setIsModuleModalVisible(false)
            setEditingModule(null)
            moduleForm.resetFields()
          }}
        />
      )}
    </div>
  )
}

export default Settings
